<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ©Ÿæ™ºçš„é¹¹é­šç”Ÿæ´» | Wise Salted Fish Life</title>
    <meta name="description" content="ä¸€å€‹çµ¦åŸºç£å¾’çš„è¼•é¬†éˆä¿®èˆ‡ç”Ÿæ´»å°å·¥å…·ï¼Œæ‹’çµ•å±¬éˆç„¦æ…®ï¼Œå¿«æ¨‚åšé¹¹é­šã€‚">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'm-brown': '#A68C76',
                        'm-brown-light': '#F2EBE5',
                        'm-green': '#8DA399',
                        'm-blue': '#8F9EAC',
                        'm-rose': '#C8A8A4',
                        'text-main': '#5E5A54',
                        'bg-cream': '#FDFCF8'
                    }
                }
            },
            corePlugins: {
                preflight: true, 
            }
        }
    </script>

    <!-- PWA / Icons -->
    <link rel="icon" id="favicon-link" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3Crect width='200' height='200' rx='40' fill='%237CA1B3'/%3E%3Cellipse cx='100' cy='50' rx='60' ry='10' fill='none' stroke='%23D4B483' stroke-width='6'/%3E%3Cpath d='M100 80 C 150 80, 180 110, 180 130 C 180 150, 150 170, 100 170 C 50 170, 20 150, 20 130 C 20 110, 50 80, 100 80 Z' fill='%23FFFFFF'/%3E%3Cpath d='M180 130 L 200 110 L 200 150 Z' fill='%23FFFFFF'/%3E%3Cellipse cx='60' cy='135' rx='10' ry='6' fill='%23FFAB91' opacity='0.8'/%3E%3Cellipse cx='140' cy='135' rx='10' ry='6' fill='%23FFAB91' opacity='0.8'/%3E%3Cg stroke='%237CA1B3' stroke-width='5' stroke-linecap='round'%3E%3Cline x1='75' y1='112' x2='75' y2='128'/%3E%3Cline x1='69' y1='118' x2='81' y2='118'/%3E%3Cline x1='125' y1='112' x2='125' y2='128'/%3E%3Cline x1='119' y1='118' x2='131' y2='118'/%3E%3C/g%3E%3Cline x1='95' y1='145' x2='105' y2='145' stroke='%237CA1B3' stroke-width='5' stroke-linecap='round'/%3E%3C/svg%3E" type="image/svg+xml">
    <link rel="apple-touch-icon" id="apple-icon-link" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3Crect width='200' height='200' fill='%237CA1B3'/%3E%3Cellipse cx='100' cy='50' rx='60' ry='10' fill='none' stroke='%23D4B483' stroke-width='6'/%3E%3Cpath d='M100 80 C 150 80, 180 110, 180 130 C 180 150, 150 170, 100 170 C 50 170, 20 150, 20 130 C 20 110, 50 80, 100 80 Z' fill='%23FFFFFF'/%3E%3Cpath d='M180 130 L 200 110 L 200 150 Z' fill='%23FFFFFF'/%3E%3Cellipse cx='60' cy='135' rx='10' ry='6' fill='%23FFAB91' opacity='0.8'/%3E%3Cellipse cx='140' cy='135' rx='10' ry='6' fill='%23FFAB91' opacity='0.8'/%3E%3Cg stroke='%237CA1B3' stroke-width='5' stroke-linecap='round'%3E%3Cline x1='75' y1='112' x2='75' y2='128'/%3E%3Cline x1='69' y1='118' x2='81' y2='118'/%3E%3Cline x1='125' y1='112' x2='125' y2='128'/%3E%3Cline x1='119' y1='118' x2='131' y2='118'/%3E%3C/g%3E%3Cline x1='95' y1='145' x2='105' y2='145' stroke='%237CA1B3' stroke-width='5' stroke-linecap='round'/%3E%3C/svg%3E">
    <link rel="manifest" href="manifest.json" id="manifest-placeholder">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#FDFCF8">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@300;400;600;700&family=Noto+Sans+TC:wght@300;400;500&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    
    <style>
        :root {
            --bg-color: #FDFCF8;
            --card-bg: #FFFFFF;
            --text-primary: #5A524C;
            --text-secondary: #9E9791;
            --accent-blue: #7CA1B3;
            --accent-blue-light: #E8F1F5; 
            --accent-gold: #D4B483;
            --accent-warning: #D98E73;
            --accent-green: #8FB3A3;
            --accent-purple: #B5A3BE;
            --accent-purple-light: #F3EAF5;
            --border-color: #F0EAE4;
            --shadow-soft: 0 10px 40px -10px rgba(90, 82, 76, 0.08);
            --radius-main: 24px;
            --radius-btn: 12px;
            --morandi-green: #8DA399;
            --morandi-pink: #D4A5A5;
            --morandi-bg-gray: #F7F7F7;
            --savings-saved-bg: #5A7D8F; 
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        h1, h2, h3, h4, h5, h6 { font-size: revert; font-weight: revert; }
        button { background-color: transparent; }

        html, body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            line-height: 1.7;
            height: 100vh; height: 100dvh; width: 100vw;
            overflow: hidden;
            margin: 0; padding: 0;
            display: flex; flex-direction: column;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%235a524c' fill-opacity='0.03'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z'/%3E%3C/g%3E%3C/svg%3E");
        }

        #scroll-wrapper { 
            flex: 1; 
            overflow-y: auto; 
            overflow-x: hidden; 
            -webkit-overflow-scrolling: touch; 
            width: 100%; 
            height: 100%; 
            position: relative; 
            scroll-behavior: smooth; 
            padding-bottom: 100px; 
        }

        header { text-align: center; padding: 50px 20px 30px; }
        .main-title { font-family: 'Noto Serif TC', serif; font-size: 2rem; font-weight: 700; color: var(--text-primary); letter-spacing: 0.05em; margin-bottom: 6px; }
        .subtitle { font-family: 'Noto Sans TC', sans-serif; font-size: 0.85rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.2em; }
        
        main.container-limited { padding: 0 20px; max-width: 500px; margin: 0 auto; width: 100%; display: flex; flex-direction: column; }
        main.container-full { width: 100%; height: 100%; padding: 0; overflow: hidden; display: flex; flex-direction: column; }

        @media (max-width: 1024px) {
            main.container-full {
                overflow-y: auto;
                height: auto;
                min-height: 100%;
                display: block;
                padding-bottom: 120px;
            }
            body.devotion-mode #scroll-wrapper {
                overflow-y: auto;
            }
        }

        .card { background: var(--card-bg); border-radius: var(--radius-main); padding: 30px; box-shadow: var(--shadow-soft); text-align: center; margin-bottom: 25px; border: 1px solid var(--border-color); transition: transform 0.3s ease; position: relative; overflow: hidden; }
        .card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: linear-gradient(90deg, transparent, var(--accent-blue), transparent); opacity: 0.5; }

        .mascot-container { width: 140px; height: 140px; margin: 0 auto 20px; position: relative; }
        .mascot-svg { width: 100%; height: 100%; animation: float 3.5s ease-in-out infinite; filter: drop-shadow(0 10px 15px rgba(124, 161, 179, 0.3)); }
        .halo { transform-origin: center; animation: halo-glow 3s ease-in-out infinite alternate; }
        .eye { transform-origin: center; animation: blink 4s infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-8px) rotate(1deg); } }
        @keyframes halo-glow { 0% { opacity: 0.6; stroke-width: 2px; } 100% { opacity: 1; stroke-width: 3px; } }
        @keyframes blink { 0%, 48%, 52%, 100% { transform: scaleY(1); } 50% { transform: scaleY(0.1); } }

        .btn-primary { background: var(--text-primary); color: white; border: none; padding: 14px 30px; border-radius: 50px; font-size: 1rem; cursor: pointer; font-weight: 500; width: 100%; transition: all 0.2s ease; box-shadow: 0 4px 15px rgba(90, 82, 76, 0.2); }
        .btn-primary:active { transform: scale(0.97); }
        .btn-icon { background: transparent; border: none; cursor: pointer; padding: 8px; color: var(--accent-blue); transition: transform 0.2s; display: inline-flex; align-items: center; justify-content: center; }
        .btn-icon:hover { background-color: var(--accent-blue-light); border-radius: 50%; }

        .preservative-btn { background: white; border: 1px solid var(--accent-green); color: var(--accent-green); padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; cursor: pointer; margin-bottom: 15px; display: inline-flex; align-items: center; gap: 5px; transition: all 0.2s; }
        .preservative-box { font-family: 'Noto Serif TC', serif; font-size: 1rem; color: var(--text-primary); min-height: 40px; margin-bottom: 15px; font-style: italic; opacity: 0; transition: opacity 0.5s; }

        .progress-bar-bg { background: #eee; border-radius: 10px; height: 16px; overflow: hidden; width: 100%; margin-bottom: 10px; position: relative; }
        .progress-bar-fill { background: linear-gradient(90deg, var(--accent-blue), #A3C4BC); height: 100%; width: 0%; transition: width 1.5s cubic-bezier(0.22, 1, 0.36, 1); border-radius: 10px; }
        .progress-info { background: #FAFAFA; padding: 15px; border-radius: 15px; border: 1px solid var(--border-color); margin-bottom: 15px; }
        .progress-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; font-size: 0.9rem; color: var(--text-primary); }
        
        .progress-quote { font-size: 0.9rem; color: var(--accent-blue); font-style: italic; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #eee; display: flex; align-items: flex-start; gap: 5px; cursor: pointer; transition: color 0.2s; }
        .progress-quote:hover { color: var(--accent-green); }
        .refresh-icon { font-size: 1.1rem; opacity: 0.7; margin-top: 1px; margin-left: 5px; }

        .check-in-btn { background: var(--accent-blue); color: white; border: none; padding: 10px 0; border-radius: 30px; font-size: 0.9rem; cursor: pointer; width: 100%; box-shadow: 0 4px 10px rgba(124, 161, 179, 0.3); transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .check-in-btn.checked { background: var(--accent-green); cursor: default; }

        /* --- Devotion Section Specifics (NEW JOURNAL UI) --- */
        .serif-font, .bible-text { font-family: 'Noto Serif TC', serif; }
        .bible-text { line-height: 2.2; font-size: 1.15rem; letter-spacing: 0.05em; }

        .journal-scroll::-webkit-scrollbar { width: 5px; height: 5px; }
        .journal-scroll::-webkit-scrollbar-track { background: transparent; }
        .journal-scroll::-webkit-scrollbar-thumb { background-color: #D6D0C8; border-radius: 10px; }
        .journal-scroll::-webkit-scrollbar-thumb:hover { background-color: #A68C76; }

        .loader { border: 2px solid #F2EBE5; border-top: 2px solid #A68C76; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .mood-btn.active { transform: scale(1.25); opacity: 1; filter: grayscale(0%) drop-shadow(0 2px 4px rgba(166, 140, 118, 0.2)); background-color: #fff; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .mood-btn { opacity: 0.6; filter: grayscale(80%); transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
        .mood-btn:hover { opacity: 1; filter: grayscale(0%); transform: scale(1.1); background-color: #fff; }

        .flip-container { perspective: 1000px; width: 100%; height: 340px; cursor: pointer; }
        .flipper { position: relative; width: 100%; height: 100%; transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform-style: preserve-3d; }
        .flip-container.flipped .flipper { transform: rotateY(180deg); }
        .front, .back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: var(--radius-main); box-shadow: var(--shadow-soft); background: var(--card-bg); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; border: 1px solid var(--border-color); }
        .back { transform: rotateY(180deg); background: #FDFBF7; border: 2px solid var(--accent-blue); }
        .quote-content { font-family: 'Noto Serif TC', serif; font-size: 1.25rem; margin-bottom: 20px; color: var(--text-primary); line-height: 1.6; text-align: center; }
        .result-box { background: var(--accent-blue-light); border-radius: var(--radius-btn); padding: 25px; margin-top: 20px; margin-bottom: 10px; min-height: 120px; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; opacity: 0; transition: all 0.5s ease; border: 1px solid var(--border-color); color: var(--text-primary); font-family: 'Noto Serif TC', serif; font-size: 1.1rem; position: relative; overflow: hidden; }
        .pua-result-box { background: #F8F5FA; border: 1px solid var(--accent-purple); border-radius: var(--radius-btn); padding: 20px; margin-top: 20px; text-align: left; opacity: 0; transition: opacity 0.5s; }
        .pua-label { font-size: 0.8rem; color: var(--accent-purple); font-weight: bold; margin-bottom: 5px; display: block; text-transform: uppercase; letter-spacing: 1px; }
        .pua-content { font-size: 1rem; color: var(--text-primary); margin-bottom: 15px; line-height: 1.5; }
        .pua-level-badge { font-size: 0.75rem; padding: 4px 10px; border-radius: 12px; background-color: #F3EAF5; color: var(--accent-purple); font-weight: bold; display: none; border: 1px solid rgba(181, 163, 190, 0.3); }
        
        .tab-switcher { display: flex; background: #F2F2F2; padding: 5px; border-radius: 50px; margin-bottom: 25px; gap: 2px; }
        .tab-btn { flex: 1; border: none; background: transparent; padding: 10px 5px; border-radius: 40px; color: var(--text-secondary); cursor: pointer; font-size: 0.85rem; transition: all 0.3s; font-weight: 500; white-space: nowrap;}
        .tab-btn.active { background: white; color: var(--text-primary); shadow: 0 2px 5px rgba(0,0,0,0.05); font-weight: bold; }
        .sub-section { display: none; animation: fadeIn 0.3s ease; }
        .sub-section.active { display: block; }
        
        .ai-encourage-box { background: rgba(255,255,255,0.7); border: 1px dashed var(--accent-blue); padding: 15px; border-radius: 15px; margin-top: 20px; font-size: 0.9rem; color: var(--text-primary); text-align: center; font-family: 'Noto Serif TC', serif; font-style: italic; }
        
        .pua-tags-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .pua-tag-container, .decision-tag-container, .shield-tag-container { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; }
        .pua-tag, .decision-tag, .shield-tag { background-color: #f0f0f0; border: 1px solid #ddd; border-radius: 20px; padding: 8px 16px; font-size: 0.9rem; color: var(--text-primary); cursor: pointer; transition: all 0.2s; user-select: none; }
        .pua-tag:hover, .decision-tag:hover, .shield-tag:hover { background-color: #e0e0e0; }
        .pua-tag.selected { background-color: var(--accent-purple); color: white; border-color: var(--accent-purple); box-shadow: 0 4px 10px rgba(181, 163, 190, 0.4); }
        .decision-tag.selected { background-color: var(--accent-blue); color: white; border-color: var(--accent-blue); box-shadow: 0 4px 10px rgba(124, 161, 179, 0.4); }
        .shield-tag.selected { background-color: var(--accent-warning); color: white; border-color: var(--accent-warning); box-shadow: 0 4px 10px rgba(217, 142, 115, 0.4); }
        .refresh-pua-btn, .refresh-decision-btn, .refresh-shield-btn { background: transparent; padding: 4px 12px; border-radius: 15px; font-size: 0.8rem; cursor: pointer; transition: all 0.2s; border: 1px solid currentColor; }
        .refresh-pua-btn { color: var(--accent-purple); } .refresh-decision-btn { color: var(--accent-blue); } .refresh-shield-btn { color: var(--accent-warning); }
        
        .feedback-section { margin-top: 60px; padding-top: 20px; border-top: 1px dashed var(--border-color); text-align: center; }
        .feedback-text { font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 15px; }
        .btn-line { background-color: transparent; color: var(--accent-purple); border: 1px solid var(--accent-purple); padding: 10px 20px; border-radius: 50px; font-size: 0.9rem; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; transition: all 0.3s ease; font-weight: 500; }
        .btn-line:hover { background-color: var(--accent-purple); color: white; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); backdrop-filter: blur(3px); z-index: 2000; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; }
        .modal-overlay.show { display: flex; opacity: 1; }
        .modal-content { background: white; width: 85%; max-width: 350px; padding: 30px; border-radius: 30px; text-align: center; transform: scale(0.9); transition: transform 0.3s; box-shadow: 0 20px 60px rgba(0,0,0,0.1); max-height: 85vh; overflow-y: auto; }
        .modal-overlay.show .modal-content { transform: scale(1); }
        
        #help-modal .modal-content { max-width: 600px; text-align: left; }
        #help-modal h2 { font-size: 1.5rem; font-weight: 700; color: var(--text-primary); margin-bottom: 1rem; border-bottom: 2px solid var(--accent-blue); padding-bottom: 0.5rem; font-family: 'Noto Serif TC', serif; }
        #help-modal h3 { font-size: 1.1rem; font-weight: 600; color: var(--accent-blue); margin-top: 1.5rem; margin-bottom: 0.5rem; }
        #help-modal h4 { font-size: 1rem; font-weight: 600; color: var(--text-primary); margin-top: 1rem; margin-bottom: 0.25rem; }
        #help-modal p, #help-modal li { font-size: 0.95rem; color: var(--text-primary); line-height: 1.6; margin-bottom: 0.5rem; }
        #help-modal ul { list-style-type: disc; padding-left: 1.5rem; }
        #help-modal strong { color: #A68C76; }

        /* Future Letter Styles */
        .letter-list-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 15px; border: 1px solid #EBE6DE; border-radius: 12px; margin-bottom: 8px; 
            background: white; transition: all 0.2s; cursor: pointer; 
        }
        .letter-list-item.locked { opacity: 0.6; cursor: default; background: #FAFAFA; }
        .letter-list-item.new { border-color: #D4B483; background: #FFFCF5; }
        .letter-list-item:hover:not(.locked) { transform: translateY(-2px); shadow: 0 4px 12px rgba(0,0,0,0.05); }

        .bottom-nav {
            position: fixed !important;
            bottom: 20px !important;
            bottom: calc(20px + env(safe-area-inset-bottom)) !important;
            left: 50% !important;
            transform: translateX(-50%) !important;
            background: #ffffff !important; 
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(10px);
            border: 1px solid #e5e7eb !important;
            padding: 8px 4px !important;
            border-radius: 50px !important;
            display: flex !important;
            gap: 2px !important;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15) !important;
            z-index: 999999 !important;
            width: 95% !important;
            max-width: 460px !important;
            justify-content: space-between !important;
            align-items: center !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        footer { text-align: center; font-size: 0.75rem; color: #CCC; padding-bottom: 90px; padding-top: 20px; display: flex; flex-direction: column; align-items: center; gap: 15px; border-top: 1px dashed var(--border-color); margin-top: 20px; width: 90%; margin-left: auto; margin-right: auto; }
        .social-links, .contact-links { display: flex; justify-content: center; align-items: center; gap: 20px; }
        .contact-section { display: flex; flex-direction: column; align-items: center; gap: 8px; margin-top: 5px; }
        .icon-link { color: var(--text-secondary); transition: color 0.3s, transform 0.2s; display: flex; align-items: center; justify-content: center; }
        .icon-link:hover { color: var(--accent-blue); transform: translateY(-2px); }
        .icon-link svg { width: 24px; height: 24px; }
        .contact-label { font-size: 0.8rem; color: var(--text-secondary); font-weight: 500; letter-spacing: 1px; }
        .ai-note { font-size: 0.7rem; color: #9E9791; margin-bottom: 8px; font-style: italic; }

        .nav-item { padding: 8px 2px; flex: 1 0 auto; border-radius: 40px; border: none; background: transparent; color: var(--text-secondary); font-size: 0.7rem; font-weight: 500; cursor: pointer; transition: all 0.3s; white-space: nowrap; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px; min-width: 50px; }
        .nav-item.active { background: var(--text-primary); color: white; font-weight: bold; }
        .nav-item svg { width: 20px; height: 20px; margin-bottom: 2px; }
        .bottom-nav::-webkit-scrollbar { display: none; }
        
        .section { display: none; animation: fadeIn 0.4s ease forwards; flex: 1; }
        .section.active { display: flex; flex-direction: column; } 
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: rgba(90, 82, 76, 0.9); color: white; padding: 10px 20px; border-radius: 50px; font-size: 0.9rem; z-index: 2005; transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 5px 15px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 8px; }
        .toast.show { transform: translateX(-50%) translateY(0); }
        .global-footer-quote { text-align: center; font-size: 0.85rem; color: #D1D1D1; padding: 20px 20px 40px; line-height: 2; letter-spacing: 0.05em; font-style: italic; width: 100%; pointer-events: none; }
        
        body.devotion-mode > #scroll-wrapper > header { display: none !important; }
        body.devotion-mode .global-footer-quote { display: none; }
        body.devotion-mode #app-main { padding: 0; max-width: 100%; height: 100%; overflow: hidden; }
        body.devotion-mode #scroll-wrapper { overflow: hidden; }
        
        input::placeholder, textarea::placeholder { color: #D6D0C8; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        #quote-comment { font-size: 0.85rem; color: var(--accent-blue); font-style: italic; width: 85%; } 

        .selected-verse { background-color: #F3EAF5 !important; border-left: 3px solid #B5A3BE; }
        
        .emotion-tag { padding: 4px 10px; border-radius: 12px; background: #F2EBE5; color: #5E5A54; font-size: 0.8rem; cursor: pointer; border: 1px solid transparent; transition: all 0.2s; }
        .emotion-tag:hover { border-color: #A68C76; }
    </style>
</head>
<body>

    <!-- å…§éƒ¨æ²å‹•å®¹å™¨ (App Shell) -->
    <div id="scroll-wrapper">
        <header class="relative">
            <h1 class="main-title">æ©Ÿæ™ºçš„é¹¹é­šç”Ÿæ´»</h1>
            <div class="subtitle">Wise Salted Fish Life</div>
            
            <!-- æ–°å¢ï¼šè–ç¶“ç›®éŒ„å…¥å£æŒ‰éˆ• (çµ•å°å®šä½åœ¨å³ä¸Šè§’) -->
            <button onclick="showSection('bible-directory')" class="absolute top-6 right-4 p-2 text-[#A68C76] hover:bg-[#F2EBE5] rounded-full transition-colors" title="é–‹å•Ÿè–ç¶“ç›®éŒ„">
                <span class="text-xl">ğŸ“–</span>
            </button>

            <div onclick="showHelpModal()" class="mt-4 inline-block px-4 py-2 bg-[#F9F7F5] border border-[#EBE6DE] rounded-lg cursor-pointer hover:bg-[#F2EBE5] transition-colors shadow-sm group">
                <p class="text-xs text-[#94908A] group-hover:text-[#A68C76] tracking-widest flex items-center justify-center gap-1 transition-colors">
                    <span class="animate-pulse">âš ï¸</span> æŠ•è³‡å¤©åœ‹ç©©è³ºä¸è³ ï¼Œé†ƒæ¼¬å‰è«‹è©³é–± <span class="underline decoration-dotted underline-offset-4 font-bold ml-1">å…¬é–‹èªªæ˜æ›¸ ğŸ”—</span>
                </p>
            </div>
        </header>

        <main id="app-main" class="container-limited">
            <!-- é¦–é  -->
            <section id="home" class="section active">
                <div class="card">
                    <div style="position: absolute; top: 20px; right: 20px; background: var(--accent-blue); color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem;">é¹¹é­šé¹½åº¦ç›£æ¸¬ä¸­</div>
                    <div class="mascot-container">
                        <svg class="mascot-svg" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                            <ellipse class="halo" cx="100" cy="50" rx="60" ry="10" fill="none" stroke="#D4B483" stroke-width="6" />
                            <path d="M100 80 C 150 80, 180 110, 180 130 C 180 150, 150 170, 100 170 C 50 170, 20 150, 20 130 C 20 110, 50 80, 100 80 Z" fill="#7CA1B3" />
                            <path d="M180 130 L 200 110 L 200 150 Z" fill="#7CA1B3" />
                            <ellipse cx="60" cy="135" rx="10" ry="6" fill="#FFAB91" opacity="0.7" />
                            <ellipse cx="140" cy="135" rx="10" ry="6" fill="#FFAB91" opacity="0.7" />
                            <g class="eye">
                                <line x1="75" y1="112" x2="75" y2="128" stroke="white" stroke-width="3" stroke-linecap="round"/><line x1="69" y1="118" x2="81" y2="118" stroke="white" stroke-width="3" stroke-linecap="round"/>
                                <line x1="125" y1="112" x2="125" y2="128" stroke="white" stroke-width="3" stroke-linecap="round"/><line x1="119" y1="118" x2="131" y2="118" stroke="white" stroke-width="3" stroke-linecap="round"/>
                            </g>
                            <line x1="95" y1="145" x2="105" y2="145" stroke="white" stroke-width="3" stroke-linecap="round"/>
                        </svg>
                    </div>
                    <h2 id="daily-status-title">é¹¹é­šé¹½åº¦æ¢æ¸¬ä¸­...</h2>
                    <p id="daily-status-desc" class="text-muted" style="margin-bottom: 15px;">è«‹ä¿æŒå‘¼å¸ï¼Œæ­£åœ¨è¨ˆç®—ä½ èˆ‡å¤©åœ‹çš„è·é›¢...</p>
                    <div style="margin-bottom: 20px;">
                        <button class="preservative-btn" onclick="getPreservative()">âš ï¸ é ˜å–å±¬éˆé˜²è…åŠ‘ (æ€¥æ•‘ç”¨)</button>
                        <div id="preservative-display" class="preservative-box"></div>
                    </div>
                    <div class="bible-plan-panel">
                        <h3 style="font-family:'Noto Serif TC'; font-size:1.1rem; margin-bottom:5px;">é¹¹é­šé†ƒæ¼¬ä¸­</h3>
                        <p class="panel-desc">ã€Œç«‹å¿—åšä¸€æ¢ç”¨è–ç¶“é†ƒæ¼¬çš„é¹¹é­šï¼æ¯å¤©æ’’é»é¹½ï¼ˆè®€ç¶“ï¼‰ï¼Œç”Ÿæ´»æœƒæ›´é¦™å–”ã€‚ã€</p>
                        <div class="progress-bar-bg"><div id="bible-progress" class="progress-bar-fill"></div></div>
                        <div class="progress-info">
                            <div class="progress-row">
                                <span style="display: flex; align-items: center; gap: 5px;">ğŸ“… <span id="current-date-text">--/--</span></span> 
                                <span id="percent-text" style="font-weight:bold; color:var(--accent-blue);">0% å…¥å‘³</span>
                            </div>
                            <div class="progress-row" style="justify-content: flex-start;">ğŸ“– æœ¬æ—¥é€²åº¦ï¼š<span id="plan-scope-text" style="font-weight: bold; margin-left: 5px;">--</span></div>
                            <div class="progress-row" style="justify-content: flex-start;">ğŸ§‚ æœ¬æ—¥åŠ é¹½é‡ï¼š<span id="today-salt-stars" style="margin-left: 5px; color: var(--accent-gold); letter-spacing: 2px;"></span></div>
                            <div class="progress-quote" id="daily-word" onclick="refreshDailyWord()" title="é»æ“Šé‡åˆ·å°èª">
                                <span>ğŸ’¬ æœ¬æ—¥é†ƒæ¼¬å°èª...</span>
                                <span class="refresh-icon">â†»</span>
                            </div>
                        </div>
                        <button class="check-in-btn" onclick="showSection('devotion', document.querySelector('#nav-devotion'))">å‰å¾€é†ƒæ¼¬æ‰“å¡ âœ</button>
                    </div>
                    <div class="mt-6 pt-4 border-t border-dashed border-[#EBE6DE] text-center">
                        <p class="text-xs text-[#94908A] mb-2">è³‡æ–™ä¿éšªç®±</p>
                        <div class="flex justify-center gap-2">
                            <button onclick="exportData()" class="text-xs border border-[#EBE6DE] rounded-lg px-3 py-1 text-[#5E5A54] hover:bg-[#F2EBE5]">åŒ¯å‡ºå‚™ä»½</button>
                            <button onclick="document.getElementById('import-file').click()" class="text-xs border border-[#EBE6DE] rounded-lg px-3 py-1 text-[#5E5A54] hover:bg-[#F2EBE5]">åŒ¯å…¥å‚™ä»½</button>
                            <input type="file" id="import-file" style="display: none;" onchange="importData(this)">
                        </div>
                    </div>
                </div>
            </section>

            <!-- æ–°å¢ï¼šç¨ç«‹è–ç¶“é–±è®€é é¢ (Standalone Reader) -->
            <section id="bible-reader-standalone" class="section h-full w-full bg-white hidden fixed top-0 left-0 z-[2000] overflow-hidden flex flex-col">
                <div class="px-6 py-4 border-b border-[#F5F2EA] flex justify-between items-center bg-white/95 backdrop-blur shrink-0">
                    <h2 id="standalone-reader-title" class="text-lg font-bold font-serif text-[#5E5A54] tracking-wide">--</h2>
                    <!-- ä¿®æ”¹ï¼šæŒ‰éˆ•æ–‡å­—æ”¹ç‚ºã€Œé—œé–‰ã€ï¼Œä¸¦ç¶å®šæ–°çš„é—œé–‰å‡½å¼ -->
                    <button onclick="closeStandaloneReader()" class="p-2 bg-[#F9F7F5] rounded-full text-[#94908A] hover:bg-[#EBE6DE] hover:text-[#5E5A54] transition-colors text-xs font-bold px-4">
                        é—œé–‰ âœ•
                    </button>
                </div>
                <div id="standalone-reader-content" class="flex-1 overflow-y-auto p-6 md:p-10 bible-text text-[#5E5A54] text-lg leading-loose journal-scroll pb-20">
                    <!-- Content -->
                </div>
            </section>

            <!-- è£œå›ï¼šè–ç¶“ç›®éŒ„ (Bible Directory) -->
            <section id="bible-directory" class="section h-full w-full">
                <div class="card" style="min-height: 80vh;">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold font-serif m-0">ğŸ“š è–ç¶“ç›®éŒ„</h2>
                        <button onclick="showSection('home')" class="text-sm text-[#94908A] hover:text-[#5E5A54]">é—œé–‰ âœ•</button>
                    </div>

                    <!-- èˆŠç´„/æ–°ç´„ åˆ‡æ› -->
                    <div class="flex border-b border-[#EBE6DE] mb-6">
                        <button onclick="switchDirectoryTab('ot')" id="dir-tab-ot" class="flex-1 py-2 text-sm font-bold text-[#A68C76] border-b-2 border-[#A68C76] transition-colors">èˆŠç´„ Old Testament</button>
                        <button onclick="switchDirectoryTab('nt')" id="dir-tab-nt" class="flex-1 py-2 text-sm font-bold text-[#9E9791] border-b-2 border-transparent hover:text-[#5E5A54] transition-colors">æ–°ç´„ New Testament</button>
                    </div>

                    <!-- æ›¸å·åˆ—è¡¨ -->
                    <div id="dir-book-list" class="grid grid-cols-4 gap-2 mb-6">
                        <!-- JS Rendered -->
                    </div>

                    <!-- ç« ç¯€é¸æ“‡ (é è¨­éš±è—) -->
                    <div id="dir-chapter-area" class="hidden border-t border-dashed border-[#EBE6DE] pt-4 animation-fadeIn">
                        <h3 id="dir-selected-book" class="text-center font-serif text-lg font-bold text-[#5E5A54] mb-4">--</h3>
                        <div id="dir-chapter-list" class="grid grid-cols-6 gap-2">
                            <!-- JS Rendered -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- éˆä¿® (Devotion) -->
            <section id="devotion" class="section h-full w-full bg-[#FDFCF8]">
                <div class="h-full flex flex-col w-full">
                    <header class="bg-white/80 backdrop-blur-md border-b border-[#EBE6DE] sticky top-0 z-20 shrink-0 w-full" style="display:block!important; padding: 0;">
                        <div class="max-w-7xl mx-auto px-4 md:px-6 flex justify-between items-center h-16 gap-3 md:gap-6">
                            <div class="flex items-center gap-3 shrink-0">
                                <!-- é»æ“Š Logo å¯ä»¥è¿”å›ç›®éŒ„ -->
                                <button onclick="showSection('bible-directory')" class="flex items-center gap-2 hover:opacity-70 transition-opacity">
                                    <span class="text-2xl opacity-80">ğŸŸ</span>
                                    <h1 class="block text-lg font-bold tracking-widest text-[#5E5A54] m-0">é†ƒæ¼¬é¹¹é­š</h1>
                                </button>
                                <div class="flex items-center bg-[#F9F7F5] rounded-full px-3 py-1.5 border border-[#EBE6DE] hover:border-[#D6D0C8] transition-colors">
                                    <input type="date" id="journal-date-picker" class="bg-transparent border-none text-xs md:text-sm font-medium focus:ring-0 outline-none cursor-pointer w-[110px] md:w-auto text-[#5E5A54]">
                                    <button id="journal-checkin-btn" class="ml-2 text-xs text-gray-400 hover:text-m-green" title="æ‰“å¡å®Œæˆ">âœ”ï¸</button>
                                </div>
                            </div>
                            <div class="flex items-center shrink-0 w-16 justify-end hidden md:flex">
                                <div id="save-status" class="text-xs font-medium text-[#8DA399] opacity-0 transition-opacity duration-500 flex items-center gap-1 bg-[#8DA399]/10 px-3 py-1 rounded-full tracking-wider">
                                    <span>SAVED</span>
                                </div>
                            </div>
                        </div>
                    </header>

                    <div class="flex-1 w-full max-w-7xl mx-auto p-4 md:p-8 grid grid-cols-1 lg:grid-cols-12 gap-8 overflow-y-auto lg:overflow-hidden relative">
                        <aside class="hidden lg:flex lg:col-span-2 flex-col gap-4 overflow-hidden h-full">
                            <div class="h-full flex flex-col">
                                <h3 class="text-xs font-semibold text-[#94908A] uppercase tracking-[0.2em] mb-4 pl-1 shrink-0">Reading Plan</h3>
                                <div class="flex-1 overflow-y-auto pr-2 pl-1 pb-4 space-y-4 journal-scroll" id="plan-list"></div>
                            </div>
                        </aside>

                        <!-- æ‰‹æ©Ÿç‰ˆé€²åº¦é¸å–® (æ”¹ç‚ºå…©è¡Œ) -->
                        <div class="lg:hidden col-span-1 bg-[#FDFCF8] p-4 rounded-xl border border-[#EBE6DE] shadow-sm shrink-0 flex flex-col gap-2">
                            <!-- è¡Œ 1: è®€ç¶“é€²åº¦ -->
                            <div id="mobile-plan-row-1" class="flex gap-2 overflow-x-auto no-scrollbar items-center pb-1"></div>
                            <!-- è¡Œ 2: å„é¡æ—¥è¨˜ -->
                            <div id="mobile-plan-row-2" class="flex gap-2 overflow-x-auto no-scrollbar items-center pt-1 border-t border-dashed border-[#EBE6DE]"></div>
                        </div>

                        <section class="lg:col-span-10 flex flex-col bg-white rounded-2xl shadow-[0_4px_20px_-10px_rgba(0,0,0,0.05)] border border-[#EBE6DE] overflow-hidden min-h-[500px] lg:h-full relative group">
                            <div class="h-1 w-full bg-[#F2EBE5] shrink-0"></div>
                            
                            <!-- BIBLE READER VIEW -->
                            <div id="view-reader" class="flex flex-col h-full">
                                <div class="px-8 py-5 border-b border-[#F5F2EA] flex justify-between items-start bg-white sticky top-0 z-10 shrink-0">
                                    <div class="flex flex-col gap-1 overflow-hidden">
                                        <span class="text-[10px] font-bold text-[#A68C76] uppercase tracking-widest" id="bible-book-tag">SCRIPTURE</span>
                                        <h2 id="bible-title" class="text-xl text-[#5E5A54] font-medium tracking-wide truncate pr-2 m-0">è«‹é¸æ“‡é€²åº¦</h2>
                                    </div>
                                    <button id="copy-btn" class="hidden flex items-center gap-1.5 px-3 py-1.5 text-[#94908A] hover:text-[#A68C76] hover:bg-[#FAF9F6] rounded-lg text-xs transition-all tracking-widest shrink-0">
                                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                                        è¤‡è£½
                                    </button>
                                </div>
                                <div id="bible-content" class="flex-1 overflow-y-auto p-8 bible-text text-[#5E5A54] bg-white scroll-smooth selection:bg-[#F2EBE5] selection:text-[#5E5A54] journal-scroll min-h-[300px] lg:h-auto flex flex-col justify-center">
                                    <div class="h-full flex flex-col items-center justify-center text-[#B0AAA3] gap-6 text-center">
                                        <div class="w-20 h-20 rounded-full bg-[#FDFCF8] border border-[#F2EBE5] flex items-center justify-center">
                                            <span class="text-3xl opacity-40 grayscale">ğŸ“–</span>
                                        </div>
                                        <div>
                                            <p class="text-base font-serif text-[#94908A] whitespace-normal px-4">æº–å‚™å¥½è¢«é†ƒæ¼¬äº†å—ï¼Ÿ</p>
                                            <p class="text-xs mt-2 font-light tracking-wider opacity-60 whitespace-normal px-4">é»æ“Šä¸Šæ–¹é€²åº¦ï¼Œè®“ç¥çš„è©±èªæ…¢æ…¢å…¥å‘³ã€‚</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- NOTE VIEW -->
                            <div id="view-note" class="flex flex-col h-full hidden">
                                <div class="px-8 py-5 border-b border-[#F5F2EA] flex flex-col gap-4 shrink-0">
                                    <div class="flex items-center justify-between">
                                        <h3 class="font-serif text-lg text-[#5E5A54] flex items-center gap-3 m-0">
                                            <span class="text-lg opacity-60">âœğŸ»</span> é†ƒæ¼¬ç­†è¨˜
                                        </h3>
                                        <button onclick="downloadNote()" class="text-xs text-[#A68C76] hover:text-[#5E5A54] transition-colors font-medium tracking-widest px-2 py-1 hover:bg-[#F9F7F5] rounded">ä¸‹è¼‰æ—¥è¨˜</button>
                                    </div>
                                </div>
                                <div class="flex-1 overflow-y-auto p-8 space-y-8 bg-white selection:bg-[#F2EBE5] journal-scroll">
                                    
                                    <!-- æ–°å¢ï¼šæ¯æ—¥éˆä¿®å°èªå¡ç‰‡ -->
                                    <div id="daily-devotional-card" class="hidden bg-[#FAFAFA] p-6 rounded-2xl border border-[#F0EAE4] mb-2 shadow-sm relative overflow-hidden group">
                                        <!-- è£é£¾èƒŒæ™¯ -->
                                        <div class="absolute -right-6 -top-6 text-8xl opacity-[0.03] rotate-12 select-none pointer-events-none">ğŸ•Šï¸</div>
                                        
                                        <h4 id="devotional-title" class="font-serif font-bold text-[#8F9EAC] text-lg mb-3 tracking-wide"></h4>
                                        <p id="devotional-text" class="text-sm text-[#5E5A54] leading-7 font-serif text-justify mb-6 whitespace-pre-line"></p>
                                        
                                        <div class="flex justify-end border-t border-[#F0EAE4] pt-4">
                                            <a id="devotional-song-link" href="#" target="_blank" class="inline-flex items-center gap-2 text-xs font-bold text-[#A68C76] bg-white border border-[#EBE6DE] px-4 py-2 rounded-full hover:bg-[#A68C76] hover:text-white hover:border-[#A68C76] transition-all shadow-sm group-hover:shadow-md">
                                                <span class="opacity-70 text-sm">ğŸµ</span> <span id="devotional-song-name">è½é¦–è©©æ­Œ</span>
                                            </a>
                                        </div>
                                    </div>

                                    <div class="group relative pl-4 border-l-2 border-[#C8A8A4]/30 focus-within:border-[#C8A8A4] transition-colors">
                                        <label class="block text-xs font-bold text-[#C8A8A4] uppercase mb-2 tracking-widest">Rhema / æ„Ÿå‹•</label>
                                        <textarea id="note-scripture" placeholder="é»é¸å·¦å´ç¶“æ–‡ï¼Œæˆ–æ˜¯æ‰‹å‹•è¼¸å…¥é‚£äº›è®“ä½ å¿ƒé ­ä¸€éœ‡çš„è©±..." class="w-full bg-transparent border-none p-0 focus:ring-0 outline-none bible-text text-base min-h-[100px] resize-none placeholder-[#D6D0C8] text-[#5E5A54]"></textarea>
                                    </div>
                                    <div class="group relative pl-4 border-l-2 border-[#8F9EAC]/30 focus-within:border-[#8F9EAC] transition-colors">
                                        <label class="block text-xs font-bold text-[#8F9EAC] uppercase mb-2 tracking-widest">Reflection / é ˜å—</label>
                                        <textarea id="note-reflection" placeholder="éš¨ç­†è¨˜éŒ„å¿ƒä¸­çš„æ„Ÿå‹•ï¼Œé€™äº›éƒ½æ˜¯æ©å…¸çš„çµæ™¶..." class="w-full bg-transparent border-none p-0 focus:ring-0 outline-none text-[#5E5A54] min-h-[140px] resize-none placeholder-[#D6D0C8] leading-relaxed font-light"></textarea>
                                    </div>
                                    <div class="group relative pl-4 border-l-2 border-[#8DA399]/30 focus-within:border-[#8DA399] transition-colors">
                                        <label class="block text-xs font-bold text-[#8DA399] uppercase mb-2 tracking-widest">Prayer / ç¦±å‘Š</label>
                                        <textarea id="note-prayer" placeholder="èˆ‡å¤§è€é—†çš„ç§å¯†å°è©±æ™‚é–“..." class="w-full bg-transparent border-none p-0 focus:ring-0 outline-none text-[#5E5A54] min-h-[100px] resize-none placeholder-[#D6D0C8] leading-relaxed font-light"></textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- GRATITUDE VIEW -->
                            <div id="view-gratitude" class="flex flex-col h-full hidden">
                                <div class="px-8 py-5 border-b border-[#F5F2EA] shrink-0 flex justify-between items-center">
                                    <h3 class="font-serif text-lg text-[#5E5A54]">ğŸ™ æ„Ÿæ©æ—¥è¨˜</h3>
                                    <span class="text-xs text-[#94908A] tracking-wider">æ•¸ç®—æ©å…¸</span>
                                </div>
                                <div class="flex-1 relative bg-white overflow-hidden">
                                    <!-- æ ¼ç·šèƒŒæ™¯æ•ˆæœ -->
                                    <div class="absolute inset-0 pointer-events-none" 
                                         style="background-image: linear-gradient(transparent 95%, #EBE6DE 95%); background-size: 100% 2.5rem; background-position: 0 1.5rem;">
                                    </div>
                                    <!-- è‡ªç”±æ›¸å¯«å€ -->
                                    <textarea id="gratitude-text" 
                                              class="w-full h-full p-8 bg-transparent border-none focus:ring-0 outline-none text-[#5E5A54] text-lg leading-[2.5rem] font-serif resize-none placeholder-[#D6D0C8] journal-scroll"
                                              placeholder="ä»Šå¤©ç™¼ç”Ÿäº†ä»€éº¼ç¾å¥½çš„äº‹ï¼Ÿ
ãƒ»æ„Ÿè¬ç¥...
ãƒ»æ„Ÿè¬ç¥..."></textarea>
                                </div>
                            </div>

                            <!-- EMOTION VIEW -->
                            <div id="view-emotion" class="flex flex-col h-full hidden">
                                <div class="px-8 py-5 border-b border-[#F5F2EA] shrink-0 flex justify-between items-center">
                                    <h3 class="font-serif text-lg text-[#5E5A54]">ğŸŒ§ï¸ æƒ…ç·’æ—¥è¨˜</h3>
                                    <span class="text-xs text-[#94908A] tracking-wider">è¦ºå¯Ÿèˆ‡è½‰åŒ–</span>
                                </div>
                                <div class="flex-1 overflow-y-auto p-6 bg-white journal-scroll">
                                    
                                    <!-- æƒ…ç·’é¸æ“‡å™¨ (Emotion Chart) -->
                                    <div class="mb-6 space-y-4">
                                        <div class="space-y-2">
                                            <span class="text-[10px] text-m-green font-bold tracking-widest uppercase">â˜€ï¸ æ­£å‘ / èƒ½é‡</span>
                                            <div class="flex flex-wrap gap-2" id="emotion-tags-pos"></div>
                                        </div>
                                        <div class="space-y-2">
                                            <span class="text-[10px] text-[#9E9791] font-bold tracking-widest uppercase">â˜ï¸ ä¸­æ€§ / ç‹€æ…‹</span>
                                            <div class="flex flex-wrap gap-2" id="emotion-tags-neu"></div>
                                        </div>
                                        <div class="space-y-2">
                                            <span class="text-[10px] text-m-rose font-bold tracking-widest uppercase">ğŸŒ§ï¸ è² å‘ / é‡æ“”</span>
                                            <div class="flex flex-wrap gap-2" id="emotion-tags-neg"></div>
                                        </div>
                                    </div>

                                    <hr class="border-dashed border-[#EBE6DE] my-6">

                                    <!-- çµæ§‹åŒ–è¼¸å…¥æ¬„ä½ -->
                                    <div class="space-y-6">
                                        <div class="group">
                                            <label class="block text-xs font-bold text-[#A68C76] mb-1">1. äº‹ä»¶ (Fact)</label>
                                            <input type="text" id="emotion-event" placeholder="ç™¼ç”Ÿäº†ä»€éº¼äº‹ï¼Ÿ(å®¢è§€äº‹å¯¦)" class="w-full bg-[#FAFAFA] border border-[#EBE6DE] rounded-lg px-3 py-2 text-sm focus:border-[#A68C76] outline-none text-[#5E5A54]">
                                        </div>

                                        <div class="group">
                                            <label class="block text-xs font-bold text-[#A68C76] mb-1">2. æƒ…ç·’ (Feeling)</label>
                                            <input type="text" id="emotion-feeling" placeholder="é»é¸ä¸Šæ–¹æ¨™ç±¤æˆ–è¼¸å…¥..." class="w-full bg-[#FAFAFA] border border-[#EBE6DE] rounded-lg px-3 py-2 text-sm focus:border-[#A68C76] outline-none text-[#5E5A54]">
                                        </div>

                                        <div class="group">
                                            <label class="block text-xs font-bold text-[#D98E73] mb-1">3. ç›¸ä¿¡äº†ä»€éº¼ (Belief)</label>
                                            <textarea id="emotion-belief" placeholder="æˆ‘å¿ƒä¸­çš„è§£è®€æˆ–è¬Šè¨€æ˜¯... (ä¾‹å¦‚ï¼šæˆ‘è¦ºå¾—è¢«éºæ£„äº†ã€æˆ‘ä¸é‡è¦)" class="w-full bg-[#FFF5F2] border border-[#F2EBE5] rounded-lg px-3 py-2 text-sm focus:border-[#D98E73] outline-none text-[#5E5A54] min-h-[60px] resize-none"></textarea>
                                        </div>

                                        <div class="group">
                                            <label class="block text-xs font-bold text-[#7CA1B3] mb-1">4. ç¥å¦‚ä½•çœ‹ (Truth)</label>
                                            <textarea id="emotion-god-view" placeholder="ç¥çš„è©±èª/çœŸç†æ˜¯æ€éº¼èªªçš„ï¼Ÿ(ä¾‹å¦‚ï¼šç¥çœ‹æˆ‘ç‚ºå¯¶è²´)" class="w-full bg-[#F0F7FA] border border-[#E8F1F5] rounded-lg px-3 py-2 text-sm focus:border-[#7CA1B3] outline-none text-[#5E5A54] min-h-[60px] resize-none"></textarea>
                                        </div>

                                        <div class="group">
                                            <label class="block text-xs font-bold text-[#8DA399] mb-1">5. ç¦±å‘Š (Prayer)</label>
                                            <textarea id="emotion-prayer" placeholder="åŸºæ–¼çœŸç†ï¼Œå‘ç¥å›æ‡‰..." class="w-full bg-[#F2F7F5] border border-[#EBF2F0] rounded-lg px-3 py-2 text-sm focus:border-[#8DA399] outline-none text-[#5E5A54] min-h-[60px] resize-none"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- FUTURE (TIME CAPSULE) VIEW - NEW -->
                            <div id="view-future" class="flex flex-col h-full hidden">
                                <div class="px-8 py-5 border-b border-[#F5F2EA] shrink-0 flex justify-between items-center">
                                    <h3 class="font-serif text-lg text-[#5E5A54]">ğŸ“® å¯«çµ¦æœªä¾†</h3>
                                    <span class="text-xs text-[#94908A] tracking-wider">æ™‚å…‰è† å›Š</span>
                                </div>
                                <div class="flex-1 overflow-y-auto p-6 bg-white flex flex-col gap-6 journal-scroll">
                                    
                                    <!-- Write Area -->
                                    <div class="bg-[#FDFBF7] p-6 rounded-2xl border border-[#EBE6DE] shadow-sm">
                                        <h4 class="text-sm font-bold text-[#A68C76] mb-4 flex items-center gap-2">
                                            <span>âœğŸ»</span> å¯«ä¿¡çµ¦æœªä¾†çš„è‡ªå·±
                                        </h4>
                                        <div class="flex items-center gap-2 mb-4">
                                            <label class="text-xs text-[#9E9791]">å¯„é€æ—¥æœŸï¼š</label>
                                            <input type="date" id="future-date" class="bg-white border border-[#D6D0C8] rounded-lg px-2 py-1 text-xs text-[#5E5A54] focus:border-[#A68C76] outline-none">
                                        </div>
                                        <textarea id="future-content" placeholder="è¦ªæ„›çš„æœªä¾†é¹¹é­š..." class="w-full h-32 bg-white border border-[#EBE6DE] rounded-xl p-3 text-sm focus:border-[#A68C76] outline-none resize-none mb-4 placeholder-[#D6D0C8]"></textarea>
                                        <button onclick="saveFutureLetter()" class="w-full py-2 bg-[#A68C76] text-white rounded-full text-xs font-bold hover:bg-[#8e7662] transition-colors shadow-sm">
                                            å°å­˜å¯„å‡º ğŸ“¤
                                        </button>
                                    </div>

                                    <!-- Mailbox Area -->
                                    <div>
                                        <h4 class="text-sm font-bold text-[#5E5A54] mb-3 flex items-center gap-2 pl-1">
                                            <span>ğŸ“¬</span> ä¿¡ç®±
                                        </h4>
                                        <div id="future-list" class="space-y-2">
                                            <!-- JS generated letters -->
                                            <div class="text-center py-8 text-xs text-[#D6D0C8] italic">ä¿¡ç®±æ˜¯ç©ºçš„...</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </section>
                    </div>
                </div>
            </section>

            <!-- é¹¹é­šç¿»èº« -->
            <section id="flip" class="section">
                <div class="card">
                    <div class="flip-container" onclick="flipCard()">
                        <div class="flipper" id="flipper">
                            <div class="front">
                                <div style="font-size: 3rem; margin-bottom: 15px;">ğŸ</div>
                                <h3 style="font-family: 'Noto Serif TC';">é¹¹é­šç¿»èº«</h3>
                                <p class="text-muted" style="margin-top: 10px;">é»æ“Šå¡ç‰‡ï¼Œè«‹ä¸»å»šç‚ºä½ ä¸Šä¸€é“å…¥å‘³çš„ç¿»èº«ç‰¹é¤</p>
                                <p class="text-muted" style="font-size: 0.8rem;">(å« 30% é¹¹é­šé›æ¹¯ï¼Œèˆ‡ 100% ä¸Šå¸ç´”æ·¨æ©å…¸)</p>
                            </div>
                            <div class="back">
                                <p class="quote-content" id="quote-content">æ­£åœ¨å¾Œå°ç†¬è£½äº®å…‰...</p>
                                <p class="quote-source" id="quote-source" class="text-muted" style="font-weight:500;">--</p>
                                <div style="width: 40%; height: 1px; border-top: 1px dashed #D6D0C8; margin: 30px auto;"></div>
                                <p id="quote-comment"> </p>
                                
                                <button class="btn-icon" onclick="saveCardImage(event)" style="margin-top:auto; font-weight:bold;">ğŸ“¸ æ‹ç«‹å¾—æ‰“åŒ… (å­˜åœ–)</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ä¿®æ”¹ï¼šå°‡æŒ‰éˆ•ç§»è‡³ flip-container å¤–éƒ¨ï¼Œé¿å…æ“ å£“å¡ç‰‡å…§å®¹ -->
                    <button id="read-chapter-btn" class="hidden w-full mt-6 py-3 text-sm font-bold text-[#A68C76] bg-[#FDFBF7] border border-[#EBE6DE] rounded-xl hover:bg-[#A68C76] hover:text-white transition-all shadow-sm flex items-center justify-center gap-2">
                        <span>ğŸ“–</span> é–±è®€å®Œæ•´ç« ç¯€
                    </button>
                </div>
            </section>

            <!-- è°æ˜é¹¹é­š -->
            <section id="pua" class="section">
                <div class="card">
                    <h2>è°æ˜é¹¹é­š</h2>
                    <div class="text-muted" style="margin-bottom: 45px;">
                        <p><strong>æ‹’çµ•è¢«è£é€²å®—æ•™ç½é ­ï¼</strong></p>
                        <p>è®“ä½ è­˜ç ´å¥—è·¯ï¼Œæ‰¾å›è‡ªç”±ã€‚</p>
                    </div>
                    <div class="pua-tags-header">
                        <label class="label" style="margin-bottom: 0;">ä½ å‰›æ‰è½åˆ°äº†å“ªå¥ã€Œé‡‘å¥ã€ï¼Ÿ</label>
                        <button class="refresh-pua-btn" onclick="renderPuaTags()">ğŸ”„ æ›ä¸€æ‰¹</button>
                    </div>
                    <div id="pua-tag-container" class="pua-tag-container"></div>
                    <button class="btn-primary" onclick="detectPUA()" style="background-color: var(--accent-purple);">å•Ÿå‹•ç¿»è­¯è’Ÿè’»</button>
                    <div class="pua-result-box" id="pua-result">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span class="pua-label">äººè©±ç¿»è­¯æ©Ÿ</span>
                            <span id="pua-level" class="pua-level-badge"></span>
                        </div>
                        <p class="pua-content" id="pua-translation" style="font-weight: bold;">--</p>
                        <span class="pua-label">é¹¹é­šåæ“Š (å…§å¿ƒ OS)ï¼š</span>
                        <p class="pua-content" id="pua-defense">--</p>
                    </div>
                    <p style="font-size: 0.75rem; color: #D98E73; margin-top: 15px; margin-bottom: 25px; font-style: italic; line-height: 1.5;">
                        âš ï¸ è­¦èªï¼šæœ¬ç¿»è­¯ç”± AI ç”Ÿæˆåƒ…ä¾›å¨›æ¨‚ï¼Œä¸ä»£è¡¨æ¯å€‹äººé€™æ¨£èªªçš„æ„æ€éƒ½æ˜¯é€™æ¨£ã€‚è«‹è¬¹æ…åˆ†è¾¨ï¼Œä¸è¦å°è™Ÿå…¥åº§ï¼Œä¹Ÿä¸è¦ä»¥æ­¤è«–æ–·åˆ¥äººã€‚
                    </p>
                    <button class="btn-secondary" onclick="togglePuaTest()" style="margin-top:25px; border-radius:50px; background:#F8F8F8; padding:12px; border:none; width:100%; cursor:pointer; font-weight:500;">ğŸ§¬ å±¬éˆ PUA ç—…æ¯’å¿«ç¯©</button>
                    <div id="pua-test-area" class="pua-test-area" style="display:none; background:white; border:1px solid var(--border-color); border-radius:var(--radius-main); padding:20px; margin-top:20px; text-align:left;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:15px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                            <span style="font-weight:bold; color: var(--accent-purple);">ç’°å¢ƒ PUA æ¯’æ€§æª¢æ¸¬ (7é¡Œ)</span>
                            <button onclick="initPuaTest()" style="border:none; background:none; cursor:pointer; color: var(--text-secondary); font-size: 0.8rem;">ğŸ”„ æ›ä¸€çµ„è©¦åŠ‘</button>
                        </div>
                        <div id="test-list"></div>
                        <button class="btn-primary" onclick="runPuaTest()" style="margin-top:15px; background-color: var(--accent-purple);">ç”Ÿæˆè¨ºæ–·å ±å‘Š</button>
                        <div id="test-result" class="test-result" style="display:none; margin-top:15px;"></div>
                    </div>
                    <div class="feedback-section">
                        <p class="feedback-text">é‚„æœ‰è½éæ›´æ‰¯çš„ï¼Ÿæ­¡è¿å›é¥‹çµ¦ä¸»å»šï¼</p>
                        <a href="https://line.me/R/ti/p/@469cjlho" target="_blank" rel="noopener noreferrer" class="btn-line">ğŸ’¬ åŠ  LINE æŠ•ç¨¿ PUA é‡‘å¥</a>
                    </div>
                </div>
            </section>

            <!-- æ¸¸åˆƒæœ‰é­š -->
            <section id="shield" class="section">
                <div class="card">
                    <h2>æ¸¸åˆƒæœ‰é­š</h2>
                    <div class="text-muted" style="margin-bottom: 40px;">
                        <p>é¢å°è®“äººç¿»ç™½çœ¼çš„æå•ï¼Œé€™è£¡æœ‰è®“ä½ å„ªé›…è„«èº«çš„é¹¹é­šæ™ºæ…§ã€‚</p>
                    </div>
                    <div class="pua-tags-header">
                        <label class="label" style="margin-bottom: 0;">ç•¶å°æ–¹å•ä½ é€™äº›å°·å°¬å•é¡Œæ™‚ï¼š</label>
                        <button class="refresh-shield-btn" onclick="renderShieldTags()">ğŸ”„ æ›ä¸€æ‰¹</button>
                    </div>
                    <div id="shield-tag-container" class="shield-tag-container"></div>
                    <button class="btn-primary" onclick="getExcuse()">ç”Ÿæˆç¥å›è¦†</button>
                    <div class="result-box" id="shield-result"><p id="shield-text" style="font-family: 'Noto Serif TC';"></p></div>
                    <div class="feedback-section" style="margin-top: 30px;">
                        <p class="feedback-text">é‡éæ›´è®“äººç¿»ç™½çœ¼çš„å•é¡Œï¼Ÿ</p>
                        <a href="https://line.me/R/ti/p/@469cjlho" target="_blank" rel="noopener noreferrer" class="btn-line" style="color: var(--accent-warning); border-color: var(--accent-warning);">ğŸ’¬ åŠ  LINE æŠ•ç¨¿å°·å°¬å•é¡Œ</a>
                    </div>
                </div>
            </section>

            <section id="flow" class="section">
                <div class="card">
                    <h2>ç¶½ç¶½æœ‰é­š</h2>
                    <div class="text-muted" style="margin-bottom: 20px;">
                        <p>å³ä½¿åœ¨èººå¹³çš„æ™‚åˆ»ï¼Œæ©å…¸ä¾ç„¶ç¶½ç¶½æœ‰é¤˜ã€‚</p>
                    </div>
                    <div class="tab-switcher">
                        <button class="tab-btn active" onclick="switchFlowTab('savings')">ğŸ’° 365 å­˜éŒ¢</button>
                        <button class="tab-btn" onclick="switchFlowTab('wishlist')">âœ¨ é¡˜æœ›æ¸…å–®</button>
                    </div>
                    <div id="tab-savings" class="sub-section active">
                        <div style="text-align: left; margin-bottom: 15px; font-size: 0.9rem; color: var(--text-secondary); display: flex; justify-content: space-between; align-items: center;" id="savings-total"></div>
                        <button class="btn-primary" onclick="randomSave()" style="background: var(--savings-saved-bg); margin-bottom: 20px;">ğŸ² éš¨æ©Ÿå­˜ä¸€ç­† (äº¤çµ¦å‘½é‹)</button>
                        <div class="savings-grid" id="savings-grid" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px;"></div>
                    </div>
                    <div id="tab-wishlist" class="sub-section">
                        <div class="input-group">
                            <input type="text" id="new-wish-input" placeholder="ä½ çš„é¡˜æœ›..." style="flex: 2;">
                            <input type="number" id="new-wish-cost" placeholder="$ é‡‘é¡" style="flex: 1;">
                            <button class="add-btn" onclick="addWish()">ï¼‹</button>
                        </div>
                        <div id="wish-list" class="space-y-3"></div>
                        <div class="ai-encourage-box mt-6">
                            <div class="flex items-center justify-center gap-2 mb-2 opacity-50">
                                <span class="text-lg">ğŸ¤–</span>
                                <span class="text-xs tracking-widest font-bold">AI è²¡å‹™é¡§å•</span>
                            </div>
                            <p id="financial-encouragement" class="text-[#5E5A54] leading-relaxed">--</p>
                            <button onclick="refreshFinancialEncouragement()" style="background:none; border:none; color: var(--accent-blue); font-size: 0.8rem; margin-top: 10px; cursor: pointer;">â†» æ›ä¸€å¥é¼“å‹µ</button>
                        </div>
                    </div>
                </div>
            </section>

            <div class="global-footer-quote">
                <p>ã€Œä½ å€‘æ˜¯ä¸–ä¸Šçš„é¹½ï¼Œé¹½è‹¥å¤±äº†å‘³â€¦â€¦ã€</p>
                <p>é‚£å°±æš«æ™‚åšä¸€æ¢å¿«æ¨‚çš„é¹¹é­šã€‚</p>
            </div>

            <footer>
                <div class="contact-section">
                    <span class="contact-label" style="margin-bottom: 12px; font-size: 0.85rem;">è¯çµ¡æˆ‘å€‘</span>
                    <div class="social-links" style="gap: 25px;">
                        <a href="https://www.facebook.com/profile.php?id=100068500932557" class="icon-link" aria-label="Facebook" target="_blank" rel="noopener noreferrer">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path></svg>
                        </a>
                        <a href="https://www.instagram.com/forever.believe.in.jesus/" class="icon-link" aria-label="Instagram" target="_blank" rel="noopener noreferrer">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line></svg>
                        </a>
                        <a href="https://www.threads.net/@forever.believe.in.jesus" class="icon-link" aria-label="Threads" target="_blank" rel="noopener noreferrer">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"></circle><path d="M16 8v5a3 3 0 0 0 6 0v-1a10 10 0 1 0-3.92 7.94"></path></svg>
                        </a>
                        <a href="https://line.me/R/ti/p/@469cjlho" class="icon-link" aria-label="Official Line" target="_blank" rel="noopener noreferrer">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                        </a>
                        <a href="mailto:newthingsinthelittlelight@gmail.com" class="icon-link" aria-label="Email">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                        </a>
                    </div>
                    <a href="#" onclick="showHelpModal(); return false;" style="margin-top: 12px; font-size: 0.8rem; color: var(--accent-blue); text-decoration: none; border-bottom: 1px dotted var(--accent-blue);">ğŸ“– ä½¿ç”¨èªªæ˜æ›¸</a>
                </div>
                <div style="margin-top: 25px;">
                    <p class="ai-note">ğŸ’¡ æœ¬ç«™æ‰€æœ‰æ–‡æ¡ˆçš†ç”± AI èˆ‡é¹¹é­šå”åŒé†ƒæ¼¬è€Œæˆï¼Œåƒ…ä¾›å¨›æ¨‚ã€‚</p>
                    <p style="font-size: 0.65rem; color: #CCC;">Ver 7.0 (Weighted PUA Quiz)</p>
                    <p>&copy; 2026æ©Ÿæ™ºçš„é¹¹é­šç”Ÿæ´» | è€¶ç©ŒåŠ æ²¹ç«™ x å¾®å…‰æ–°äº‹</p>
                </div>
            </footer>
        </main>
    </div>

    <!-- åº•éƒ¨å°è¦½åˆ— -->
    <nav class="bottom-nav">
        <button class="nav-item active" onclick="showSection('home', this)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
            é¦–é 
        </button>
        <button class="nav-item" id="nav-devotion" onclick="showSection('devotion', this)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
            é†ƒæ¼¬é¹¹é­š
        </button>
        <button class="nav-item" onclick="showSection('flip', this)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
            é¹¹é­šç¿»èº«
        </button>
        <button class="nav-item" onclick="showSection('pua', this)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
            è°æ˜é¹¹é­š
        </button>
        <button class="nav-item" onclick="showSection('shield', this)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
            æ¸¸åˆƒæœ‰é­š
        </button>
        <button class="nav-item" onclick="showSection('flow', this)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
            ç¶½ç¶½æœ‰é­š
        </button>
    </nav>

    <!-- ç¢ºèªè¦–çª— -->
    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="font-size: 1.2rem; margin-bottom: 15px;">è«‹ç¢ºèª</h3>
            <p id="confirm-msg" style="color: var(--text-primary); margin-bottom: 20px;">ç¢ºå®šè¦åŸ·è¡Œå—ï¼Ÿ</p>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="closeConfirmModal()" style="flex: 1; padding: 12px; border-radius: 12px; border: none; background: #f0f0f0;">å–æ¶ˆ</button>
                <button id="confirm-btn-action" style="flex: 1; padding: 12px; border-radius: 12px; border: none; background: var(--accent-warning); color: white;">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <!-- Letter Popup Modal -->
    <div id="letter-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px; background: #FFFCF5; border: 2px solid #D4B483;">
            <div class="text-center mb-6">
                <span class="text-4xl">ğŸ’Œ</span>
                <h3 class="text-xl font-serif font-bold text-[#A68C76] mt-2">ä¾†è‡ªéå»çš„ä¸€å°ä¿¡</h3>
                <p class="text-xs text-[#9E9791] mt-1" id="letter-date-display">å¯„ä»¶æ—¥æœŸï¼šYYYY-MM-DD</p>
            </div>
            <div id="letter-content-display" class="text-[#5E5A54] leading-relaxed font-serif text-justify mb-8 whitespace-pre-wrap"></div>
            <button onclick="closeLetterModal()" class="w-full py-2 bg-[#A68C76] text-white rounded-full text-sm font-bold">æ”¶è—å›æ†¶</button>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="help-modal" class="modal-overlay">
        <div class="modal-content relative">
            <button onclick="closeHelpModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            
            <div class="prose prose-sm max-w-none text-[#5E5A54]">
                <h2>ğŸ“– æ©Ÿæ™ºçš„é¹¹é­šç”Ÿæ´» | ä½¿ç”¨èªªæ˜æ›¸</h2>
                <p>è¦ªæ„›çš„é¹¹é­šå¤¥ä¼´ï¼Œå¹³å®‰ï¼š</p>
                <p>æ­¡è¿ä¾†åˆ°é€™å€‹å°ˆç‚ºã€Œä¸æƒ³éåº¦åŠªåŠ›è€Œå…§è€—ã€çš„åŸºç£å¾’æ‰“é€ çš„å±¬éˆé¿é›£æ‰€ã€‚åœ¨é€™è£¡ï¼Œæˆ‘å€‘æ‹’çµ•å±¬éˆç„¦æ…®ï¼Œä¸»å¼µåœ¨æ©å…¸ä¸­å¿«æ¨‚èººå¹³ã€‚ç‚ºäº†è®“æ‚¨èƒ½å®‰å¿ƒåœ°åœ¨é€™è£¡é†ƒæ¼¬è‡ªå·±ï¼Œè«‹èŠ±ä¸€é»æ™‚é–“é–±è®€é€™ä»½èªªæ˜æ›¸ã€‚</p>
                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 my-4 rounded-r">
                    <h4 class="text-yellow-800 font-bold m-0">ğŸ’¾ é‡è¦ï¼šé—œæ–¼è³‡æ–™ä¿å­˜èˆ‡å‚™ä»½ï¼ˆå¿…è®€ï¼ï¼‰</h4>
                    <p class="text-sm text-yellow-700 mt-2">é€™æ˜¯æœ¬ç«™æœ€é‡è¦çš„éƒ¨åˆ†ã€‚ç‚ºäº†ä¿è­·æ‚¨çš„éš±ç§ï¼Œæœ¬ç«™æ¡ç”¨ <strong>ã€Œæœ¬åœ°å„²å­˜ (Local Storage)ã€</strong> æŠ€è¡“ã€‚</p>
                </div>
                <h3>1. è³‡æ–™å­˜åœ¨å“ªè£¡ï¼Ÿ</h3>
                <p>æ‚¨å¯«ä¸‹çš„æ¯ä¸€å€‹å­—ï¼ˆéˆä¿®ç­†è¨˜ã€å­˜éŒ¢ç´€éŒ„ã€é¡˜æœ›æ¸…å–®ï¼‰ï¼Œéƒ½ç›´æ¥å„²å­˜åœ¨æ‚¨ <strong>ç›®å‰ä½¿ç”¨çš„é€™å°è£ç½®ï¼ˆæ‰‹æ©Ÿæˆ–é›»è…¦ï¼‰çš„ç€è¦½å™¨å…§éƒ¨</strong>ï¼Œæˆ‘å€‘ä¸æœƒï¼ˆä¹Ÿç„¡æ³•ï¼‰å°‡è³‡æ–™ä¸Šå‚³åˆ°ä»»ä½•é›²ç«¯ä¼ºæœå™¨ã€‚</p>
                <h3>2. ä»€éº¼æƒ…æ³ä¸‹è³‡æ–™æœƒä¸è¦‹ï¼Ÿ</h3>
                <p>ç”±æ–¼è³‡æ–™å­˜æ”¾åœ¨ç€è¦½å™¨å…§ï¼Œä»¥ä¸‹æƒ…æ³æœƒå°è‡´æ‚¨çš„ç´€éŒ„æ¶ˆå¤±ï¼š</p>
                <ul class="list-disc pl-5 space-y-1">
                    <li><strong>æ¸…é™¤ç€è¦½å™¨ç´€éŒ„</strong>ï¼šè‹¥æ‰‹å‹•æ¸…é™¤äº†ã€ŒCookieã€æˆ–ã€Œå¿«å–è³‡æ–™ã€ï¼Œè³‡æ–™æœƒè¢«åˆªé™¤ã€‚</li>
                    <li><strong>ä½¿ç”¨ç„¡ç—•æ¨¡å¼ (Incognito)</strong>ï¼šç„¡ç—•è¦–çª—é—œé–‰å¾Œï¼Œæ‰€æœ‰è³‡æ–™æœƒè‡ªå‹•éŠ·æ¯€ã€‚</li>
                    <li><strong>æ›´æ›è£ç½®æˆ–ç€è¦½å™¨</strong>ï¼šæ‰‹æ©Ÿ Chrome çš„è³‡æ–™ï¼Œç„¡æ³•åœ¨é›»è…¦ Chrome æˆ–æ‰‹æ©Ÿ Safari ä¸Šçœ‹åˆ°ã€‚</li>
                    <li><strong>æ‰‹æ©Ÿé‡ç½®</strong>ï¼šæ¢å¾©åŸå» è¨­å®šå¾Œï¼Œè³‡æ–™æœƒæ¶ˆå¤±ã€‚</li>
                </ul>
                <h3>3. å¦‚ä½•æ°¸ä¹…ä¿å­˜ï¼Ÿï¼ˆå¼·çƒˆå»ºè­°ï¼‰</h3>
                <p>æˆ‘å€‘æä¾›äº†å…©ç¨®å±¤ç´šçš„ä¿å­˜æ–¹å¼ï¼Œå»ºè­°æ‚¨é¤Šæˆå¥½ç¿’æ…£ï¼š</p>
                <h4>A. å…¨ç«™è³‡æ–™å‚™ä»½ï¼ˆæ›æ‰‹æ©Ÿå¿…ç”¨ï¼‰</h4>
                <p>ä½æ–¼ <strong>ã€Œé¦–é ã€</strong> æœ€ä¸‹æ–¹çš„ <strong>ã€ŒğŸ”’ è³‡æ–™ä¿éšªç®±ã€</strong>ã€‚</p>
                <ul class="list-disc pl-5 space-y-1">
                    <li><strong>ğŸ“¤ åŒ¯å‡ºå‚™ä»½</strong>ï¼šé»æ“Šå¾Œæœƒä¸‹è¼‰ä¸€å€‹ <code>.json</code> æª”æ¡ˆã€‚é€™åŒ…å«äº†æ‚¨åœ¨ç¶²ç«™ä¸Šçš„ <strong>æ‰€æœ‰ç´€éŒ„</strong>ã€‚è«‹å°‡æ­¤æª”æ¡ˆå¦¥å–„ä¿å­˜åœ¨é›²ç«¯ç¡¬ç¢Ÿæˆ– Email ä¸­ã€‚</li>
                    <li><strong>ğŸ“¥ åŒ¯å…¥å‚™ä»½</strong>ï¼šç•¶æ‚¨æ›æ–°æ‰‹æ©Ÿæˆ–ä¸å°å¿ƒæ¸…ç©ºè³‡æ–™æ™‚ï¼Œè¼‰å…¥é€™å€‹æª”æ¡ˆå³å¯é‚„åŸã€‚</li>
                </ul>
                <h4>B. å–®æ—¥éˆä¿®åˆ†äº«ï¼ˆæ¯æ—¥ç”¨ï¼‰</h4>
                <p>ä½æ–¼ <strong>ã€Œé†ƒæ¼¬é¹¹é­šï¼ˆéˆä¿®ï¼‰ã€</strong> é é¢çš„ç­†è¨˜å€ã€‚</p>
                <ul class="list-disc pl-5 space-y-1">
                    <li><strong>ä¸‹è¼‰</strong>ï¼šå°‡ç•¶å¤©çš„ç¶“æ–‡ã€é ˜å—èˆ‡ç¦±å‘Šæ•´ç†æˆæ–‡å­—æª”ä¸‹è¼‰ã€‚</li>
                    <li><strong>åˆ†äº«</strong>ï¼šæ‰‹æ©Ÿç‰ˆå¯ç›´æ¥å–šèµ·ç³»çµ±é¸å–®ï¼ˆå­˜å…¥ Keepã€å‚™å¿˜éŒ„ï¼‰ï¼›é›»è…¦ç‰ˆå‰‡æœƒè‡ªå‹•è¤‡è£½å…¨æ–‡ï¼Œæ–¹ä¾¿æ‚¨è²¼åˆ°ç¿’æ…£çš„ç­†è¨˜è»Ÿé«”ã€‚</li>
                </ul>
            </div>
            
            <div class="mt-6 text-center">
                <button onclick="closeHelpModal()" class="bg-[#A68C76] text-white px-6 py-2 rounded-full hover:bg-[#8e7662] transition-colors">æˆ‘çŸ¥é“äº†</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"><span>å·²æˆåŠŸè¤‡è£½åˆ°éˆé­‚æ·±è™•</span></div>

    <script>
        // --- æ ¸å¿ƒè³‡æ–™ ---
        const bibleBooks = [
            { name: "å‰µä¸–è¨˜", abbr: "å‰µ", code: "GEN", chapters: 50, type: 1 }, { name: "å‡ºåŸƒåŠè¨˜", abbr: "å‡º", code: "EXO", chapters: 40, type: 1 }, 
            { name: "åˆ©æœªè¨˜", abbr: "åˆ©", code: "LEV", chapters: 27, type: 1 }, { name: "æ°‘æ•¸è¨˜", abbr: "æ°‘", code: "NUM", chapters: 36, type: 1 },
            { name: "ç”³å‘½è¨˜", abbr: "ç”³", code: "DEU", chapters: 34, type: 1 }, { name: "ç´„æ›¸äºè¨˜", abbr: "æ›¸", code: "JOS", chapters: 24, type: 1 },
            { name: "å£«å¸«è¨˜", abbr: "å£«", code: "JDG", chapters: 21, type: 1 }, { name: "è·¯å¾—è¨˜", abbr: "å¾—", code: "RUT", chapters: 4, type: 1 },
            { name: "æ’’æ¯è€³è¨˜ä¸Š", abbr: "æ’’ä¸Š", code: "1SA", chapters: 31, type: 1 }, { name: "æ’’æ¯è€³è¨˜ä¸‹", abbr: "æ’’ä¸‹", code: "2SA", chapters: 24, type: 1 },
            { name: "åˆ—ç‹ç´€ä¸Š", abbr: "ç‹ä¸Š", code: "1KI", chapters: 22, type: 1 }, { name: "åˆ—ç‹ç´€ä¸‹", abbr: "ç‹ä¸‹", code: "2KI", chapters: 25, type: 1 },
            { name: "æ­·ä»£å¿—ä¸Š", abbr: "ä»£ä¸Š", code: "1CH", chapters: 29, type: 1 }, { name: "æ­·ä»£å¿—ä¸‹", abbr: "ä»£ä¸‹", code: "2CH", chapters: 36, type: 1 },
            { name: "ä»¥æ–¯æ‹‰è¨˜", abbr: "æ‹‰", code: "EZR", chapters: 10, type: 1 }, { name: "å°¼å¸Œç±³è¨˜", abbr: "å°¼", code: "NEH", chapters: 13, type: 1 },
            { name: "ä»¥æ–¯å¸–è¨˜", abbr: "æ–¯", code: "EST", chapters: 10, type: 1 }, { name: "ç´„ä¼¯è¨˜", abbr: "ä¼¯", code: "JOB", chapters: 42, type: 1 },
            { name: "è©©ç¯‡", abbr: "è©©", code: "PSA", chapters: 150, type: 3 }, { name: "ç®´è¨€", abbr: "ç®´", code: "PRO", chapters: 31, type: 4 },
            { name: "å‚³é“æ›¸", abbr: "å‚³", code: "ECC", chapters: 12, type: 1 }, { name: "é›…æ­Œ", abbr: "æ­Œ", code: "SNG", chapters: 8, type: 1 },
            { name: "ä»¥è³½äºæ›¸", abbr: "è³½", code: "ISA", chapters: 66, type: 1 }, { name: "è€¶åˆ©ç±³æ›¸", abbr: "è€¶", code: "JER", chapters: 52, type: 1 },
            { name: "è€¶åˆ©ç±³å“€æ­Œ", abbr: "å“€", code: "LAM", chapters: 5, type: 1 }, { name: "ä»¥è¥¿çµæ›¸", abbr: "çµ", code: "EZE", chapters: 48, type: 1 },
            { name: "ä½†ä»¥ç†æ›¸", abbr: "ä½†", code: "DAN", chapters: 12, type: 1 }, { name: "ä½•è¥¿é˜¿æ›¸", abbr: "ä½•", code: "HOS", chapters: 14, type: 1 },
            { name: "ç´„ç¥æ›¸", abbr: "ç¥", code: "JOL", chapters: 3, type: 1 }, { name: "é˜¿æ‘©å¸æ›¸", abbr: "æ‘©", code: "AMO", chapters: 9, type: 1 },
            { name: "ä¿„å·´åº•äºæ›¸", abbr: "ä¿„", code: "OBA", chapters: 1, type: 1 }, { name: "ç´„æ‹¿æ›¸", abbr: "æ‹¿", code: "JON", chapters: 4, type: 1 },
            { name: "å½Œè¿¦æ›¸", abbr: "å½Œ", code: "MIC", chapters: 7, type: 1 }, { name: "é‚£é´»æ›¸", abbr: "é´»", code: "NAM", chapters: 3, type: 1 },
            { name: "å“ˆå·´è°·æ›¸", abbr: "å“ˆ", code: "HAB", chapters: 3, type: 1 }, { name: "è¥¿ç•ªé›…æ›¸", abbr: "ç•ª", code: "ZEP", chapters: 3, type: 1 },
            { name: "å“ˆè©²æ›¸", abbr: "è©²", code: "HAG", chapters: 2, type: 1 }, { name: "æ’’è¿¦åˆ©äºæ›¸", abbr: "äº", code: "ZEC", chapters: 14, type: 1 },
            { name: "ç‘ªæ‹‰åŸºæ›¸", abbr: "ç‘ª", code: "MAL", chapters: 4, type: 1 }, 
            { name: "é¦¬å¤ªç¦éŸ³", abbr: "å¤ª", code: "MAT", chapters: 28, type: 2 }, { name: "é¦¬å¯ç¦éŸ³", abbr: "å¯", code: "MRK", chapters: 16, type: 2 }, 
            { name: "è·¯åŠ ç¦éŸ³", abbr: "è·¯", code: "LUK", chapters: 24, type: 2 }, { name: "ç´„ç¿°ç¦éŸ³", abbr: "ç´„", code: "JHN", chapters: 21, type: 2 }, 
            { name: "ä½¿å¾’è¡Œå‚³", abbr: "å¾’", code: "ACT", chapters: 28, type: 2 }, { name: "ç¾…é¦¬æ›¸", abbr: "ç¾…", code: "ROM", chapters: 16, type: 2 }, 
            { name: "å“¥æ—å¤šå‰æ›¸", abbr: "æ—å‰", code: "1CO", chapters: 16, type: 2 }, { name: "å“¥æ—å¤šå¾Œæ›¸", abbr: "æ—å¾Œ", code: "2CO", chapters: 13, type: 2 }, 
            { name: "åŠ æ‹‰å¤ªæ›¸", abbr: "åŠ ", code: "GAL", chapters: 6, type: 2 }, { name: "ä»¥å¼—æ‰€æ›¸", abbr: "å¼—", code: "EPH", chapters: 6, type: 2 }, 
            { name: "è…“ç«‹æ¯”æ›¸", abbr: "è…“", code: "PHP", chapters: 4, type: 2 }, { name: "æ­Œç¾…è¥¿æ›¸", abbr: "è¥¿", code: "COL", chapters: 4, type: 2 }, 
            { name: "å¸–æ’’ç¾…å°¼è¿¦å‰æ›¸", abbr: "å¸–å‰", code: "1TH", chapters: 5, type: 2 }, { name: "å¸–æ’’ç¾…å°¼è¿¦å¾Œæ›¸", abbr: "å¸–å¾Œ", code: "2TH", chapters: 3, type: 2 }, 
            { name: "ææ‘©å¤ªå‰æ›¸", abbr: "æå‰", code: "1TI", chapters: 6, type: 2 }, { name: "ææ‘©å¤ªå¾Œæ›¸", abbr: "æå¾Œ", code: "2TI", chapters: 4, type: 2 }, 
            { name: "æå¤šæ›¸", abbr: "å¤š", code: "TIT", chapters: 3, type: 2 }, { name: "è…“åˆ©é–€æ›¸", abbr: "é–€", code: "PHM", chapters: 1, type: 2 }, 
            { name: "å¸Œä¼¯ä¾†æ›¸", abbr: "ä¾†", code: "HEB", chapters: 13, type: 2 }, { name: "é›…å„æ›¸", abbr: "é›…", code: "JAS", chapters: 5, type: 2 }, 
            { name: "å½¼å¾—å‰æ›¸", abbr: "å½¼å‰", code: "1PE", chapters: 5, type: 2 }, { name: "å½¼å¾—å¾Œæ›¸", abbr: "å½¼å¾Œ", code: "2PE", chapters: 3, type: 2 }, 
            { name: "ç´„ç¿°ä¸€æ›¸", abbr: "ç´„ä¸€", code: "1JN", chapters: 5, type: 2 }, { name: "ç´„ç¿°äºŒæ›¸", abbr: "ç´„äºŒ", code: "2JN", chapters: 1, type: 2 }, 
            { name: "ç´„ç¿°ä¸‰æ›¸", abbr: "ç´„ä¸‰", code: "3JN", chapters: 1, type: 2 }, { name: "çŒ¶å¤§æ›¸", abbr: "çŒ¶", code: "JUD", chapters: 1, type: 2 }, 
            { name: "å•Ÿç¤ºéŒ„", abbr: "å•Ÿ", code: "REV", chapters: 22, type: 2 }
        ];

        const encouragements = ["ä¸è¦æ€•ï¼Œåªè¦ä¿¡ã€‚", "ä½ çš„ç¦±å‘Šï¼Œç¥éƒ½è½è¦‹äº†ã€‚", "æ‚£é›£ç”Ÿå¿è€ï¼Œå¿è€ç”Ÿè€ç·´ã€‚", "æ„›æ˜¯æ°¸ä¸æ­¢æ¯ã€‚", "å‡¡äº‹äº’ç›¸æ•ˆåŠ›ï¼Œå«æ„›ç¥çš„äººå¾—ç›Šè™•ã€‚", "é è‘—é‚£åŠ çµ¦æˆ‘åŠ›é‡çš„ï¼Œå‡¡äº‹éƒ½èƒ½åšã€‚", "å–œæ¨‚çš„å¿ƒä¹ƒæ˜¯è‰¯è—¥ã€‚", "å°±åœ¨ä»Šå¤©ï¼Œæ©å…¸å¤ ä½ ç”¨ã€‚", "å …æŒä¸‹å»ï¼Œç¥çš„æ™‚é–“æœ€å®Œç¾ã€‚"];
        const financialEncouragements = ["ç©å°‘æˆå¤šï¼Œä¸Šå¸çš„ä¾›æ‡‰ä¹Ÿæ˜¯å¦‚æ­¤ã€‚", "ä½ çš„æ¯ä¸€å€‹éŠ…æ¿ï¼Œéƒ½æ˜¯å°æœªä¾†çš„ä¿¡å¿ƒã€‚", "ä¸è¦ç‚ºæ˜å¤©æ†‚æ…®ï¼Œå› ç‚ºæ˜å¤©è‡ªæœ‰æ˜å¤©çš„æ†‚æ…®ã€‚", "è€¶å’Œè¯ä»¥å‹’ï¼Œç¥‚å¿…æœ‰é å‚™ã€‚", "ç†è²¡ä¹Ÿæ˜¯ä¸€ç¨®ç®¡å®¶è·åˆ†ï¼Œä½ åšå¾—å¾ˆå¥½ï¼", "å“ªæ€•åªæ˜¯å­˜ä¸‹ä¸€å¡ŠéŒ¢ï¼Œä¹Ÿæ˜¯å‘å¤¢æƒ³é è¿‘çš„ä¸€æ­¥ã€‚", "å¯Œè¶³ä¸åœ¨æ–¼æ“æœ‰å¤šå°‘ï¼Œè€Œåœ¨æ–¼çŸ¥è¶³ã€‚", "ç¨®ä»€éº¼æ”¶ä»€éº¼ï¼Œç¾åœ¨çš„å„²è“„æ˜¯æœªä¾†æ”¶æˆã€‚", "ä½ ç®¡ç†é‡‘éŒ¢çš„æ–¹å¼ï¼Œåæ˜ äº†ä½ å°ä¸Šå¸çš„ä¿¡é ã€‚", "éŒ¢æ˜¯åƒ•äººï¼Œä¸æ˜¯ä¸»äººã€‚è®“å®ƒç‚ºæ„›ç¥æ„›äººæ•ˆåŠ›ã€‚"];
        const keywords = ["çªç ´", "å®‰æ¯", "é‡å»º", "è±ç››", "å‹‡æ°£", "å–œæ¨‚", "å°ˆæ³¨", "è¬™å‘", "ä¿¡å¿ƒ", "æ„›", "æ™ºæ…§", "è€å¿ƒ", "æ›´æ–°", "æ„Ÿæ©", "å¿ å¿ƒ"];
        
        let onlineSaltStatusMap = [], onlinePreservativePool = [], onlineFlipQuotes = [], dailyQuotesPool = [];
        const saltStatusMap = [{ min: 0, max: 10, title: "å«é¹½é‡ 5%ï¼šæ–°é®®æ·¡æ°´é­š", desc: "è­¦å‘Šï¼šä½ å¤ªæ–°é®®äº†ï¼Œå®Œå…¨æ²’æœ‰é†ƒæ¼¬ç—•è·¡ã€‚å»ºè­°ç«‹åˆ»å»è½é¦–è©©æ­Œå£“å£“é©šã€‚" }, { min: 11, max: 30, title: "å«é¹½é‡ 20%ï¼šå¾®é¹¹å°é®®è‚‰", desc: "å¾®é¹¹ã€‚å¤§æ¦‚å°±æ˜¯è–¯æ¢å¿˜è¨˜åŠ é¹½çš„ç¨‹åº¦ï¼Œå±¬éˆå‘³é“æ·¡å¦‚æ°´ã€‚" }, { min: 31, max: 60, title: "å«é¹½é‡ 50%ï¼šå…¥å‘³æ¨™æº–æ¬¾", desc: "é†ƒæ¼¬å¾—æ°åˆ°å¥½è™•ï¼æœ‰å±¬éˆçš„æ°£è³ªï¼Œä¹Ÿæœ‰å±¬ä¸–çš„å¿«æ¨‚ï¼Œç”Ÿæ´»åœ¨æ©å…¸çš„å¹³è¡¡é»ã€‚" }, { min: 61, max: 90, title: "å«é¹½é‡ 80%ï¼šè³‡æ·±è€é¹¹é­š", desc: "å¤ªè–æ½”äº†ï¼ä½ ç¾åœ¨æ•£ç™¼å‡ºçš„é¹½å‘³è¶³ä»¥è®“å‘¨åœçš„é­”é¬¼æ„Ÿåˆ°ä¹¾æ¸´é›£è€ã€‚" }, { min: 91, max: 100, title: "å«é¹½é‡ 99%ï¼šå±¬éˆæ ¸å½ˆ", desc: "ä½ å·²ç¶“ä¸æ˜¯é¹¹é­šäº†ï¼Œä½ æ˜¯é¹½æœ¬èº«ã€‚è«‹å–æ¯çå¥¶å¹³è¡¡ä¸€ä¸‹å¤ªéç¥è–çš„é«”è³ªã€‚" }];
        let preservativePool = [{ tMin: 0, tMax: 30, content: "ä½ æ˜¯ç¥çœ¼ä¸­çš„ç³äººï¼Œå°±ç®—ä½ ç¾åœ¨åªæ˜¯æ¢å»¢é­šï¼Œä¹Ÿæ˜¯æœ€è²´çš„é‚£æ¢ã€‚" }, { tMin: 0, tMax: 50, content: "æ·±å‘¼å¸ï¼Œå¤©å¡Œä¸‹ä¾†æœ‰è€¶ç©Œé ‚è‘—ï¼Œä½ è² è²¬èººå¹³é ˜å—æ©å…¸å°±å¥½ã€‚" }, { tMin: 0, tMax: 100, content: "ä¸è«–ä½ ä»Šå¤©å¹¾åº¦ï¼Œç¥æ„›ä½ çš„ç¨‹åº¦å§‹çµ‚æ˜¯ 100%ï¼Œé€™æ‰æ˜¯æœ€çŒ›çš„é˜²è…åŠ‘ã€‚" }];
        const quotes = [{ text: "å‡¡å‹è‹¦æ“”é‡æ“”çš„äººå¯ä»¥åˆ°æˆ‘é€™è£¡ä¾†ï¼Œæˆ‘å°±ä½¿ä½ å€‘å¾—å®‰æ¯ã€‚", source: "é¦¬å¤ªç¦éŸ³ 11:28", comment: "(é¹¹é­šä¸»å»šçš„ç¥•æ–¹ï¼šå¿«å»ç¡ï¼Œåˆ¥å†æ»‘æ‰‹æ©Ÿäº†)" }, { text: "ä½ å€‘è¦ä¼‘æ¯ï¼Œè¦çŸ¥é“æˆ‘æ˜¯ç¥ã€‚", source: "è©©ç¯‡ 46:10", comment: "(é¹¹é­šä¸»å»šçš„ç¥•æ–¹ï¼šè½è©±ï¼Œç¾åœ¨å°±å»èººå¹³ï¼Œå‰©ä¸‹çš„äº¤çµ¦è€é—†)" }, { text: "å–œæ¨‚çš„å¿ƒä¹ƒæ˜¯è‰¯è—¥ï¼Œæ†‚å‚·çš„éˆä½¿éª¨æ¯ä¹¾ã€‚", source: "ç®´è¨€ 17:22", comment: "(é¹¹é­šä¸»å»šçš„ç¥•æ–¹ï¼šå¿ƒæƒ…å¥½æœ€é‡è¦ï¼Œå³ä½¿ä½ åªæ˜¯ä¸€æ¢é¹¹é­š)" }];
        const puaTestItems = [
            { text: "ä½ ä¸é †æœå°±æ˜¯ä¸è’™ç¦", weight: 1 },
            { text: "é€™æ˜¯åœ¨è¨“ç·´ä½ çš„ä¿¡å¿ƒ/ç ´ç¢è€æˆ‘", weight: 2 },
            { text: "ä¸å¯è§¸æ‘¸/è³ªç–‘å—è†è€…", weight: 3 },
            { text: "é€™æ˜¯é­”é¬¼çš„æ”»æ“Š", weight: 1 },
            { text: "é›¢é–‹é€™é–“æ•™æœƒä½ å°±æ²’é®è“‹äº†", weight: 3 },
            { text: "è–éˆæ„Ÿå‹•æˆ‘å«ä½ åšé€™ä»¶äº‹", weight: 2 },
            { text: "ä½ è¦æŠŠä½ çš„ä»¥æ’’(æœ€æ„›çš„)ç»ä¸Š", weight: 3 }
        ];
        
        let puaData = {
            love: { sentence: "ä½ ä¸æœäº‹/ä¸èšæœƒ å°±æ˜¯ä¸æ„›ä¸»ï¼", trans: "æˆ‘éœ€è¦å…è²»å‹å‹•åŠ›ä¾†å¡«è£œè·ç¼ºï¼Œè«‹ä¸è¦è®“æˆ‘é›£åšäººã€‚", defenses: ["ç¥çš„æ„›æ˜¯ç„¡æ¢ä»¶çš„ã€‚æˆ‘çš„ä¼‘æ¯ä¹Ÿæ˜¯ä¸€ç¨®æ•¬æ‹œã€‚", "é¦¬åˆ©äºé¸æ“‡äº†ä¸Šå¥½çš„ç¦åˆ†(èººå¹³)ï¼Œæ˜¯ä¸æœƒè¢«å¥ªå»çš„ã€‚"], level: "â­â­â­" },
            submit: { sentence: "ä½ è¦é †æœæ¬ŠæŸ„ï¼Œä¸è¦å•ç‚ºä»€éº¼ã€‚", trans: "é–‰å˜´ï¼Œè½æˆ‘çš„å°±å¥½ã€‚æˆ‘ä¸æƒ³è§£é‡‹ï¼Œä¹Ÿä¸æƒ³è¢«æŒ‘æˆ°ã€‚", defenses: ["é †æœç¥å¤§æ–¼é †æœäººã€‚ç›²å¾çµ•å°ä¸æ˜¯é †æœã€‚", "æˆ‘ä¹Ÿåœ¨é †æœç¥çµ¦æˆ‘çš„æ„Ÿå‹•ï¼šç¾åœ¨å…ˆä¸è¦ã€‚"], level: "â­â­â­â­" },
            touch: { sentence: "ä¸å¯è§¸æ‘¸è€¶å’Œè¯çš„å—è†è€…ï¼", trans: "æˆ‘æ˜¯ç‰¹æ¬Šéšç´šï¼Œæˆ‘æœ‰ç¥è–è±å…æ¬Šï¼Œä½ ä¸èƒ½è³ªç–‘æˆ‘çš„éŒ¯èª¤ã€‚", defenses: ["çœŸç†è¶Šè¾¯è¶Šæ˜ã€‚å¦‚æœæ€•è¢«æ‘¸ï¼Œæ˜¯ä¸æ˜¯è£¡é¢æœ‰é¬¼ï¼Ÿ", "æˆ‘å€‘éƒ½æ˜¯å›å°Šçš„ç¥­å¸ï¼Œå¤§å®¶éƒ½æ˜¯å—è†è€…ï¼Œè«‹å¹³ç­‰å°è©±ã€‚"], level: "â­â­â­â­â­" },
            vision: { sentence: "ä½ è¦æœ‰åœ‹åº¦è§€ï¼", trans: "åˆ¥è¨ˆè¼ƒé‚£éº¼å¤šï¼Œåæ­£è³‡æºéƒ½è¦çµ¦æˆ‘ç”¨ã€‚", defenses: ["æˆ‘çš„åœ‹åº¦è§€åŒ…å«ç…§é¡§å¥½ç¥çµ¦æˆ‘çš„èº«é«”èˆ‡å®¶åº­ã€‚", "ä¸Šå¸çš„åœ‹åº¦ä¹ŸåŒ…å«å…¬ç¾©èˆ‡åˆç†çš„åˆ†å·¥ã€‚"], level: "â­â­" },
            family: { sentence: "æˆ‘å€‘æ˜¯æ„›çš„å¤§å®¶åº­ã€‚", trans: "æ‰€ä»¥ä½ ä¸èƒ½æœ‰ç•Œç·šï¼Œè¦æŠŠè‡ªå·±ç‡ƒç‡’æ®†ç›¡ã€‚", defenses: ["å®¶æ˜¯æœ‰æ„›çš„åœ°æ–¹ï¼Œä¸æ˜¯å‹’ç´¢çš„åœ°æ–¹ã€‚", "å¥åº·çš„å®¶åº­æœƒæœ‰å¥åº·çš„ç•Œç·šã€‚"], level: "â­â­â­" },
            offering: { sentence: "ä¿¡å¿ƒå¥‰ç»ï¼Œä¸Šå¸å¿…åŠ å€å¥‰é‚„ã€‚", trans: "æˆ‘å€‘çš„é ç®—ç¼ºå£å¾ˆå¤§ï¼Œè«‹ä½ æéŒ¢ã€‚", defenses: ["å¥‰ç»æ˜¯ç”˜å¿ƒæ¨‚æ„ï¼Œä¸æ˜¯æŠ•è³‡ç†è²¡ã€‚", "æˆ‘çš„ä¿¡å¿ƒå»ºç«‹åœ¨ç¥çš„è©±èªï¼Œä¸æ˜¯é‡‘éŒ¢äº¤æ›ã€‚"], level: "â­â­â­â­" }
        };

        const emotionCategories = {
            pos: ["å–œæ¨‚", "æ„Ÿæ©", "å¹³å®‰", "èˆˆå¥®", "æ»¿è¶³", "è¢«æ„›", "æœŸå¾…", "é‡‹æ”¾", "å‹‡æ•¢", "è‡ªä¿¡", "è¼•é¬†", "æ„‰æ‚…", "å—å°Šæ¦®", "è¦ªå¯†", "å……æ»¿å¸Œæœ›", "è¢«æ¥ç´", "å¯§éœ", "å¯¬æ•", "è‡ªç”±", "æ´»æ½‘", "è¢«ç†è§£", "å—æ„Ÿå‹•"],
            neu: ["å¹³éœ", "å¥½å¥‡", "é©šè¨", "å›°æƒ‘", "å¿™ç¢Œ", "ç–²æ†Š", "æ”¾ç©º", "æ²‰æ€", "ç„¡æ„Ÿ", "çŸ›ç›¾", "å°·å°¬", "çŒ¶è±«", "ç·Šç¹ƒ", "æ•æ„Ÿ", "è„†å¼±", "éœ‡é©š", "éº»æœ¨", "ç–é›¢", "è­¦è¦º", "ä¸çŸ¥æ‰€æª"],
            neg: ["ç”Ÿæ°£", "é›£é", "ç„¦æ…®", "ææ‡¼", "ç¾æ„§", "å…§ç–š", "å­¤å–®", "å¤±æœ›", "å«‰å¦’", "ç…©èº", "å§”å±ˆ", "ç„¡åŠ©", "çµ•æœ›", "å£“åŠ›", "æ†¤æ€’", "å­æƒ¡", "ç—›è‹¦", "å“€å‚·", "éºæ†¾", "ä¸å®‰", "æŒ«æŠ˜", "æ‡·ç–‘", "è¢«æ‹’çµ•", "çª’æ¯", "å¾Œæ‚”", "è‡ªå‘"]
        };

        const shields = { marriage: ["æˆ‘åœ¨ç­‰å€™ç¥æ‰€é å‚™çš„äºç•¶/å¤å¨ƒï¼Œé€™äº‹æ€¥ä¸å¾—ã€‚", "ä¿ç¾…èªªå®ˆç´ å®‰å¸¸ä¹Ÿæ˜¯å¥½çš„ã€‚"], salary: ["ç©è²¡å¯¶åœ¨å¤©ä¸Šï¼Œåœ°åœ°ä¸Šåœ°çš„æ•¸å­—å¦‚æµ®é›²ã€‚", "è€¶å’Œè¯ä»¥å‹’å¿…æœ‰é å‚™ã€‚"], serve: ["é€™é™£å­ç¥å¸¶é ˜æˆ‘é€²å…¥æ› é‡å­¸ç¿’å®‰éœçš„åŠŸèª²ã€‚", "æˆ‘åœ¨èª¿æ•´å±¬éˆçš„æ­¥ä¼ã€‚"] };

        let biblePlan = [];
        let prayers = [], goals = [], userSignals = [], savingsPlan = [], wishlist = [];
        let futureLetters = []; // Letters array
        let yearlyKeyword = '';
        let currentPuaSelection = null, currentShieldSelection = null, currentSaltPercent = 0;
        let currentFullText = ""; // ç”¨æ–¼è¤‡è£½åŠŸèƒ½
        let selectedVerses = new Set(); // Store indices or IDs of selected verses
        let onlinePuaChecklist = []; // ç·šä¸Šé¡Œåº«
        let currentDirectoryTab = 'ot'; // 'ot' or 'nt'
        let readerPreviousSection = 'home'; // æ–°å¢ï¼šè¨˜éŒ„é–±è®€å‰çš„é é¢

        // --- Helper Functions ---
        function stripHtml(html) {
           return html.replace(/<[^>]*>?/gm, '');
        }

        async function fetchAndParseCSV(gid) {
            const sheetId = '2PACX-1vSdgi7Fr-SIVYoVShmmXsGD_ZSYC-nPNaWyp42Haii8fdGtKkLS6jDJ1bPXWyEnknDStJgEkI3WrrYy';
            const url = `https://docs.google.com/spreadsheets/d/e/${sheetId}/pub?gid=${gid}&single=true&output=csv`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network error');
                const csvText = await response.text();
                if (csvText.startsWith('<!doctype html')) throw new Error('HTML received');
                const rows = csvText.split(/\r?\n/);
                if (rows.length === 0) return [];
                const parseCSVLine = (line) => {
                    const cols = []; let inQuote = false; let currentVal = '';
                    for(let j=0; j<line.length; j++) {
                        const char = line[j];
                        if(char === '"') inQuote = !inQuote;
                        else if(char === ',' && !inQuote) { cols.push(currentVal); currentVal = ''; } else currentVal += char;
                    }
                    cols.push(currentVal);
                    return cols.map(c => c.trim().replace(/^"|"$/g, '').replace(/""/g, '"'));
                };
                const headers = parseCSVLine(rows[0]).map(h => h.trim().toLowerCase().replace(/^\ufeff/, ''));
                return { headers, rows: rows.slice(1), parser: parseCSVLine };
            } catch (error) { return null; }
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.querySelector('span').innerText = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function saveToStorage(key, value) {
            try { localStorage.setItem(key, value); } 
            catch (e) { showToast('âš ï¸ å„²å­˜å¤±æ•—ï¼šç©ºé–“ä¸è¶³æˆ–è¨­å®šå•é¡Œ'); }
        }

        function generateAppIcons() {
            const canvas = document.createElement('canvas'); canvas.width = 512; canvas.height = 512;
            const ctx = canvas.getContext('2d'); ctx.fillStyle = '#7CA1B3'; ctx.fillRect(0, 0, 512, 512);
            const svgString = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><path d="M100 80 C 150 80, 180 110, 180 130 C 180 150, 150 170, 100 170 C 50 170, 20 150, 20 130 C 20 110, 50 80, 100 80 Z" fill="#FFFFFF"/><path d="M180 130 L 200 110 L 200 150 Z" fill="#FFFFFF"/><ellipse cx="60" cy="135" rx="10" ry="6" fill='%23FFAB91' opacity='1'/><ellipse cx="140" cy="135" rx="10" ry="6" fill='%23FFAB91' opacity='1'/><g stroke='%237CA1B3' stroke-width='5' stroke-linecap='round'><line x1='75' y1='112' x2='75' y2='128'/><line x1='69' y1='118' x2='81' y2='118'/><line x1='125' y1='112' x2='125' y2='128'/><line x1='119' y1='118' x2='131' y2='118'/></g><line x1='95' y1='145' x2='105' y2='145' stroke='%237CA1B3' stroke-width='5' stroke-linecap='round'/><ellipse cx='100' cy='50' rx='60' ry='10' fill='none' stroke='%23D4B483' stroke-width='5'/></svg>`;
            const img = new Image(); img.src = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svgString);
            img.onload = function() { ctx.drawImage(img, 56, 56, 400, 400); const pngUrl = canvas.toDataURL('image/png'); const favLink = document.getElementById('favicon-link'); const appleLink = document.getElementById('apple-icon-link'); if(favLink) favLink.href = pngUrl; if(appleLink) appleLink.href = pngUrl; };
        }

        // --- è®€ç¶“è¨ˆç•«ç”Ÿæˆ ---
        function generateBiblePlan() {
            let plan = [];
            const otBooks = bibleBooks.filter(b => b.type === 1);
            const ntBooks = bibleBooks.filter(b => b.type === 2);
            const psBooks = bibleBooks.filter(b => b.type === 3); 
            
            let pointers = {
                ot: { bookIdx: 0, chap: 1, rate: 2.05, acc: 0 },
                nt: { bookIdx: 0, chap: 1, rate: 1, acc: 0, loop: true },
                ps: { bookIdx: 0, chap: 1, rate: 1, acc: 0, loop: true }
            };

            const getReadingForTrack = (trackName, books) => {
                let p = pointers[trackName];
                if (!p.loop && p.bookIdx >= books.length) return null; 
                p.acc += p.rate;
                let chaptersToRead = Math.floor(p.acc);
                if (p.loop && chaptersToRead < 1) chaptersToRead = 1;
                if (plan.length === 0 && chaptersToRead === 0 && trackName === 'ot') chaptersToRead = 1;
                if (chaptersToRead === 0) return null;
                p.acc -= chaptersToRead;
                
                let currentBook = null; 
                let readings = [];
                let startChap = p.chap;
                
                if (p.loop && p.bookIdx >= books.length) { p.bookIdx = 0; p.chap = 1; startChap = 1; }
                
                if (p.bookIdx < books.length) {
                    currentBook = books[p.bookIdx];
                }

                for (let i = 0; i < chaptersToRead; i++) {
                    if (p.bookIdx >= books.length) {
                        if (p.loop) { p.bookIdx = 0; p.chap = 1; startChap = 1; currentBook = books[0]; }
                        else break;
                    }
                    currentBook = books[p.bookIdx];
                    p.chap++;
                    if (p.chap > currentBook.chapters) {
                        readings.push({ book: currentBook, start: startChap, end: currentBook.chapters });
                        p.bookIdx++;
                        p.chap = 1;
                        if (p.bookIdx < books.length) { currentBook = books[p.bookIdx]; startChap = 1; }
                        else if (p.loop) { currentBook = books[0]; startChap = 1; }
                    }
                }
                if (p.chap > startChap && currentBook) readings.push({ book: currentBook, start: startChap, end: p.chap - 1 });
                
                return readings.map(r => ({
                    text: `${r.book.name} ${r.start}${r.end > r.start ? '-' + r.end : ''}`,
                    abbr: `${r.book.abbr}${r.start}${r.end > r.start ? '-' + r.end : ''}`,
                    bookCode: r.book.code,
                    chapter: r.start
                }));
            };

            const currentYear = new Date().getFullYear();
            for (let i = 0; i < 365; i++) {
                let date = new Date(currentYear, 0, 1);
                date.setDate(date.getDate() + i);
                let dateStr = `${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;

                let otRead = getReadingForTrack('ot', otBooks);
                let ntRead = getReadingForTrack('nt', ntBooks);
                let psRead = getReadingForTrack('ps', psBooks);
                let proChap = (i % 31) + 1;
                let proRead = [{ text: `ç®´è¨€ ${proChap}`, abbr: `ç®´${proChap}`, bookCode: "PRO", chapter: proChap }];

                let fullReadings = [];
                if (otRead) otRead.forEach(r => fullReadings.push({...r, type: 'èˆŠ'}));
                if (ntRead) ntRead.forEach(r => fullReadings.push({...r, type: 'æ–°'}));
                if (psRead) psRead.forEach(r => fullReadings.push({...r, type: 'è©©'}));
                if (proRead) proRead.forEach(r => fullReadings.push({...r, type: 'ç®´'}));

                // Add note item
                fullReadings.push({ type: 'ç­†è¨˜', abbr: 'éˆä¿®ç­†è¨˜', isNote: true });

                let mainText = "";
                if (otRead) mainText += otRead[0].abbr + " "; 
                if (ntRead) mainText += ntRead[0].abbr;
                if (!otRead && !ntRead && psRead) mainText = psRead[0].abbr;

                let extraMark = "";
                if (psRead || proRead) extraMark = "+è©©/ç®´";

                plan.push({ 
                    day: i + 1, 
                    dateStr: dateStr, 
                    details: fullReadings,
                    reading: mainText.trim() || "å®‰æ¯æ—¥ (è£œé€²åº¦)",
                    extraMark: extraMark,
                    completed: false 
                });
            }
            return plan;
        }

        // --- Data Loaders ---
        async function loadOnlineQuotes() { const d = await fetchAndParseCSV('1349046456'); if(!d)return; let idx=d.headers.findIndex(h=>['text','quote'].some(k=>h.includes(k)))||0; dailyQuotesPool=[]; d.rows.forEach(l=>{const c=d.parser(l);if(c[idx])dailyQuotesPool.push(c[idx])}); refreshDailyWord(); }
        async function loadSaltStatusMap() { const d = await fetchAndParseCSV('138033526'); if(d){ onlineSaltStatusMap=[]; d.rows.forEach(l=>{const c=d.parser(l);onlineSaltStatusMap.push({min:parseInt(c[d.headers.indexOf('min_percent')]),max:parseInt(c[d.headers.indexOf('max_percent')]),title:c[d.headers.indexOf('status_title')],desc:c[d.headers.indexOf('status_desc')]})}); } }
        async function loadPreservativePool() { const d=await fetchAndParseCSV('159897993'); if(d){ let idx={min:d.headers.findIndex(h=>h.includes('min'))||0,max:d.headers.findIndex(h=>h.includes('max'))||1,c:d.headers.findIndex(h=>h.includes('content'))||2}; onlinePreservativePool=[]; d.rows.forEach(l=>{const c=d.parser(l);onlinePreservativePool.push({tMin:parseInt(c[idx.min]),tMax:parseInt(c[idx.max]),content:c[idx.c]})}); } }
        async function loadFlipQuotes() { const d=await fetchAndParseCSV('1402400724'); if(d){ let idx={c:d.headers.findIndex(h=>h.includes('content'))||0,s:d.headers.findIndex(h=>h.includes('source'))||1,cm:d.headers.findIndex(h=>h.includes('comment'))||2}; onlineFlipQuotes=[]; d.rows.forEach(l=>{const c=d.parser(l);if(c[idx.c])onlineFlipQuotes.push({text:c[idx.c],source:c[idx.s]||"",comment:c[idx.cm]||""})}); } }
        async function loadShieldData() { const d=await fetchAndParseCSV('1087555591'); if(!d){renderShieldTags();return;} let idx={l:d.headers.findIndex(h=>h.includes('label'))||0,o:d.headers.findIndex(h=>h.includes('options'))||1}; onlineShieldData=[]; d.rows.forEach(l=>{const c=d.parser(l);if(c[idx.l])onlineShieldData.push({label:c[idx.l],options:c[idx.o].split(/[|\n]/)})}); renderShieldTags(); }
        
        async function loadPuaChecklist() {
            const d = await fetchAndParseCSV('494946164');
            if (d) {
                let idx = {
                    t: d.headers.findIndex(h => h.includes('question') || h.includes('é¡Œç›®')) || 0,
                    w: d.headers.findIndex(h => h.includes('weight') || h.includes('æ¬Šé‡')) || 1
                };
                onlinePuaChecklist = [];
                d.rows.forEach(l => {
                    const c = d.parser(l);
                    if (c[idx.t]) {
                        onlinePuaChecklist.push({ text: c[idx.t], weight: parseInt(c[idx.w]) || 1 });
                    }
                });
            }
        }

        // --- Core UI & Logic ---
        function refreshDailyWord() { const el=document.getElementById('daily-word'); if(el) el.innerHTML=`<span>ğŸ’¬ å°èªï¼š${dailyQuotesPool.length?dailyQuotesPool[Math.floor(Math.random()*dailyQuotesPool.length)]:preservativePool[0].content}</span> <span class="refresh-icon">â†»</span>`; }
        function setRandomStatus() { 
            const t=document.getElementById('daily-status-title'), d=document.getElementById('daily-status-desc'); if(!t)return; 
            const completedCount = biblePlan.filter(d => d.completed).length;
            const totalDays = biblePlan.length || 365;
            currentSaltPercent = Math.floor((completedCount / totalDays) * 100);

            const s=(onlineSaltStatusMap.length?onlineSaltStatusMap:saltStatusMap).find(x=>currentSaltPercent>=x.min&&currentSaltPercent<=x.max)||saltStatusMap[0]; 
            t.style.opacity=0;d.style.opacity=0; 
            
            setTimeout(()=>{
                if (s.title.includes('%')) {
                     t.innerText = s.title.replace(/\d+%/, currentSaltPercent + "%");
                } else {
                     t.innerText = `å«é¹½é‡ ${currentSaltPercent}%ï¼š${s.title}`;
                }
                d.innerText=s.desc;
                t.style.opacity=1;d.style.opacity=1;
            },200); 
            
            updateHomeStatus();
        }
        function getPreservative() { const d=document.getElementById('preservative-display'); d.style.opacity=0; const pool=onlinePreservativePool.length?onlinePreservativePool:preservativePool; const msg=pool[Math.floor(Math.random()*pool.length)].content; setTimeout(()=>{d.innerText=`ã€Œ${msg}ã€`;d.style.opacity=1;},200); }
        
        // --- Helper to find book info from source string ---
        function findBookFromSource(source) {
            if (!source) return null;
            // Clean up source string (remove spaces) for better matching
            const cleanSource = source.replace(/\s+/g, '');
            
            for (let book of bibleBooks) {
                // Check if starts with full name or abbr
                if (cleanSource.startsWith(book.name) || cleanSource.startsWith(book.abbr)) {
                    // Remove book name to isolate chapter number
                    // e.g. "é¦¬å¤ªç¦éŸ³11:28" -> "11:28"
                    let temp = cleanSource.replace(book.name, '').replace(book.abbr, '');
                    // Regex to capture the first number (chapter)
                    let match = temp.match(/^(\d+)/);
                    if (match) {
                        return { 
                            code: book.code, 
                            chapter: parseInt(match[1]), 
                            title: `${book.name} ${match[1]}ç« ` // Friendly title for reader
                        };
                    }
                }
            }
            return null;
        }

        function flipCard() { 
            const container = document.querySelector('.flip-container');
            container.classList.toggle('flipped'); 
            const readBtn = document.getElementById('read-chapter-btn');
            
            if(container.classList.contains('flipped')){
                const q=(onlineFlipQuotes.length?onlineFlipQuotes:quotes)[Math.floor(Math.random()*onlineFlipQuotes.length||quotes.length)]; 
                document.getElementById('quote-content').innerText=q.text; 
                document.getElementById('quote-source').innerText=q.source; 
                document.getElementById('quote-comment').innerHTML=`<strong>ä¸»å»šç¥•æ–¹ï¼š</strong><br>${q.comment.replace(/[()]/g,'').replace('é¹¹é­šä¸»å»šçš„ç¥•æ–¹ï¼š','')}`; 

                // --- New Logic: Show Read Button if source is valid ---
                const ref = findBookFromSource(q.source);
                
                if (ref && readBtn) {
                    readBtn.classList.remove('hidden');
                    readBtn.onclick = (e) => {
                        // Use openStandaloneReader instead of goToScripture
                        openStandaloneReader(ref.code, ref.chapter, ref.title);
                    };
                } else if (readBtn) {
                    readBtn.classList.add('hidden');
                }
            } else {
                // ç•¶å¡ç‰‡ç¿»å›æ­£é¢æ™‚ï¼Œéš±è—å¤–éƒ¨æŒ‰éˆ•
                if (readBtn) readBtn.classList.add('hidden');
            }
        }

        // Renamed and updated from goToScripture to use standalone reader
        async function openStandaloneReader(code, chapter, title) {
            // æ–°å¢ï¼šè¨˜éŒ„ç•¶å‰æ‰€åœ¨çš„é é¢ ID
            const activeSection = document.querySelector('.section.active');
            if (activeSection) {
                readerPreviousSection = activeSection.id;
            }

            showSection('bible-reader-standalone'); // This hides others and shows this one
            
            const titleEl = document.getElementById('standalone-reader-title');
            const contentEl = document.getElementById('standalone-reader-content');
            
            if(titleEl) titleEl.innerText = title;
            if(contentEl) contentEl.innerHTML = '<div class="h-full flex flex-col items-center justify-center gap-4"><span class="loader"></span><span class="text-xs text-[#94908A] tracking-widest animate-pulse font-serif">è®€å–ä¸­...</span></div>';

            try {
                // Fetch logic (same API)
                const res = await fetch(`https://bolls.life/get-text/CUNP/${code}/${chapter}/`);
                const data = await res.json();
                
                let html = "";
                data.forEach(v => {
                    const text = stripHtml(v.text);
                     html += `
                        <div class="mb-4">
                            <span class="text-xs text-[#D6D0C8] font-mono mr-1 select-none">${v.verse}</span>
                            <span>${text}</span>
                        </div>
                    `;
                });
                if(contentEl) contentEl.innerHTML = `<div class="max-w-3xl mx-auto">${html}</div>`;
            } catch (e) {
                if(contentEl) contentEl.innerHTML = '<div class="text-center text-[#94908A] py-10">è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚</div>';
            }
        }

        // æ–°å¢ï¼šé—œé–‰é–±è®€å™¨ä¸¦è¿”å›ä¸Šä¸€é 
        function closeStandaloneReader() {
            showSection(readerPreviousSection);
        }

        function saveCardImage(e) { e.stopPropagation(); showToast('ğŸ“¸ æˆªåœ–ä¸­...'); const temp=document.createElement('div'); temp.style.position='fixed'; temp.style.top='0'; temp.style.zIndex='-9'; temp.style.width='350px'; temp.innerHTML=`<div style="background:#FDFBF7;border:2px solid #7CA1B3;border-radius:24px;padding:40px 30px;text-align:center;font-family:'Noto Sans TC';"><p style="font-family:'Noto Serif TC';font-size:1.4rem;color:#5A524C;margin-bottom:20px;">${document.getElementById('quote-content').innerText}</p><p style="color:#9E9791;margin-bottom:30px;">â€”â€” ${document.getElementById('quote-source').innerText}</p><div style="width: 40%; height: 1px; border-top: 1px dashed #D6D0C8; margin: 30px auto;"></div><div style="color:#7CA1B3;font-style:italic;padding-top:15px;">${document.getElementById('quote-comment').innerHTML}</div><div style="margin-top:30px;font-size:0.75rem;color:#D4B483;">æ©Ÿæ™ºçš„é¹¹é­šç”Ÿæ´»</div></div>`; document.body.appendChild(temp); html2canvas(temp.firstChild,{scale:2,backgroundColor:null}).then(c=>{const a=document.createElement('a');a.download=`salted-fish-${Date.now()}.png`;a.href=c.toDataURL();a.click();document.body.removeChild(temp);showToast('âœ… ä¸‹è¼‰å®Œæˆ');}); }
        
        function showSection(id, btn) { 
            if (id !== 'flip') {
                const flipper = document.querySelector('.flip-container');
                // ä¿®æ”¹ï¼šå¦‚æœç›®æ¨™æ˜¯é–±è®€å™¨ï¼Œæˆ–è€…å¾é–±è®€å™¨è¿”å›ä¸”ç›®æ¨™æ˜¯ç¿»è½‰é ï¼Œå‰‡ä¸é‡ç½®å¡ç‰‡ç‹€æ…‹
                const isGoingToReader = (id === 'bible-reader-standalone');
                const isReturningToFlip = (id === 'flip' && readerPreviousSection === 'flip');
                
                // åªæœ‰åœ¨ã€Œä¸æ˜¯å»é–±è®€å™¨ã€ä¸”ã€Œä¸æ˜¯å›åˆ°ç¿»è½‰é ã€çš„æƒ…æ³ä¸‹ï¼Œæ‰é‡ç½®å¡ç‰‡
                if (flipper && !isGoingToReader && !isReturningToFlip) {
                    flipper.classList.remove('flipped');
                    // åŒæ™‚éš±è—å¤–éƒ¨æŒ‰éˆ•
                    const readBtn = document.getElementById('read-chapter-btn');
                    if (readBtn) readBtn.classList.add('hidden');
                }
            }

            // --- é‡ç½® é¦–é  (Preservative) ---
            if (id !== 'home') {
                 const preservativeDisplay = document.getElementById('preservative-display');
                 if (preservativeDisplay) {
                     preservativeDisplay.style.opacity = 0;
                     setTimeout(() => { if(preservativeDisplay) preservativeDisplay.innerText = ''; }, 500);
                 }
            }

            // --- é‡ç½® è°æ˜é¹¹é­š (PUA) ---
            if (id !== 'pua') {
                currentPuaSelection = null;
                document.querySelectorAll('.pua-tag').forEach(t => t.classList.remove('selected'));
                const puaRes = document.getElementById('pua-result');
                if (puaRes) puaRes.style.opacity = 0;
                
                const testArea = document.getElementById('pua-test-area');
                if (testArea) testArea.style.display = 'none';
                const testRes = document.getElementById('test-result');
                if (testRes) testRes.style.display = 'none';
            }

            // --- é‡ç½® æ¸¸åˆƒæœ‰é­š (Shield) ---
            if (id !== 'shield') {
                currentShieldSelection = null;
                document.querySelectorAll('.shield-tag').forEach(t => t.classList.remove('selected'));
                const shieldRes = document.getElementById('shield-result');
                if (shieldRes) shieldRes.style.opacity = 0;
            }
            
            // --- Reset Bible Directory if leaving ---
            if (id !== 'bible-directory') {
                 const chapArea = document.getElementById('dir-chapter-area');
                 if(chapArea) chapArea.classList.add('hidden');
            } else {
                 // If entering Bible Directory, init render
                 renderBibleDirectory();
            }

            document.querySelectorAll('.section').forEach(s=>s.classList.remove('active')); 
            
            const targetSection = document.getElementById(id);
            if(targetSection) targetSection.classList.add('active'); 
            
            if(btn){
                document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active')); 
                btn.classList.add('active');
            }
            
            const body = document.body;
            const main = document.getElementById('app-main');
            if (id === 'devotion') {
                body.classList.add('devotion-mode');
                main.classList.remove('container-limited');
                main.classList.add('container-full');
                initJournalDate();
            } else {
                body.classList.remove('devotion-mode');
                main.classList.add('container-limited');
                main.classList.remove('container-full');
                document.getElementById('scroll-wrapper').scrollTo(0,0);
            }
        }

        // --- Bible Directory Logic ---
        function switchDirectoryTab(tab) {
            currentDirectoryTab = tab;
            // Update UI styles
            const otBtn = document.getElementById('dir-tab-ot');
            const ntBtn = document.getElementById('dir-tab-nt');
            
            if(tab === 'ot') {
                otBtn.className = "flex-1 py-2 text-sm font-bold text-[#A68C76] border-b-2 border-[#A68C76] transition-colors";
                ntBtn.className = "flex-1 py-2 text-sm font-bold text-[#9E9791] border-b-2 border-transparent hover:text-[#5E5A54] transition-colors";
            } else {
                otBtn.className = "flex-1 py-2 text-sm font-bold text-[#9E9791] border-b-2 border-transparent hover:text-[#5E5A54] transition-colors";
                ntBtn.className = "flex-1 py-2 text-sm font-bold text-[#A68C76] border-b-2 border-[#A68C76] transition-colors";
            }
            
            renderBibleDirectory();
            document.getElementById('dir-chapter-area').classList.add('hidden'); // Hide chapters when switching tabs
        }

        function renderBibleDirectory() {
            const list = document.getElementById('dir-book-list');
            if(!list) return;
            list.innerHTML = "";

            // Filter books: Type 1=OT, 3=Wisdom(OT), 4=Proverbs(OT); Type 2=NT
            const books = bibleBooks.filter(b => {
                if(currentDirectoryTab === 'ot') return b.type !== 2;
                return b.type === 2;
            });

            books.forEach(b => {
                const btn = document.createElement('button');
                btn.className = "p-2 bg-[#F9F7F5] rounded-lg text-xs text-[#5E5A54] hover:bg-[#A68C76] hover:text-white transition-all text-center truncate";
                btn.innerText = b.abbr;
                btn.onclick = () => selectBookInDirectory(b);
                list.appendChild(btn);
            });
        }

        function selectBookInDirectory(book) {
            const area = document.getElementById('dir-chapter-area');
            const title = document.getElementById('dir-selected-book');
            const list = document.getElementById('dir-chapter-list');
            
            title.innerText = book.name;
            list.innerHTML = "";
            
            for(let i=1; i<=book.chapters; i++) {
                const btn = document.createElement('button');
                btn.className = "aspect-square flex items-center justify-center bg-white border border-[#EBE6DE] rounded-lg text-sm text-[#94908A] hover:border-[#A68C76] hover:text-[#A68C76] transition-all";
                btn.innerText = i;
                btn.onclick = () => {
                    openStandaloneReader(book.code, i, `${book.name} ${i}ç« `);
                };
                list.appendChild(btn);
            }
            
            area.classList.remove('hidden');
            // Scroll to the specific chapter area instead of bottom
            setTimeout(() => {
                area.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 50);
        }

        // --- NEW JOURNAL UI LOGIC ---
        const journalEls = {};

        function initJournalDate() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const picker = document.getElementById('journal-date-picker');
            if (picker) {
                if (!picker.value) picker.value = `${yyyy}-${mm}-${dd}`;
                handleJournalDateChange(`${mm}-${dd}`);
            }
        }

        function handleJournalDateChange(dateKey) {
            renderPlanButtons(dateKey);
            
            // Load Devotion Note
            ['note-scripture', 'note-reflection', 'note-prayer'].forEach(id => {
                const saved = localStorage.getItem(`${dateKey}-${id}`);
                const el = document.getElementById(id);
                if(el) el.value = saved || "";
            });

            // Load Gratitude
            const savedGratitude = localStorage.getItem(`${dateKey}-gratitude-text`);
            if(document.getElementById('gratitude-text')) document.getElementById('gratitude-text').value = savedGratitude || "";

            // Load Emotion (Updated 5 fields)
            ['emotion-event', 'emotion-feeling', 'emotion-belief', 'emotion-god-view', 'emotion-prayer'].forEach(id => {
                const saved = localStorage.getItem(`${dateKey}-${id}`);
                const el = document.getElementById(id);
                if(el) el.value = saved || "";
            });

            // Load Mood
            const savedMood = localStorage.getItem(`${dateKey}-note-mood`);
            const moodBtns = document.querySelectorAll('.mood-btn');
            moodBtns.forEach(b => b.classList.remove('active'));
            if(savedMood) {
                const targetBtn = Array.from(moodBtns).find(b => b.dataset.mood === savedMood);
                if(targetBtn) targetBtn.classList.add('active');
            }
            const savedMoodText = localStorage.getItem(`${dateKey}-mood-text`);
            if(document.getElementById('mood-text')) document.getElementById('mood-text').value = savedMoodText || "";
        }

        function renderPlanButtons(dateKey) {
            const planList = document.getElementById('plan-list');
            const mobilePlanRow1 = document.getElementById('mobile-plan-row-1');
            const mobilePlanRow2 = document.getElementById('mobile-plan-row-2');
            if (!planList || !mobilePlanRow1 || !mobilePlanRow2) return;

            planList.innerHTML = "";
            mobilePlanRow1.innerHTML = "";
            mobilePlanRow2.innerHTML = "";
            
            const todayPlan = biblePlan.find(p => p.dateStr === dateKey) || biblePlan[0];
            const details = todayPlan.details || [];

            const createBtn = (item, isMobile = false) => {
                const btn = document.createElement('button');
                if (isMobile) {
                    // ä¿®æ”¹é€™è£¡ï¼šå°‡ min-w-[70px] æ”¹ç‚º w-[85px] ä»¥çµ±ä¸€å¯¬åº¦ï¼Œä¸¦å°‡ px-3 æ”¹ç‚º px-1 é¿å…å…§è·éå¤§
                    btn.className = "flex-shrink-0 px-1 py-2 border border-[#D6D0C8] rounded-xl bg-white text-xs hover:bg-[#F2EBE5] hover:border-[#A68C76] transition-colors flex flex-col items-center justify-center gap-1 w-[85px] shadow-sm h-14";
                    btn.innerHTML = `<span class="text-[9px] text-[#B0AAA3] tracking-widest scale-90 origin-bottom">${item.type}</span><span class="font-serif text-[#5E5A54] text-xs font-bold whitespace-nowrap">${item.abbr}</span>`;
                } else {
                    btn.className = "w-full text-left px-8 py-12 rounded-xl border border-[#D6D0C8] bg-white hover:border-[#A68C76] hover:bg-[#FAF9F6] transition-all group flex flex-col gap-6 shadow-sm hover:shadow-md min-h-[140px]";
                    btn.innerHTML = `
                        <div class="flex justify-between items-center">
                            <span class="text-[10px] font-bold text-[#B0AAA3] uppercase group-hover:text-[#A68C76] transition-colors tracking-widest">${item.type}</span>
                            <div class="w-2 h-2 rounded-full bg-[#EBE6DE] group-hover:bg-[#A68C76] transition-colors"></div>
                        </div>
                        <span class="text-base font-serif text-[#5E5A54] group-hover:text-[#3E3A34] tracking-wide">${item.abbr}</span>
                    `;
                }
                
                if (item.action) {
                    btn.onclick = item.action;
                } else if (item.isNote) {
                    btn.onclick = () => showView('note');
                } else {
                    btn.onclick = () => showReader(item);
                }
                
                return btn;
            };

            // Row 1: Readings
            details.forEach(item => {
                 if(item.isNote) return; 
                 planList.appendChild(createBtn(item));
                 mobilePlanRow1.appendChild(createBtn(item, true));
            });

            // Row 2: Journals
            const journals = [
                { type: 'ç­†è¨˜', abbr: 'éˆä¿®ç­†è¨˜', isNote: true, action: () => showView('note') },
                { type: 'æ„Ÿæ©', abbr: 'æ„Ÿæ©æ—¥è¨˜', action: () => showView('gratitude') },
                { type: 'æƒ…ç·’', abbr: 'æƒ…ç·’æ—¥è¨˜', action: () => showView('emotion') },
                { type: 'æœªä¾†', abbr: 'å¯«çµ¦æœªä¾†', action: () => showView('future') }
            ];

            journals.forEach(item => {
                if (item.type === 'ç­†è¨˜') planList.appendChild(createBtn(item)); // Add Note to sidebar too
                mobilePlanRow2.appendChild(createBtn(item, true));
            });
        }
        
        function showReader(item) {
            hideAllViews();
            document.getElementById('view-reader').classList.remove('hidden');
            fetchBible(item);
        }
        
        function showView(viewName) {
            hideAllViews();
            document.getElementById(`view-${viewName}`).classList.remove('hidden');
            if (viewName === 'future') renderTimeCapsule(); // Refresh list on view
        }

        function hideAllViews() {
            ['reader', 'note', 'gratitude', 'emotion', 'future'].forEach(v => {
                const el = document.getElementById(`view-${v}`);
                if(el) el.classList.add('hidden');
            });
        }

        async function fetchBible(item) {
            const content = document.getElementById('bible-content');
            const title = document.getElementById('bible-title');
            const tag = document.getElementById('bible-book-tag');
            const copyBtn = document.getElementById('copy-btn');
            
            content.innerHTML = '<div class="h-full flex flex-col items-center justify-center gap-4"><span class="loader"></span><span class="text-xs text-[#94908A] tracking-widest animate-pulse font-serif">è®€å–ä¸­...</span></div>';
            title.innerText = "è®€å–ä¸­...";
            copyBtn.classList.add('hidden');
            
            selectedVerses.clear();

            let startChap = item.chapter;
            let endChap = item.chapter;
            
            const parts = item.text.split(' '); 
            if (parts.length > 1) {
                const range = parts[parts.length - 1]; 
                if (range.includes('-')) {
                    endChap = parseInt(range.split('-')[1]);
                }
            }

            let allVerses = [];
            try {
                const promises = [];
                for (let c = startChap; c <= endChap; c++) {
                    promises.push(fetch(`https://bolls.life/get-text/CUNP/${item.bookCode}/${c}/`).then(r => r.json()));
                }
                
                const results = await Promise.all(promises);
                results.forEach((chapVerses, idx) => {
                    const currentChap = startChap + idx;
                    chapVerses.forEach(v => {
                        v.chapter = currentChap;
                        v.text = stripHtml(v.text);
                    });
                    allVerses = allVerses.concat(chapVerses);
                });

                renderScriptureBolls(allVerses, item.text);
            } catch (err) {
                renderDemoScripture(item.text, "è®€å–å¤±æ•—", "ç„¡æ³•å–å¾—ç¶“æ–‡å…§å®¹");
            }
        }

        function renderScriptureBolls(records, title) {
            const content = document.getElementById('bible-content');
            const titleEl = document.getElementById('bible-title');
            const tag = document.getElementById('bible-book-tag');
            const copyBtn = document.getElementById('copy-btn');

            titleEl.innerText = title;
            tag.innerText = "SCRIPTURE";
            
            let html = "";
            let textBuffer = `ã€${title}ã€‘\n`;

            records.forEach((v) => {
                let text = v.text;
                let label = `${v.verse}`;
                const labelClass = "w-8 text-center";

                html += `
                    <div class="verse-row mb-2 hover:bg-[#F9F7F5] -mx-4 px-4 py-3 rounded-lg transition-colors cursor-pointer group flex gap-3 items-start" 
                         data-text="${text}" data-label="${label}"
                         onclick="toggleVerse(this)">
                        <span class="text-[10px] text-[#D6D0C8] font-mono pt-2 shrink-0 group-hover:text-[#A68C76] transition-colors ${labelClass}">${label}</span>
                        <span class="text-[#5E5A54] leading-loose group-hover:text-[#3E3A34] text-justify flex-1">${text}</span>
                    </div>
                `;
                textBuffer += `${label} ${text}\n`;
            });

            content.innerHTML = `<div class="max-w-3xl mx-auto">${html}</div>`;
            currentFullText = textBuffer; 
            copyBtn.classList.remove('hidden');
        }

        function toggleVerse(el) {
            el.classList.toggle('selected-verse');
            const text = el.getAttribute('data-text');
            const label = el.getAttribute('data-label');
            const verseData = `${label} ${text}`;
            
            if (selectedVerses.has(verseData)) {
                selectedVerses.delete(verseData);
            } else {
                selectedVerses.add(verseData);
            }
        }

        function renderDemoScripture(title, msg = "ç„¡æ³•é€£ç·šè‡³è³‡æ–™åº«", subMsg = "è«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦", extraHtml = "") {
            const content = document.getElementById('bible-content');
            const titleEl = document.getElementById('bible-title');
            const tag = document.getElementById('bible-book-tag');
            const copyBtn = document.getElementById('copy-btn');

            titleEl.innerText = title;
            tag.innerText = "MESSAGE"; 
            content.innerHTML = `<div class="h-full flex items-center justify-center text-[#94908A] font-serif flex-col gap-2 p-4 text-center">
                <span class="text-lg font-medium text-[#5E5A54]">${msg}</span>
                <span class="text-xs opacity-60">${subMsg}</span>
                ${extraHtml}
            </div>`;
            copyBtn.classList.add('hidden');
        }

        function saveNote(dateKey, id, content) {
            localStorage.setItem(`${dateKey}-${id}`, content);
            const status = document.getElementById('save-status');
            status.style.opacity = '1';
            setTimeout(() => { status.style.opacity = '0'; }, 2000);
        }

        function addEmotionTag(tag) {
            const ta = document.getElementById('emotion-feeling'); // Target the "Feeling" input
            const currentVal = ta.value;
            // Add comma if not empty
            ta.value = currentVal ? currentVal + `, ${tag}` : tag;
            
            // Trigger save
            const picker = document.getElementById('journal-date-picker');
            if(picker) saveNote(picker.value.substring(5), 'emotion-feeling', ta.value);
        }

        // Render Emotion Chart
        function renderEmotionChart() {
            const renderGroup = (id, tags, colorClass) => {
                const container = document.getElementById(id);
                if(!container) return;
                container.innerHTML = tags.map(tag => 
                    `<span class="px-3 py-1 rounded-full text-xs cursor-pointer border transition-all ${colorClass}" onclick="addEmotionTag('${tag}')">${tag}</span>`
                ).join('');
            };

            renderGroup('emotion-tags-pos', emotionCategories.pos, 'bg-[#F2F9F5] text-m-green border-[#E0EFE5] hover:bg-m-green hover:text-white');
            renderGroup('emotion-tags-neu', emotionCategories.neu, 'bg-[#F9FAFB] text-gray-500 border-[#F3F4F6] hover:bg-gray-400 hover:text-white');
            renderGroup('emotion-tags-neg', emotionCategories.neg, 'bg-[#FFF5F5] text-m-rose border-[#FFE0E0] hover:bg-m-rose hover:text-white');
        }

        // --- Future Letters Logic (NEW) ---
        function saveFutureLetter() {
            const dateInput = document.getElementById('future-date');
            const contentInput = document.getElementById('future-content');
            
            if(!dateInput.value || !contentInput.value.trim()) {
                showToast('è«‹å¡«å¯«æ—¥æœŸèˆ‡å…§å®¹');
                return;
            }

            const today = new Date().toISOString().split('T')[0];
            if(dateInput.value <= today) {
                showToast('è«‹é¸æ“‡æœªä¾†çš„æ—¥æœŸ');
                return;
            }

            const letter = {
                id: Date.now(),
                createDate: today,
                deliveryDate: dateInput.value,
                content: contentInput.value,
                read: false
            };

            futureLetters.push(letter);
            saveToStorage('futureLetters', JSON.stringify(futureLetters));
            
            showToast('ğŸ“© ä¿¡ä»¶å·²å°å­˜å¯„å‡ºï¼');
            contentInput.value = '';
            dateInput.value = '';
            renderTimeCapsule();
        }

        function renderTimeCapsule() {
            const list = document.getElementById('future-list');
            if(!list) return;
            
            list.innerHTML = '';
            
            const today = new Date().toISOString().split('T')[0];
            // Sort: Delivery Date Ascending
            const sortedLetters = [...futureLetters].sort((a, b) => a.deliveryDate.localeCompare(b.deliveryDate));

            if(sortedLetters.length === 0) {
                list.innerHTML = '<div class="text-center py-8 text-xs text-[#D6D0C8] italic">ä¿¡ç®±æ˜¯ç©ºçš„...</div>';
                return;
            }

            sortedLetters.forEach(l => {
                const isLocked = l.deliveryDate > today;
                const div = document.createElement('div');
                div.className = `letter-list-item ${isLocked ? 'locked' : (l.read ? '' : 'new')}`;
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="text-xl">${isLocked ? 'ğŸ”’' : (l.read ? 'ğŸ“¨' : 'ğŸ“©')}</span>
                        <div>
                            <div class="text-xs text-[#A68C76] font-bold">å¯„çµ¦ ${l.deliveryDate}</div>
                            <div class="text-[10px] text-[#9E9791]">ä¾†è‡ª ${l.createDate} çš„ä½ </div>
                        </div>
                    </div>
                    ${!isLocked && !l.read ? '<div class="w-2 h-2 rounded-full bg-red-400"></div>' : ''}
                `;
                
                if (!isLocked) {
                    div.onclick = () => openLetter(l);
                }
                list.appendChild(div);
            });
        }

        function checkTimeCapsule() {
            const today = new Date().toISOString().split('T')[0];
            const arrivedLetters = futureLetters.filter(l => l.deliveryDate <= today && !l.read);
            
            if(arrivedLetters.length > 0) {
                // Show notification or automatically open the first one
                showToast(`ğŸ‰ æ”¶åˆ° ${arrivedLetters.length} å°ä¾†è‡ªéå»çš„ä¿¡ï¼`);
                // Optional: Automatically open the first one
                setTimeout(() => openLetter(arrivedLetters[0]), 1000);
            }
        }

        function openLetter(letter) {
            const modal = document.getElementById('letter-modal');
            document.getElementById('letter-date-display').innerText = `å¯«æ–¼ï¼š${letter.createDate} | å¯„é”ï¼š${letter.deliveryDate}`;
            document.getElementById('letter-content-display').innerText = letter.content;
            modal.classList.add('show');
            
            // Mark as read
            letter.read = true;
            saveToStorage('futureLetters', JSON.stringify(futureLetters));
            renderTimeCapsule();
        }

        function closeLetterModal() {
            document.getElementById('letter-modal').classList.remove('show');
        }

        // --- PUA & Shield Logic ---
        function renderPuaTags() { 
            const c = document.getElementById('pua-tag-container'); if(!c) return; c.innerHTML = ''; currentPuaSelection = null; document.getElementById('pua-result').style.opacity = 0;
            let src = Object.keys(puaData).map(k=>({key:k, ...puaData[k]}));
            src.sort(()=>0.5-Math.random()).slice(0,7).forEach(i => {
                const b = document.createElement('button');
                b.className='pua-tag';
                b.innerText=i.sentence;
                b.onclick=()=>{
                    document.querySelectorAll('.pua-tag').forEach(t=>t.classList.remove('selected'));
                    b.classList.add('selected');
                    currentPuaSelection = i;
                };
                c.appendChild(b);
            });
        }
        function detectPUA() {
            if(!currentPuaSelection) { showToast("è«‹å…ˆé¸æ“‡æ¨™ç±¤"); return; }
            const box = document.getElementById('pua-result'), badge = document.getElementById('pua-level');
            box.style.opacity = 0;
            setTimeout(() => {
                document.getElementById('pua-translation').innerText = currentPuaSelection.trans;
                if (currentPuaSelection.defenses && currentPuaSelection.defenses.length > 0) {
                    document.getElementById('pua-defense').innerText = currentPuaSelection.defenses[Math.floor(Math.random()*currentPuaSelection.defenses.length)];
                } else {
                    document.getElementById('pua-defense').innerText = "(ä¿æŒå¾®ç¬‘)";
                }
                badge.style.display = currentPuaSelection.level ? 'inline-block' : 'none'; badge.innerText = `æ¯’æ€§: ${currentPuaSelection.level}`;
                box.style.opacity = 1;
            }, 200);
        }
        function togglePuaTest() { const a = document.getElementById('pua-test-area'); a.style.display = a.style.display === 'block' ? 'none' : 'block'; if(a.style.display==='block') initPuaTest(); }
        function initPuaTest() {
            const l = document.getElementById('test-list');
            l.innerHTML='';
            const source = onlinePuaChecklist.length > 0 ? onlinePuaChecklist : puaTestItems;
            [...source].sort(()=>0.5-Math.random()).slice(0,7).forEach((t)=>{
                const d=document.createElement('div');
                d.style.marginBottom='10px';
                d.style.cursor='pointer';
                d.innerHTML=`<input type="checkbox" data-weight="${t.weight}"> <span>${t.text}</span>`;
                d.onclick=(e)=>{if(e.target.tagName!=='INPUT') {const c=d.querySelector('input'); c.checked=!c.checked;}};
                l.appendChild(d);
            });
        }
        function runPuaTest() {
            const inputs = document.querySelectorAll('#test-list input:checked');
            let totalScore = 0;
            inputs.forEach(input => { totalScore += parseInt(input.getAttribute('data-weight')) || 0; });
            
            const r = document.getElementById('test-result');
            r.style.display='block';
            
            let diagnosis = "";
            let prescription = "";
            
            if (totalScore === 0) {
                diagnosis = "å¥åº·å¯¶å¯¶";
                prescription = "æ­å–œä½ ï¼æ“æœ‰å±¬éˆæŠ—é«”ï¼Œè«‹ç¹¼çºŒä¿æŒé€™ä»½æ¸…é†’ã€‚";
            } else if (totalScore <= 3) {
                diagnosis = "è¼•å¾®æ“¦å‚·";
                prescription = "å¤šçœ‹çœ‹é¹¹é­šèªéŒ„ï¼Œå¢å¼·å…ç–«åŠ›ã€‚";
            } else if (totalScore <= 7) {
                diagnosis = "ä¸­åº¦æ„ŸæŸ“";
                prescription = "å»ºè­°æš«åœèšæœƒä¸€é€±ï¼Œå»æµ·é‚Šèµ°èµ°ï¼Œè½è½æµ·æµªçš„è²éŸ³ï¼ˆé‚£æ˜¯ä¸Šå¸çš„ç™½å™ªéŸ³ï¼‰ã€‚";
            } else if (totalScore <= 11) {
                diagnosis = "é‡åº¦ä¸­æ¯’";
                prescription = "ä½ éœ€è¦ç‰¹æ•ˆè—¥ï¼šé–±è®€åŠ æ‹‰å¤ªæ›¸ï¼Œä¸¦å¤§è²æœ—è®€ã€ç‚ºäº†è‡ªç”±ï¼ŒåŸºç£é‡‹æ”¾äº†æˆ‘å€‘ã€ã€‚";
            } else {
                diagnosis = "å±æ€¥å­˜äº¡";
                prescription = "å¿«é€ƒï¼é€™ä¸æ˜¯æ•™æœƒï¼Œæ˜¯ç²¾ç¥æ™‚å…‰å±‹ã€‚è«‹å°‹æ±‚å°ˆæ¥­è«®å•†æˆ–æ­£å¸¸äººé¡çš„å”åŠ©ã€‚";
            }
            
            r.innerHTML = `<strong style="color:var(--accent-purple)">è¨ºæ–·ï¼š${diagnosis} (æ¯’æ€§åˆ†æ•¸: ${totalScore})</strong><br><br><span style="font-size:0.9rem; color:#666">ğŸ’Š é¹¹é­šè—¥æ–¹ï¼š<br>${prescription}</span>`;
        }
        function renderShieldTags() {
            const c = document.getElementById('shield-tag-container'); if(!c) return; c.innerHTML=''; currentShieldSelection=null; document.getElementById('shield-result').style.opacity=0; document.getElementById('shield-text').innerText='';
            let src = onlineShieldData.length ? [...onlineShieldData] : Object.keys(shields).map(k=>({label:k==='marriage'?'ä»€éº¼æ™‚å€™çµå©š?':k==='salary'?'è–ªæ°´å¤šå°‘?':'æ²’ä¾†æœäº‹?', options:shields[k]}));
            src.sort(()=>0.5-Math.random()).slice(0,7).forEach(i => { const b = document.createElement('button'); b.className='shield-tag'; b.innerText=i.label; b.onclick=()=>{ document.querySelectorAll('.shield-tag').forEach(t=>t.classList.remove('selected')); b.classList.add('selected'); currentShieldSelection=i; }; c.appendChild(b); });
        }
        function getExcuse() { if(!currentShieldSelection) { showToast("è«‹é¸æ“‡æƒ…å¢ƒ"); return; } const opts = currentShieldSelection.options; document.getElementById('shield-result').style.opacity=0; setTimeout(()=>{ document.getElementById('shield-text').innerText=`ã€Œ${opts[Math.floor(Math.random()*opts.length)]}ã€`; document.getElementById('shield-result').style.opacity=1; },100); }
        
        function switchFlowTab(t) { 
            document.querySelectorAll('#flow .sub-section').forEach(e=>e.classList.remove('active')); 
            document.getElementById(`tab-${t}`).classList.add('active'); 
            document.querySelectorAll('#flow .tab-btn').forEach(b=>b.classList.remove('active')); 
            event.target.classList.add('active'); 
        }
        function renderSavingsGrid() { const grid = document.getElementById('savings-grid'); if(!grid) return; grid.innerHTML = ''; let total = 0; for (let i=1; i<=365; i++) { const s = savingsPlan[i]; if(s) total+=i; const d = document.createElement('div'); let classes = "aspect-square rounded-lg flex items-center justify-center text-sm cursor-pointer transition-all duration-200 border"; if (s) { classes += " bg-[#8DA399] border-[#8DA399] text-white font-bold shadow-md transform scale-105"; } else { classes += " bg-white border-[#EBE6DE] text-[#9E9791] hover:border-[#8DA399] hover:text-[#8DA399]"; } d.className = classes; d.innerText = i; d.onclick = () => confirmSave(i); grid.appendChild(d); } const summary = document.getElementById('savings-total'); if(summary) { summary.innerHTML = `<div class="flex flex-col items-start"><span class="text-xs text-[#9E9791] tracking-widest uppercase">Total Savings</span><span class="text-2xl font-serif text-[#5E5A54] font-bold">$${total.toLocaleString()}</span></div><div class="flex flex-col items-end"><span class="text-xs text-[#9E9791]">é€²åº¦ ${Math.round(savingsPlan.filter(Boolean).length/365*100)}%</span><span class="text-xs text-[#9E9791]">ç›®æ¨™ $66,795</span></div>`; } }
        function confirmSave(i) { const saved = savingsPlan[i]; showConfirm(saved?`å–æ¶ˆå­˜å…¥ $${i}?`:`å­˜å…¥ $${i}?`, ()=>{ savingsPlan[i]=!saved; saveToStorage('savingsPlan', JSON.stringify(savingsPlan)); renderSavingsGrid(); if(!saved) showToast(`ğŸ’° å­˜å…¥ $${i}ï¼`); }); }
        function randomSave() { let available = []; for (let i = 1; i <= 365; i++) { if (!savingsPlan[i]) available.push(i); } if (available.length === 0) { showToast('ğŸ‰ æ­å–œï¼ä½ å·²ç¶“å­˜æ»¿äº†æ‰€æœ‰é‡‘é¡ï¼'); return; } const randomIndex = Math.floor(Math.random() * available.length); const amountToSave = available[randomIndex]; savingsPlan[amountToSave] = true; saveToStorage('savingsPlan', JSON.stringify(savingsPlan)); renderSavingsGrid(); showToast(`ğŸ² å‘½é‹å¹«ä½ å­˜äº† $${amountToSave} ï¼`); }
        function renderWishlist() { const list = document.getElementById('wish-list'); if(!list) return; list.innerHTML = ''; if(wishlist.length===0) { list.innerHTML='<div class="flex flex-col items-center justify-center py-10 text-[#D6D0C8] gap-3"><span class="text-4xl opacity-50">âœ¨</span><span class="text-sm font-serif italic">å¯«ä¸‹ä½ çš„é¡˜æœ›ï¼Œäº¤è¨—çµ¦ç¥...</span></div>'; return; } wishlist.slice().reverse().forEach(w => { const d = document.createElement('div'); d.className = `p-4 rounded-xl border mb-3 transition-all flex items-center justify-between group ${w.fulfilled ? 'bg-[#F9F7F5] border-transparent opacity-60' : 'bg-white border-[#EBE6DE] hover:border-[#C8A8A4]'}`; d.innerHTML = `<div class="flex-1 min-w-0 pr-4"><div class="text-[#5E5A54] font-medium truncate ${w.fulfilled ? 'line-through text-[#9E9791]' : ''}">${w.content}</div><div class="text-xs text-[#A68C76] font-mono mt-1">$${w.cost ? parseInt(w.cost).toLocaleString() : '--'}</div></div><div class="flex gap-2 shrink-0 opacity-100 md:opacity-0 group-hover:opacity-100 transition-opacity"><button class="p-2 rounded-full hover:bg-[#F2EBE5] text-[#8DA399] transition-colors" onclick="toggleWishStatus(${w.id})">${w.fulfilled ? 'â†©ï¸' : 'ğŸ'}</button><button class="p-2 rounded-full hover:bg-[#F2EBE5] text-[#C8A8A4] hover:text-red-400 transition-colors" onclick="deleteWish(${w.id})">ğŸ—‘ï¸</button></div>`; list.appendChild(d); }); }
        function addWish() { const i1 = document.getElementById('new-wish-input'), i2 = document.getElementById('new-wish-cost'); if(!i1.value.trim()) return; wishlist.push({id:Date.now(), content:i1.value.trim(), cost:i2.value, fulfilled:false}); saveToStorage('wishlist', JSON.stringify(wishlist)); i1.value=''; i2.value=''; renderWishlist(); }
        function toggleWishStatus(id) { const w = wishlist.find(i=>i.id===id); if(w) { w.fulfilled=!w.fulfilled; saveToStorage('wishlist', JSON.stringify(wishlist)); renderWishlist(); } }
        function deleteWish(id) { showConfirm("åˆªé™¤é¡˜æœ›ï¼Ÿ", ()=>{ wishlist = wishlist.filter(i=>i.id!==id); saveToStorage('wishlist', JSON.stringify(wishlist)); renderWishlist(); }); }
        function refreshFinancialEncouragement() { const el = document.getElementById('financial-encouragement'); if(el) el.innerText = financialEncouragements[Math.floor(Math.random() * financialEncouragements.length)]; }
        async function shareNote() {
            const date = document.getElementById('journal-date-picker').value;
            const mood = document.getElementById('note-mood').value || "";
            const s = document.getElementById('note-scripture').value || "(ç„¡)";
            const r = document.getElementById('note-reflection').value || "(ç„¡)";
            const p = document.getElementById('note-prayer').value || "(ç„¡)";
            const title = `éˆä¿®æ—¥èªŒ ${date} ${mood}`;
            const text = `${title}\n\nğŸ“– æ„Ÿå‹•ç¶“æ–‡ï¼š\n${s}\n\nğŸ’¡ é ˜å—ï¼š\n${r}\n\nğŸ™ ç¦±å‘Šï¼š\n${p}`;
            if (navigator.share) {
                try { await navigator.share({ title: title, text: text }); } catch (err) { console.log('åˆ†äº«å–æ¶ˆ'); }
            } else {
                copyText(text, "å·²è¤‡è£½æ—¥èªŒå…§å®¹ï¼");
            }
        }
        function downloadNote() {
            const date = document.getElementById('journal-date-picker').value;
            const mood = document.getElementById('note-mood').value || "";
            const s = document.getElementById('note-scripture').value;
            const r = document.getElementById('note-reflection').value;
            const p = document.getElementById('note-prayer').value;
            
            let content = `éˆä¿®æ—¥èªŒ ${date} ${mood}\n\nã€æ„Ÿå‹•ç¶“æ–‡ã€‘\n${s}\n\nã€é ˜å—ã€‘\n${r}\n\nã€ç¦±å‘Šã€‘\n${p}\n\n`;
            
            // Append Gratitude
            const gText = document.getElementById('gratitude-text') ? document.getElementById('gratitude-text').value : "";
            if(gText) content += `ã€æ„Ÿæ©æ—¥è¨˜ã€‘\n${gText}\n\n`;
            
            // Append Emotion (Structured)
            const eEvent = document.getElementById('emotion-event').value;
            const eFeel = document.getElementById('emotion-feeling').value;
            const eBelief = document.getElementById('emotion-belief').value;
            const eGod = document.getElementById('emotion-god-view').value;
            const ePrayer = document.getElementById('emotion-prayer').value;
            
            if(eEvent || eFeel || eBelief) {
                content += `ã€æƒ…ç·’è¦ºå¯Ÿã€‘\näº‹ä»¶ï¼š${eEvent}\næƒ…ç·’ï¼š${eFeel}\nä¿¡å¿µï¼š${eBelief}\nç¥èªªï¼š${eGod}\nç¦±å‘Šï¼š${ePrayer}\n\n`;
            }
            
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `devotion-${date}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }
        function exportData() {
            const data = { 
                biblePlan_2026: localStorage.getItem('biblePlan_2026'), 
                prayers: localStorage.getItem('prayers'), 
                goals: localStorage.getItem('goals'), 
                userSignals: localStorage.getItem('userSignals'), 
                yearlyKeyword: localStorage.getItem('yearlyKeyword'), 
                savingsPlan: localStorage.getItem('savingsPlan'), 
                wishlist: localStorage.getItem('wishlist'),
                futureLetters: localStorage.getItem('futureLetters')
            };
            const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `salted-fish-backup-${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
        }
        function importData(input) {
            const file = input.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.biblePlan_2026) saveToStorage('biblePlan_2026', data.biblePlan_2026);
                    if (data.prayers) saveToStorage('prayers', data.prayers);
                    if (data.goals) saveToStorage('goals', data.goals);
                    if (data.userSignals) saveToStorage('userSignals', data.userSignals);
                    if (data.yearlyKeyword) saveToStorage('yearlyKeyword', data.yearlyKeyword);
                    if (data.savingsPlan) saveToStorage('savingsPlan', data.savingsPlan);
                    if (data.wishlist) saveToStorage('wishlist', data.wishlist);
                    if (data.futureLetters) saveToStorage('futureLetters', data.futureLetters);
                    showToast('åŒ¯å…¥æˆåŠŸï¼é é¢å°‡é‡æ–°æ•´ç†ã€‚'); setTimeout(() => location.reload(), 1500);
                } catch (err) { showToast('åŒ¯å…¥å¤±æ•—ï¼Œæª”æ¡ˆæ ¼å¼å¯èƒ½éŒ¯èª¤ã€‚'); }
            };
            reader.readAsText(file);
        }
        let pendingConfirmAction = null;
        function showConfirm(msg, action) { document.getElementById('confirm-msg').innerText = msg; pendingConfirmAction = action; document.getElementById('confirm-modal').classList.add('show'); }
        function closeConfirmModal() { document.getElementById('confirm-modal').classList.remove('show'); pendingConfirmAction = null; }
        document.getElementById('confirm-btn-action').onclick = function() { if (pendingConfirmAction) pendingConfirmAction(); closeConfirmModal(); };

        function showHelpModal() { document.getElementById('help-modal').classList.add('show'); }
        function closeHelpModal() { document.getElementById('help-modal').classList.remove('show'); }

        function updateHomeStatus() {
            const now = new Date();
            const todayStr = `${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
            let todayPlan = biblePlan.find(d => d.dateStr === todayStr);
            if (!todayPlan && biblePlan.length > 0) todayPlan = biblePlan[0];
            const scopeText = document.getElementById('plan-scope-text');
            if(scopeText) {
                if (todayPlan) {
                    const extra = todayPlan.extraMark ? ` ${todayPlan.extraMark}` : '';
                    scopeText.innerText = (todayPlan.reading || "ä»Šæ—¥æš«ç„¡é€²åº¦") + extra;
                } else { scopeText.innerText = "ä»Šæ—¥ä¼‘æ¯"; }
            }
            const dateText = document.getElementById('current-date-text');
            if(dateText) dateText.innerText = `${now.getMonth() + 1}/${now.getDate()}`;
            let completedCount = biblePlan.filter(d => d.completed).length;
            const percent = ((completedCount / 365) * 100).toFixed(1);
            const progressBar = document.getElementById('bible-progress'); 
            if(progressBar) progressBar.style.width = `${percent}%`;
            const percentText = document.getElementById('percent-text');
            if(percentText) percentText.innerText = `${percent}% å…¥å‘³`;
            const saltStars = document.getElementById('today-salt-stars');
            if (saltStars && todayPlan) {
                const count = todayPlan.details ? todayPlan.details.length : 0;
                saltStars.innerText = count >= 4 ? 'â­â­â­â­â­' : count >= 2 ? 'â­â­â­' : 'â­';
            }
        }

        function handleCheckIn(dateKey) {
            const planIndex = biblePlan.findIndex(p => p.dateStr === dateKey);
            if (planIndex !== -1) {
                const isCompleted = biblePlan[planIndex].completed;
                if (!isCompleted) {
                    biblePlan[planIndex].completed = true;
                    saveToStorage('biblePlan_2026', JSON.stringify(biblePlan));
                    showToast('ğŸ‰ ä»Šæ—¥è®€ç¶“æ‰“å¡æˆåŠŸï¼');
                    updateHomeStatus();
                } else { showToast('å·²ç¶“æ‰“éå¡å›‰ï¼'); }
            }
        }
        
        function fallbackCopyTextToClipboard(text, successMsg) {
            var textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            textArea.style.top = "0";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                var successful = document.execCommand('copy');
                if(successful) showToast(successMsg);
                else showToast("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½");
            } catch (err) { showToast("è¤‡è£½å¤±æ•—"); }
            document.body.removeChild(textArea);
        }

        function copyText(text, successMsg = "å·²è¤‡è£½") {
             if (navigator.clipboard && navigator.clipboard.writeText) {
                 navigator.clipboard.writeText(text)
                     .then(() => showToast(successMsg))
                     .catch(err => { fallbackCopyTextToClipboard(text, successMsg); });
             } else { fallbackCopyTextToClipboard(text, successMsg); }
        }

        // æ–°å¢ï¼šè¼‰å…¥éˆä¿®å°èª
        async function loadDevotionalContent() {
            try {
                // ä½¿ç”¨ raw.githubusercontent.com ç¢ºä¿è·¨åŸŸå­˜å–æ­£å¸¸
                const url = 'https://raw.githubusercontent.com/annelin0321/witty-bible-data/main/devotionals.json';
                const response = await fetch(url);
                
                if (!response.ok) return;
                const data = await response.json();
                
                if (!Array.isArray(data) || data.length === 0) return;

                // ä½¿ç”¨ä»Šå¤©çš„æ—¥æœŸä½œç‚ºç¨®å­ï¼Œç¢ºä¿ç•¶å¤©çœ‹åˆ°çš„å…§å®¹å›ºå®š
                const today = new Date();
                const seed = today.getFullYear() * 10000 + (today.getMonth() + 1) * 100 + today.getDate();
                const index = seed % data.length;
                const item = data[index];

                const card = document.getElementById('daily-devotional-card');
                const titleEl = document.getElementById('devotional-title');
                const textEl = document.getElementById('devotional-text');
                const songNameEl = document.getElementById('devotional-song-name');
                const songLinkEl = document.getElementById('devotional-song-link');

                if(card && titleEl && textEl && songNameEl && songLinkEl) {
                    titleEl.innerText = item.title || "ä»Šæ—¥éˆç³§";
                    textEl.innerText = item.text || "";
                    songNameEl.innerText = item.song || "å®‰éœé»˜æƒ³";
                    songLinkEl.href = item.link || "#";
                    
                    // é¡¯ç¤ºå¡ç‰‡
                    card.classList.remove('hidden');
                }

            } catch (e) {
                console.warn("Devotional content load failed:", e);
                // å¤±æ•—æ™‚ä¿æŒéš±è—ï¼Œä¸å½±éŸ¿ä¸»åŠŸèƒ½
            }
        }

        function initData() {
            const DB_KEY = 'biblePlan_2026';
            const savedBible = localStorage.getItem(DB_KEY);
            let needRegen = !savedBible;
            if (needRegen) {
                const oldData = localStorage.getItem('biblePlan');
                if (oldData) {
                    try {
                        const oldParsed = JSON.parse(oldData);
                        biblePlan = generateBiblePlan();
                        if (oldParsed.length === biblePlan.length) {
                            oldParsed.forEach((d, i) => { if (d.completed) biblePlan[i].completed = true; });
                        }
                        saveToStorage(DB_KEY, JSON.stringify(biblePlan));
                        needRegen = false;
                    } catch(e) { needRegen = true; }
                }
            }
            if (!needRegen) {
                try {
                    biblePlan = JSON.parse(savedBible);
                    if (!biblePlan || biblePlan.length === 0 || !biblePlan[0].dateStr.includes('-')) { needRegen = true; }
                    if (biblePlan[0].reading && biblePlan[0].reading.includes('undefined')) { needRegen = true; }
                } catch(e) { needRegen = true; }
            }
            if (needRegen) { biblePlan = generateBiblePlan(); saveToStorage(DB_KEY, JSON.stringify(biblePlan)); }
            try { prayers = JSON.parse(localStorage.getItem('prayers')||'[]'); } catch(e){}
            try { goals = JSON.parse(localStorage.getItem('goals')||'[]'); } catch(e){}
            try { userSignals = JSON.parse(localStorage.getItem('userSignals')||'[]'); } catch(e){}
            try { savingsPlan = JSON.parse(localStorage.getItem('savingsPlan')||JSON.stringify(new Array(366).fill(false))); } catch(e){}
            try { wishlist = JSON.parse(localStorage.getItem('wishlist')||'[]'); } catch(e){}
            try { futureLetters = JSON.parse(localStorage.getItem('futureLetters')||'[]'); } catch(e){}
            
            yearlyKeyword = localStorage.getItem('yearlyKeyword')||'';
            refreshDailyWord();
            refreshFinancialEncouragement();
        }

        window.onload = function() {
            generateAppIcons();
            initData();
            loadOnlineQuotes(); loadPreservativePool(); loadFlipQuotes(); loadShieldData(); loadPuaChecklist();
            loadDevotionalContent(); // å•Ÿå‹•æ™‚è¼‰å…¥å°èª
            renderPuaTags(); 
            loadSaltStatusMap().then(()=>setRandomStatus());
            const picker = document.getElementById('journal-date-picker');
            if (picker) { picker.addEventListener('change', (e) => handleJournalDateChange(e.target.value.substring(5))); }
            const checkInBtn = document.getElementById('journal-checkin-btn');
            if (checkInBtn) { checkInBtn.addEventListener('click', () => { const dateKey = picker.value.substring(5); handleCheckIn(dateKey); }); }
            const copyBtn = document.getElementById('copy-btn');
            if(copyBtn) {
                copyBtn.addEventListener('click', () => {
                    let textToCopy = "";
                    if (selectedVerses.size > 0) {
                        const verses = document.querySelectorAll('.verse-row.selected-verse');
                        let buffer = "";
                        verses.forEach(v => {
                             const t = v.getAttribute('data-text');
                             const l = v.getAttribute('data-label');
                             buffer += `${l} ${t}\n`;
                        });
                        textToCopy = buffer;
                    } else { textToCopy = currentFullText; }
                    if(textToCopy) {
                        copyText(textToCopy, selectedVerses.size > 0 ? "å·²è¤‡è£½é¸å–ç¶“æ–‡" : "å·²è¤‡è£½æ•´ç« ç¶“æ–‡");
                        selectedVerses.clear();
                        document.querySelectorAll('.verse-row.selected-verse').forEach(el => el.classList.remove('selected-verse'));
                    } else { showToast("æ²’æœ‰å…§å®¹å¯è¤‡è£½"); }
                });
            }
            // Add listeners for all text areas including new ones (Updated list)
            ['note-scripture', 'note-reflection', 'note-prayer', 'gratitude-text', 'emotion-event', 'emotion-feeling', 'emotion-belief', 'emotion-god-view', 'emotion-prayer', 'mood-text'].forEach(id => {
                const el = document.getElementById(id);
                if(el) { el.addEventListener('input', () => { const dateKey = picker.value.substring(5); saveNote(dateKey, id, el.value); }); }
            });
            document.querySelectorAll('.mood-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    const mood = btn.dataset.mood;
                    const dateKey = picker.value.substring(5);
                    saveNote(dateKey, 'note-mood', mood);
                });
            });
            updateHomeStatus();
            renderSavingsGrid();
            renderWishlist();
            renderEmotionChart();
            checkTimeCapsule(); // Check for letters on load
        };
    </script>
</body>
</html>
