<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>機智的鹹魚生活 | Wise Salted Fish Life</title>
    <meta name="description" content="一個給基督徒的輕鬆靈修與生活小工具，拒絕屬靈焦慮，快樂做鹹魚。">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'm-brown': '#A68C76',
                        'm-brown-light': '#F2EBE5',
                        'm-green': '#8DA399',
                        'm-blue': '#8F9EAC',
                        'm-rose': '#C8A8A4',
                        'text-main': '#5E5A54',
                        'bg-cream': '#FDFCF8'
                    }
                }
            },
            corePlugins: {
                preflight: true, 
            }
        }
    </script>

    <!-- PWA / Icons -->
    <link rel="icon" id="favicon-link" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3Crect width='200' height='200' rx='40' fill='%237CA1B3'/%3E%3Cellipse cx='100' cy='50' rx='60' ry='10' fill='none' stroke='%23D4B483' stroke-width='6'/%3E%3Cpath d='M100 80 C 150 80, 180 110, 180 130 C 180 150, 150 170, 100 170 C 50 170, 20 150, 20 130 C 20 110, 50 80, 100 80 Z' fill='%23FFFFFF'/%3E%3Cpath d='M180 130 L 200 110 L 200 150 Z' fill='%23FFFFFF'/%3E%3Cellipse cx='60' cy='135' rx='10' ry='6' fill='%23FFAB91' opacity='0.8'/%3E%3Cellipse cx='140' cy='135' rx='10' ry='6' fill='%23FFAB91' opacity='0.8'/%3E%3Cg stroke='%237CA1B3' stroke-width='5' stroke-linecap='round'%3E%3Cline x1='75' y1='112' x2='75' y2='128'/%3E%3Cline x1='69' y1='118' x2='81' y2='118'/%3E%3Cline x1='125' y1='112' x2='125' y2='128'/%3E%3Cline x1='119' y1='118' x2='131' y2='118'/%3E%3C/g%3E%3Cline x1='95' y1='145' x2='105' y2='145' stroke='%237CA1B3' stroke-width='5' stroke-linecap='round'/%3E%3C/svg%3E" type="image/svg+xml">
    <link rel="apple-touch-icon" id="apple-icon-link" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3Crect width='200' height='200' fill='%237CA1B3'/%3E%3Cellipse cx='100' cy='50' rx='60' ry='10' fill='none' stroke='%23D4B483' stroke-width='6'/%3E%3Cpath d='M100 80 C 150 80, 180 110, 180 130 C 180 150, 150 170, 100 170 C 50 170, 20 150, 20 130 C 20 110, 50 80, 100 80 Z' fill='%23FFFFFF'/%3E%3Cpath d='M180 130 L 200 110 L 200 150 Z' fill='%23FFFFFF'/%3E%3Cellipse cx='60' cy='135' rx='10' ry='6' fill='%23FFAB91' opacity='0.8'/%3E%3Cellipse cx='140' cy='135' rx='10' ry='6' fill='%23FFAB91' opacity='0.8'/%3E%3Cg stroke='%237CA1B3' stroke-width='5' stroke-linecap='round'%3E%3Cline x1='75' y1='112' x2='75' y2='128'/%3E%3Cline x1='69' y1='118' x2='81' y2='118'/%3E%3Cline x1='125' y1='112' x2='125' y2='128'/%3E%3Cline x1='119' y1='118' x2='131' y2='118'/%3E%3C/g%3E%3Cline x1='95' y1='145' x2='105' y2='145' stroke='%237CA1B3' stroke-width='5' stroke-linecap='round'/%3E%3C/svg%3E">
    <link rel="manifest" href="manifest.json" id="manifest-placeholder">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#FDFCF8">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@300;400;600;700&family=Noto+Sans+TC:wght@300;400;500&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    
    <style>
        /* --- 原本 App 的核心樣式 (保留) --- */
        :root {
            --bg-color: #FDFCF8;
            --card-bg: #FFFFFF;
            --text-primary: #5A524C;
            --text-secondary: #9E9791;
            --accent-blue: #7CA1B3;
            --accent-blue-light: #E8F1F5; 
            --accent-gold: #D4B483;
            --accent-warning: #D98E73;
            --accent-green: #8FB3A3;
            --accent-purple: #B5A3BE;
            --accent-purple-light: #F3EAF5;
            --border-color: #F0EAE4;
            --shadow-soft: 0 10px 40px -10px rgba(90, 82, 76, 0.08);
            --radius-main: 24px;
            --radius-btn: 12px;
            --morandi-green: #8DA399;
            --morandi-pink: #D4A5A5;
            --morandi-bg-gray: #F7F7F7;
            --savings-saved-bg: #5A7D8F; 
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        /* Tailwind Preflight Fixes: 恢復被 Tailwind 重置的標題樣式 */
        h1, h2, h3, h4, h5, h6 { font-size: revert; font-weight: revert; }
        button { background-color: transparent; } /* Reset button for Tailwind but keep defaults */

        html, body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            line-height: 1.7;
            height: 100vh; height: 100dvh; width: 100vw;
            overflow: hidden;
            margin: 0; padding: 0;
            display: flex; flex-direction: column;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%235a524c' fill-opacity='0.03'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z'/%3E%3C/g%3E%3C/svg%3E");
        }

        #scroll-wrapper { 
            flex: 1; 
            overflow-y: auto; 
            overflow-x: hidden; 
            -webkit-overflow-scrolling: touch; 
            width: 100%; 
            height: 100%; 
            position: relative; 
            scroll-behavior: smooth; 
            padding-bottom: 100px; 
        }

        header { text-align: center; padding: 50px 20px 30px; }
        .main-title { font-family: 'Noto Serif TC', serif; font-size: 2rem; font-weight: 700; color: var(--text-primary); letter-spacing: 0.05em; margin-bottom: 6px; }
        .subtitle { font-family: 'Noto Sans TC', sans-serif; font-size: 0.85rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.2em; }
        
        /* 預設容器寬度限制 - 僅在非靈修模式時使用 */
        main.container-limited { padding: 0 20px; max-width: 500px; margin: 0 auto; width: 100%; display: flex; flex-direction: column; }
        /* 靈修模式時使用全寬 */
        main.container-full { width: 100%; height: 100%; padding: 0; overflow: hidden; display: flex; flex-direction: column; }
        /* Mobile Scroll Override for Devotion Mode */
        @media (max-width: 1024px) {
            main.container-full {
                overflow-y: auto; /* Allow scrolling on main container on mobile */
                height: auto;
                min-height: 100%;
                display: block; /* Break flex layout for scrolling */
                padding-bottom: 120px; /* 增加底部留白，避免被導覽列遮擋 */
            }
            body.devotion-mode #scroll-wrapper {
                overflow-y: auto; /* 確保外層也能捲動 */
            }
        }

        .card { background: var(--card-bg); border-radius: var(--radius-main); padding: 30px; box-shadow: var(--shadow-soft); text-align: center; margin-bottom: 25px; border: 1px solid var(--border-color); transition: transform 0.3s ease; position: relative; overflow: hidden; }
        .card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: linear-gradient(90deg, transparent, var(--accent-blue), transparent); opacity: 0.5; }

        .mascot-container { width: 140px; height: 140px; margin: 0 auto 20px; position: relative; }
        .mascot-svg { width: 100%; height: 100%; animation: float 3.5s ease-in-out infinite; filter: drop-shadow(0 10px 15px rgba(124, 161, 179, 0.3)); }
        .halo { transform-origin: center; animation: halo-glow 3s ease-in-out infinite alternate; }
        .eye { transform-origin: center; animation: blink 4s infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-8px) rotate(1deg); } }
        @keyframes halo-glow { 0% { opacity: 0.6; stroke-width: 2px; } 100% { opacity: 1; stroke-width: 3px; } }
        @keyframes blink { 0%, 48%, 52%, 100% { transform: scaleY(1); } 50% { transform: scaleY(0.1); } }

        /* General UI Elements */
        h2 { font-family: 'Noto Serif TC', serif; font-size: 1.4rem; color: var(--text-primary); margin-bottom: 15px; }
        p { color: var(--text-primary); font-weight: 300; }
        .text-muted { color: var(--text-secondary); font-size: 0.9rem; }
        
        .btn-primary { background: var(--text-primary); color: white; border: none; padding: 14px 30px; border-radius: 50px; font-size: 1rem; cursor: pointer; font-weight: 500; width: 100%; transition: all 0.2s ease; box-shadow: 0 4px 15px rgba(90, 82, 76, 0.2); }
        .btn-primary:active { transform: scale(0.97); }
        .btn-icon { background: transparent; border: none; cursor: pointer; padding: 8px; color: var(--accent-blue); transition: transform 0.2s; display: inline-flex; align-items: center; justify-content: center; }
        .btn-icon:hover { background-color: var(--accent-blue-light); border-radius: 50%; }

        .preservative-btn { background: white; border: 1px solid var(--accent-green); color: var(--accent-green); padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; cursor: pointer; margin-bottom: 15px; display: inline-flex; align-items: center; gap: 5px; transition: all 0.2s; }
        .preservative-box { font-family: 'Noto Serif TC', serif; font-size: 1rem; color: var(--text-primary); min-height: 40px; margin-bottom: 15px; font-style: italic; opacity: 0; transition: opacity 0.5s; }

        .bible-plan-panel { margin-top: 25px; padding-top: 20px; border-top: 1px dashed var(--border-color); text-align: left; }
        .panel-desc { font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 15px; font-weight: 400; font-style: italic; line-height: 1.6; }
        .progress-bar-bg { background: #eee; border-radius: 10px; height: 16px; overflow: hidden; width: 100%; margin-bottom: 10px; position: relative; }
        .progress-bar-fill { background: linear-gradient(90deg, var(--accent-blue), #A3C4BC); height: 100%; width: 0%; transition: width 1.5s cubic-bezier(0.22, 1, 0.36, 1); border-radius: 10px; }
        .progress-info { background: #FAFAFA; padding: 15px; border-radius: 15px; border: 1px solid var(--border-color); margin-bottom: 15px; }
        .progress-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; font-size: 0.9rem; color: var(--text-primary); }
        
        .progress-quote { font-size: 0.9rem; color: var(--accent-blue); font-style: italic; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #eee; display: flex; align-items: flex-start; gap: 5px; cursor: pointer; transition: color 0.2s; }
        .progress-quote:hover { color: var(--accent-green); }
        .refresh-icon { font-size: 1.1rem; opacity: 0.7; margin-top: 1px; margin-left: 5px; }

        .check-in-btn { background: var(--accent-blue); color: white; border: none; padding: 10px 0; border-radius: 30px; font-size: 0.9rem; cursor: pointer; width: 100%; box-shadow: 0 4px 10px rgba(124, 161, 179, 0.3); transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .check-in-btn.checked { background: var(--accent-green); cursor: default; }

        /* --- Devotion Section Specifics (NEW JOURNAL UI) --- */
        /* 文青風標題與經文專用字體 */
        .serif-font, .bible-text { font-family: 'Noto Serif TC', serif; }
        .bible-text { line-height: 2.2; font-size: 1.15rem; letter-spacing: 0.05em; }

        /* 自定義滾動條 - 極簡細線 */
        .journal-scroll::-webkit-scrollbar { width: 5px; height: 5px; }
        .journal-scroll::-webkit-scrollbar-track { background: transparent; }
        .journal-scroll::-webkit-scrollbar-thumb { background-color: #D6D0C8; border-radius: 10px; }
        .journal-scroll::-webkit-scrollbar-thumb:hover { background-color: #A68C76; }

        /* 載入動畫 */
        .loader { border: 2px solid #F2EBE5; border-top: 2px solid #A68C76; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* 心情選擇器樣式 */
        .mood-btn.active { transform: scale(1.25); opacity: 1; filter: grayscale(0%) drop-shadow(0 2px 4px rgba(166, 140, 118, 0.2)); background-color: #fff; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .mood-btn { opacity: 0.6; filter: grayscale(80%); transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
        .mood-btn:hover { opacity: 1; filter: grayscale(0%); transform: scale(1.1); background-color: #fff; }

        /* Other App Sections */
        .flip-container { perspective: 1000px; width: 100%; height: 340px; cursor: pointer; }
        .flipper { position: relative; width: 100%; height: 100%; transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform-style: preserve-3d; }
        .flip-container.flipped .flipper { transform: rotateY(180deg); }
        .front, .back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: var(--radius-main); box-shadow: var(--shadow-soft); background: var(--card-bg); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; border: 1px solid var(--border-color); }
        .back { transform: rotateY(180deg); background: #FDFBF7; border: 2px solid var(--accent-blue); }
        .quote-content { font-family: 'Noto Serif TC', serif; font-size: 1.25rem; margin-bottom: 20px; color: var(--text-primary); line-height: 1.6; text-align: center; }
        .result-box { background: var(--accent-blue-light); border-radius: var(--radius-btn); padding: 25px; margin-top: 20px; margin-bottom: 10px; min-height: 120px; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; opacity: 0; transition: all 0.5s ease; border: 1px solid var(--border-color); color: var(--text-primary); font-family: 'Noto Serif TC', serif; font-size: 1.1rem; position: relative; overflow: hidden; }
        .pua-result-box { background: #F8F5FA; border: 1px solid var(--accent-purple); border-radius: var(--radius-btn); padding: 20px; margin-top: 20px; text-align: left; opacity: 0; transition: opacity 0.5s; }
        .pua-label { font-size: 0.8rem; color: var(--accent-purple); font-weight: bold; margin-bottom: 5px; display: block; text-transform: uppercase; letter-spacing: 1px; }
        .pua-content { font-size: 1rem; color: var(--text-primary); margin-bottom: 15px; line-height: 1.5; }
        .pua-level-badge { font-size: 0.75rem; padding: 4px 10px; border-radius: 12px; background-color: #F3EAF5; color: var(--accent-purple); font-weight: bold; display: none; border: 1px solid rgba(181, 163, 190, 0.3); }
        
        /* Other specific components */
        .tab-switcher { display: flex; background: #F2F2F2; padding: 5px; border-radius: 50px; margin-bottom: 25px; gap: 2px; }
        .tab-btn { flex: 1; border: none; background: transparent; padding: 10px 5px; border-radius: 40px; color: var(--text-secondary); cursor: pointer; font-size: 0.85rem; transition: all 0.3s; font-weight: 500; white-space: nowrap;}
        .tab-btn.active { background: white; color: var(--text-primary); shadow: 0 2px 5px rgba(0,0,0,0.05); font-weight: bold; }
        .sub-section { display: none; animation: fadeIn 0.3s ease; }
        .sub-section.active { display: block; }
        
        /* Grid removed from CSS to allow JS dynamic rendering with Tailwind */
        .ai-encourage-box { background: rgba(255,255,255,0.7); border: 1px dashed var(--accent-blue); padding: 15px; border-radius: 15px; margin-top: 20px; font-size: 0.9rem; color: var(--text-primary); text-align: center; font-family: 'Noto Serif TC', serif; font-style: italic; }
        
        .pua-tags-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .pua-tag-container, .decision-tag-container, .shield-tag-container { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; }
        .pua-tag, .decision-tag, .shield-tag { background-color: #f0f0f0; border: 1px solid #ddd; border-radius: 20px; padding: 8px 16px; font-size: 0.9rem; color: var(--text-primary); cursor: pointer; transition: all 0.2s; user-select: none; }
        .pua-tag:hover, .decision-tag:hover, .shield-tag:hover { background-color: #e0e0e0; }
        .pua-tag.selected { background-color: var(--accent-purple); color: white; border-color: var(--accent-purple); box-shadow: 0 4px 10px rgba(181, 163, 190, 0.4); }
        .decision-tag.selected { background-color: var(--accent-blue); color: white; border-color: var(--accent-blue); box-shadow: 0 4px 10px rgba(124, 161, 179, 0.4); }
        .shield-tag.selected { background-color: var(--accent-warning); color: white; border-color: var(--accent-warning); box-shadow: 0 4px 10px rgba(217, 142, 115, 0.4); }
        .refresh-pua-btn, .refresh-decision-btn, .refresh-shield-btn { background: transparent; padding: 4px 12px; border-radius: 15px; font-size: 0.8rem; cursor: pointer; transition: all 0.2s; border: 1px solid currentColor; }
        .refresh-pua-btn { color: var(--accent-purple); } .refresh-decision-btn { color: var(--accent-blue); } .refresh-shield-btn { color: var(--accent-warning); }
        
        .feedback-section { margin-top: 60px; padding-top: 20px; border-top: 1px dashed var(--border-color); text-align: center; }
        .feedback-text { font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 15px; }
        .btn-line { background-color: transparent; color: var(--accent-purple); border: 1px solid var(--accent-purple); padding: 10px 20px; border-radius: 50px; font-size: 0.9rem; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; transition: all 0.3s ease; font-weight: 500; }
        .btn-line:hover { background-color: var(--accent-purple); color: white; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); backdrop-filter: blur(3px); z-index: 2000; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; }
        .modal-overlay.show { display: flex; opacity: 1; }
        .modal-content { background: white; width: 85%; max-width: 350px; padding: 30px; border-radius: 30px; text-align: center; transform: scale(0.9); transition: transform 0.3s; box-shadow: 0 20px 60px rgba(0,0,0,0.1); max-height: 85vh; overflow-y: auto; }
        .modal-overlay.show .modal-content { transform: scale(1); }
        
        /* Help Modal Specifics */
        #help-modal .modal-content { max-width: 600px; text-align: left; }
        #help-modal h2 { font-size: 1.5rem; font-weight: 700; color: var(--text-primary); margin-bottom: 1rem; border-bottom: 2px solid var(--accent-blue); padding-bottom: 0.5rem; font-family: 'Noto Serif TC', serif; }
        #help-modal h3 { font-size: 1.1rem; font-weight: 600; color: var(--accent-blue); margin-top: 1.5rem; margin-bottom: 0.5rem; }
        #help-modal h4 { font-size: 1rem; font-weight: 600; color: var(--text-primary); margin-top: 1rem; margin-bottom: 0.25rem; }
        #help-modal p, #help-modal li { font-size: 0.95rem; color: var(--text-primary); line-height: 1.6; margin-bottom: 0.5rem; }
        #help-modal ul { list-style-type: disc; padding-left: 1.5rem; }
        #help-modal strong { color: #A68C76; }

        /* Bottom Nav Fixes */
        .bottom-nav {
            position: fixed !important;
            bottom: 20px !important;
            bottom: calc(20px + env(safe-area-inset-bottom)) !important;
            left: 50% !important;
            transform: translateX(-50%) !important;
            background: #ffffff !important; /* Fallback */
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(10px);
            border: 1px solid #e5e7eb !important;
            padding: 8px 4px !important;
            border-radius: 50px !important;
            display: flex !important;
            gap: 2px !important;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15) !important;
            z-index: 999999 !important; /* Higher z-index */
            width: 95% !important;
            max-width: 460px !important;
            justify-content: space-between !important;
            align-items: center !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        footer { text-align: center; font-size: 0.75rem; color: #CCC; padding-bottom: 90px; padding-top: 20px; display: flex; flex-direction: column; align-items: center; gap: 15px; border-top: 1px dashed var(--border-color); margin-top: 20px; width: 90%; margin-left: auto; margin-right: auto; }
        .social-links, .contact-links { display: flex; justify-content: center; align-items: center; gap: 20px; }
        .contact-section { display: flex; flex-direction: column; align-items: center; gap: 8px; margin-top: 5px; }
        .icon-link { color: var(--text-secondary); transition: color 0.3s, transform 0.2s; display: flex; align-items: center; justify-content: center; }
        .icon-link:hover { color: var(--accent-blue); transform: translateY(-2px); }
        .icon-link svg { width: 24px; height: 24px; }
        .contact-label { font-size: 0.8rem; color: var(--text-secondary); font-weight: 500; letter-spacing: 1px; }
        .ai-note { font-size: 0.7rem; color: #9E9791; margin-bottom: 8px; font-style: italic; }

        .nav-item { padding: 8px 2px; flex: 1 0 auto; border-radius: 40px; border: none; background: transparent; color: var(--text-secondary); font-size: 0.7rem; font-weight: 500; cursor: pointer; transition: all 0.3s; white-space: nowrap; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px; min-width: 50px; }
        .nav-item.active { background: var(--text-primary); color: white; font-weight: bold; }
        .nav-item svg { width: 20px; height: 20px; margin-bottom: 2px; }
        .bottom-nav::-webkit-scrollbar { display: none; }
        
        .section { display: none; animation: fadeIn 0.4s ease forwards; flex: 1; }
        .section.active { display: flex; flex-direction: column; } /* Adjusted for flex layouts */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: rgba(90, 82, 76, 0.9); color: white; padding: 10px 20px; border-radius: 50px; font-size: 0.9rem; z-index: 2005; transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 5px 15px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 8px; }
        .toast.show { transform: translateX(-50%) translateY(0); }
        .global-footer-quote { text-align: center; font-size: 0.85rem; color: #D1D1D1; padding: 20px 20px 40px; line-height: 2; letter-spacing: 0.05em; font-style: italic; width: 100%; pointer-events: none; }
        
        /* 隱藏 App Shell 標頭，當處於靈修模式時 (因為有自己的 Header) */
        body.devotion-mode > #scroll-wrapper > header { display: none !important; }
        body.devotion-mode .global-footer-quote { display: none; }
        /* 靈修模式下 Main 需要全寬 */
        body.devotion-mode #app-main { padding: 0; max-width: 100%; height: 100%; overflow: hidden; }
        body.devotion-mode #scroll-wrapper { overflow: hidden; } /* 禁止外層捲動，改用內部捲動 */
        
        /* 輸入框 placeholder 顏色修正 */
        input::placeholder, textarea::placeholder { color: #D6D0C8; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* quote-comment override to avoid border */
        #quote-comment { font-size: 0.85rem; color: var(--accent-blue); font-style: italic; width: 85%; } 

        /* Selected Verse Style */
        .selected-verse { background-color: #F3EAF5 !important; border-left: 3px solid #B5A3BE; }
    </style>
</head>
<body>

    <!-- 內部捲動容器 (App Shell) -->
    <div id="scroll-wrapper">
        <header>
            <h1 class="main-title">機智的鹹魚生活</h1>
            <div class="subtitle">Wise Salted Fish Life</div>
            <!-- Move Banner Here -->
            <div onclick="showHelpModal()" class="mt-4 inline-block px-4 py-2 bg-[#F9F7F5] border border-[#EBE6DE] rounded-lg cursor-pointer hover:bg-[#F2EBE5] transition-colors shadow-sm group">
                <p class="text-xs text-[#94908A] group-hover:text-[#A68C76] tracking-widest flex items-center justify-center gap-1 transition-colors">
                    <span class="animate-pulse">⚠️</span> 投資天國穩賺不賠，醃漬前請詳閱 <span class="underline decoration-dotted underline-offset-4 font-bold ml-1">公開說明書 🔗</span>
                </p>
            </div>
        </header>

        <main id="app-main" class="container-limited">
            <!-- 首頁 -->
            <section id="home" class="section active">
                <div class="card">
                    
                    <div style="position: absolute; top: 20px; right: 20px; background: var(--accent-blue); color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem;">鹹魚鹽度監測中</div>
                    <div class="mascot-container">
                        <svg class="mascot-svg" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                            <ellipse class="halo" cx="100" cy="50" rx="60" ry="10" fill="none" stroke="#D4B483" stroke-width="6" />
                            <path d="M100 80 C 150 80, 180 110, 180 130 C 180 150, 150 170, 100 170 C 50 170, 20 150, 20 130 C 20 110, 50 80, 100 80 Z" fill="#7CA1B3" />
                            <path d="M180 130 L 200 110 L 200 150 Z" fill="#7CA1B3" />
                            <ellipse cx="60" cy="135" rx="10" ry="6" fill="#FFAB91" opacity="0.7" />
                            <ellipse cx="140" cy="135" rx="10" ry="6" fill="#FFAB91" opacity="0.7" />
                            <g class="eye">
                                <line x1="75" y1="112" x2="75" y2="128" stroke="white" stroke-width="3" stroke-linecap="round"/><line x1="69" y1="118" x2="81" y2="118" stroke="white" stroke-width="3" stroke-linecap="round"/>
                                <line x1="125" y1="112" x2="125" y2="128" stroke="white" stroke-width="3" stroke-linecap="round"/><line x1="119" y1="118" x2="131" y2="118" stroke="white" stroke-width="3" stroke-linecap="round"/>
                            </g>
                            <line x1="95" y1="145" x2="105" y2="145" stroke="white" stroke-width="3" stroke-linecap="round"/>
                        </svg>
                    </div>
                    <h2 id="daily-status-title">鹹魚鹽度探測中...</h2>
                    <p id="daily-status-desc" class="text-muted" style="margin-bottom: 15px;">請保持呼吸，正在計算你與天國的距離...</p>
                    <div style="margin-bottom: 20px;">
                        <button class="preservative-btn" onclick="getPreservative()">⚠️ 領取屬靈防腐劑 (急救用)</button>
                        <div id="preservative-display" class="preservative-box"></div>
                    </div>
                    
                    <div class="bible-plan-panel">
                        <h3 style="font-family:'Noto Serif TC'; font-size:1.1rem; margin-bottom:5px;">鹹魚醃漬中</h3>
                        <p class="panel-desc">「立志做一條用聖經醃漬的鹹魚！每天撒點鹽（讀經），生活會更香喔。」</p>
                        <div class="progress-bar-bg"><div id="bible-progress" class="progress-bar-fill"></div></div>
                        <div class="progress-info">
                            <div class="progress-row">
                                <span style="display: flex; align-items: center; gap: 5px;">📅 <span id="current-date-text">--/--</span></span> 
                                <span id="percent-text" style="font-weight:bold; color:var(--accent-blue);">0% 入味</span>
                            </div>
                            <div class="progress-row" style="justify-content: flex-start;">📖 本日進度：<span id="plan-scope-text" style="font-weight: bold; margin-left: 5px;">--</span></div>
                            <div class="progress-row" style="justify-content: flex-start;">🧂 本日加鹽量：<span id="today-salt-stars" style="margin-left: 5px; color: var(--accent-gold); letter-spacing: 2px;"></span></div>
                            
                            <div class="progress-quote" id="daily-word" onclick="refreshDailyWord()" title="點擊重刷小語">
                                <span>💬 本日醃漬小語...</span>
                                <span class="refresh-icon">↻</span>
                            </div>
                        </div>
                        <button class="check-in-btn" onclick="showSection('devotion', document.querySelector('#nav-devotion'))">前往醃漬打卡 ➜</button>
                    </div>

                    <!-- 資料保險箱 (恢復顯示) -->
                    <div class="mt-6 pt-4 border-t border-dashed border-[#EBE6DE] text-center">
                        <p class="text-xs text-[#94908A] mb-2">資料保險箱</p>
                        <div class="flex justify-center gap-2">
                            <button onclick="exportData()" class="text-xs border border-[#EBE6DE] rounded-lg px-3 py-1 text-[#5E5A54] hover:bg-[#F2EBE5]">匯出備份</button>
                            <button onclick="document.getElementById('import-file').click()" class="text-xs border border-[#EBE6DE] rounded-lg px-3 py-1 text-[#5E5A54] hover:bg-[#F2EBE5]">匯入備份</button>
                            <input type="file" id="import-file" style="display: none;" onchange="importData(this)">
                        </div>
                    </div>
                </div>
            </section>

            <!-- 靈修 (Devotion) - NEW JOURNAL UI -->
            <section id="devotion" class="section h-full w-full bg-[#FDFCF8]">
                <!-- 內嵌的靈修內室 UI -->
                <div class="h-full flex flex-col w-full">
                    <!-- 頂部導覽列 (Journal Style) -->
                    <header class="bg-white/80 backdrop-blur-md border-b border-[#EBE6DE] sticky top-0 z-20 shrink-0 w-full" style="display:block!important; padding: 0;">
                        <div class="max-w-7xl mx-auto px-4 md:px-6 flex justify-between items-center h-16 gap-3 md:gap-6">
                            <!-- Logo & Date -->
                            <div class="flex items-center gap-3 shrink-0">
                                <div class="flex items-center gap-2">
                                    <span class="text-2xl opacity-80">🐟</span>
                                    <!-- 修復：強制顯示標題，移除 hidden class -->
                                    <h1 class="block text-lg font-bold tracking-widest text-[#5E5A54] m-0">醃漬鹹魚</h1>
                                </div>
                                <div class="flex items-center bg-[#F9F7F5] rounded-full px-3 py-1.5 border border-[#EBE6DE] hover:border-[#D6D0C8] transition-colors">
                                    <input type="date" id="journal-date-picker" class="bg-transparent border-none text-xs md:text-sm font-medium focus:ring-0 outline-none cursor-pointer w-[110px] md:w-auto text-[#5E5A54]">
                                    <button id="journal-checkin-btn" class="ml-2 text-xs text-gray-400 hover:text-m-green" title="打卡完成">✔️</button>
                                </div>
                            </div>

                            <!-- 儲存狀態 -->
                            <div class="flex items-center shrink-0 w-16 justify-end hidden md:flex">
                                <div id="save-status" class="text-xs font-medium text-[#8DA399] opacity-0 transition-opacity duration-500 flex items-center gap-1 bg-[#8DA399]/10 px-3 py-1 rounded-full tracking-wider">
                                    <span>SAVED</span>
                                </div>
                            </div>
                        </div>
                    </header>

                    <!-- 主要內容區 -->
                    <div class="flex-1 w-full max-w-7xl mx-auto p-4 md:p-8 grid grid-cols-1 lg:grid-cols-12 gap-8 overflow-y-auto lg:overflow-hidden relative">
                        
                        <!-- 左欄：讀經進度 (Desktop) -->
                        <aside class="hidden lg:flex lg:col-span-2 flex-col gap-4 overflow-hidden h-full">
                            <div class="h-full flex flex-col">
                                <h3 class="text-xs font-semibold text-[#94908A] uppercase tracking-[0.2em] mb-4 pl-1 shrink-0">Reading Plan</h3>
                                <div class="flex-1 overflow-y-auto pr-2 pl-1 pb-4 space-y-4 journal-scroll" id="plan-list">
                                    <!-- JS 生成 -->
                                </div>
                            </div>
                        </aside>

                        <!-- 手機版進度選單 -->
                        <div class="lg:hidden col-span-1 bg-[#FDFCF8] p-4 rounded-xl border border-[#EBE6DE] shadow-sm overflow-x-auto whitespace-nowrap flex gap-2 no-scrollbar items-center shrink-0 min-h-[100px]" id="mobile-plan-list">
                            <!-- JS 生成 -->
                        </div>

                        <!-- 整合區：閱讀/筆記區塊 -->
                        <section class="lg:col-span-10 flex flex-col bg-white rounded-2xl shadow-[0_4px_20px_-10px_rgba(0,0,0,0.05)] border border-[#EBE6DE] overflow-hidden min-h-[500px] lg:h-full relative group">
                            <div class="h-1 w-full bg-[#F2EBE5] shrink-0"></div>
                            
                            <!-- BIBLE READER VIEW -->
                            <div id="view-reader" class="flex flex-col h-full">
                                <div class="px-8 py-5 border-b border-[#F5F2EA] flex justify-between items-start bg-white sticky top-0 z-10 shrink-0">
                                    <div class="flex flex-col gap-1 overflow-hidden">
                                        <span class="text-[10px] font-bold text-[#A68C76] uppercase tracking-widest" id="bible-book-tag">SCRIPTURE</span>
                                        <h2 id="bible-title" class="text-xl text-[#5E5A54] font-medium tracking-wide truncate pr-2 m-0">請選擇進度</h2>
                                    </div>
                                    <button id="copy-btn" class="hidden flex items-center gap-1.5 px-3 py-1.5 text-[#94908A] hover:text-[#A68C76] hover:bg-[#FAF9F6] rounded-lg text-xs transition-all tracking-widest shrink-0">
                                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                                        複製
                                    </button>
                                </div>
                                <div id="bible-content" class="flex-1 overflow-y-auto p-8 bible-text text-[#5E5A54] bg-white scroll-smooth selection:bg-[#F2EBE5] selection:text-[#5E5A54] journal-scroll min-h-[300px] lg:h-auto flex flex-col justify-center">
                                    <div class="h-full flex flex-col items-center justify-center text-[#B0AAA3] gap-6 text-center">
                                        <div class="w-20 h-20 rounded-full bg-[#FDFCF8] border border-[#F2EBE5] flex items-center justify-center">
                                            <span class="text-3xl opacity-40 grayscale">📖</span>
                                        </div>
                                        <div>
                                            <p class="text-base font-serif text-[#94908A] whitespace-normal px-4">準備好被醃漬了嗎？</p>
                                            <p class="text-xs mt-2 font-light tracking-wider opacity-60 whitespace-normal px-4">點擊上方進度，讓神的話語慢慢入味。</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- NOTE VIEW (Hidden by default) -->
                            <div id="view-note" class="flex flex-col h-full hidden">
                                <div class="px-8 py-5 border-b border-[#F5F2EA] flex flex-col gap-4 shrink-0">
                                    <div class="flex items-center justify-between">
                                        <h3 class="font-serif text-lg text-[#5E5A54] flex items-center gap-3 m-0">
                                            <span class="text-lg opacity-60">✍🏻</span> 醃漬筆記
                                        </h3>
                                        <div class="flex items-center gap-3">
                                            <button onclick="shareNote()" class="text-xs text-[#A68C76] hover:text-[#5E5A54] transition-colors font-medium tracking-widest px-2 py-1 hover:bg-[#F9F7F5] rounded">分享</button>
                                            <button onclick="downloadNote()" class="text-xs text-[#A68C76] hover:text-[#5E5A54] transition-colors font-medium tracking-widest px-2 py-1 hover:bg-[#F9F7F5] rounded">下載</button>
                                        </div>
                                    </div>
                                    <div class="mood-selector-container rounded-xl p-2.5 flex items-center justify-between gap-2">
                                        <span class="text-[10px] font-bold text-[#A68C76] uppercase tracking-widest pl-2">MOOD</span>
                                        <div class="flex items-center gap-2 md:gap-3" id="mood-selector">
                                            <button class="mood-btn text-lg" data-mood="☀️" title="充滿盼望">☀️</button>
                                            <button class="mood-btn text-lg" data-mood="☁️" title="平靜安穩">☁️</button>
                                            <button class="mood-btn text-lg" data-mood="🌧️" title="低谷/憂傷">🌧️</button>
                                            <button class="mood-btn text-lg" data-mood="🔥" title="火熱/渴慕">🔥</button>
                                            <button class="mood-btn text-lg" data-mood="🌱" title="更新/成長">🌱</button>
                                        </div>
                                        <input type="hidden" id="note-mood">
                                    </div>
                                </div>
                                <div class="flex-1 overflow-y-auto p-8 space-y-8 bg-white selection:bg-[#F2EBE5] journal-scroll">
                                    <div class="group relative pl-4 border-l-2 border-[#C8A8A4]/30 focus-within:border-[#C8A8A4] transition-colors">
                                        <label class="block text-xs font-bold text-[#C8A8A4] uppercase mb-2 tracking-widest">Rhema / 感動</label>
                                        <textarea id="note-scripture" placeholder="點選左側經文，或是手動輸入那些讓你心頭一震的話..." class="w-full bg-transparent border-none p-0 focus:ring-0 outline-none bible-text text-base min-h-[100px] resize-none placeholder-[#D6D0C8] text-[#5E5A54]"></textarea>
                                    </div>
                                    <div class="group relative pl-4 border-l-2 border-[#8F9EAC]/30 focus-within:border-[#8F9EAC] transition-colors">
                                        <label class="block text-xs font-bold text-[#8F9EAC] uppercase mb-2 tracking-widest">Reflection / 領受</label>
                                        <textarea id="note-reflection" placeholder="隨筆記錄心中的感動，這些都是恩典的結晶..." class="w-full bg-transparent border-none p-0 focus:ring-0 outline-none text-[#5E5A54] min-h-[140px] resize-none placeholder-[#D6D0C8] leading-relaxed font-light"></textarea>
                                    </div>
                                    <div class="group relative pl-4 border-l-2 border-[#8DA399]/30 focus-within:border-[#8DA399] transition-colors">
                                        <label class="block text-xs font-bold text-[#8DA399] uppercase mb-2 tracking-widest">Prayer / 禱告</label>
                                        <textarea id="note-prayer" placeholder="與大老闆的私密對話時間..." class="w-full bg-transparent border-none p-0 focus:ring-0 outline-none text-[#5E5A54] min-h-[100px] resize-none placeholder-[#D6D0C8] leading-relaxed font-light"></textarea>
                                    </div>

                                    <!-- 新增：分隔線與匯出區塊 -->
                                    <div class="h-px w-full bg-[#F2EBE5] my-6"></div>
                                    <div class="text-center pb-8">
                                        <p class="text-xs text-[#94908A] font-serif mb-4 italic tracking-wider">這份感動值得被永久珍藏...</p>
                                        <button onclick="downloadNote()" class="bg-[#F2EBE5] text-[#5E5A54] hover:bg-[#EBE6DE] px-6 py-2 rounded-full text-sm font-medium tracking-widest transition-all shadow-sm hover:shadow-md">
                                            匯出日記
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </section>
                    </div>
                </div>
            </section>

            <!-- 鹹魚翻身 -->
            <section id="flip" class="section">
                <div class="card">
                    <div class="flip-container" onclick="flipCard()">
                        <div class="flipper" id="flipper">
                            <div class="front">
                                <div style="font-size: 3rem; margin-bottom: 15px;">🍞</div>
                                <h3 style="font-family: 'Noto Serif TC';">鹹魚翻身</h3>
                                <p class="text-muted" style="margin-top: 10px;">點擊卡片，請主廚為你上一道入味的翻身特餐</p>
                                <p class="text-muted" style="font-size: 0.8rem;">(含 30% 鹹魚雞湯，與 100% 上帝純淨恩典)</p>
                            </div>
                            <div class="back">
                                <p class="quote-content" id="quote-content">正在後台熬製亮光...</p>
                                <p id="quote-source" class="text-muted" style="font-weight:500;">--</p>
                                <div style="width: 40%; height: 1px; border-top: 1px dashed #D6D0C8; margin: 30px auto;"></div>
                                <p id="quote-comment"> </p>
                                <!-- 修改按鈕 -->
                                <button class="btn-icon" onclick="saveCardImage(event)" style="margin-top:25px; font-weight:bold;">📸 拍立得打包 (存圖)</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 聰明鹹魚 (原 游刃有魚) -->
            <section id="pua" class="section">
                <div class="card">
                    <h2>聰明鹹魚</h2>
                    <div class="text-muted" style="margin-bottom: 45px;">
                        <p><strong>拒絕被裝進宗教罐頭！</strong></p>
                        <p>讓你識破套路，找回自由。</p>
                    </div>
                    
                    <div class="pua-tags-header">
                        <label class="label" style="margin-bottom: 0;">你剛才聽到了哪句「金句」？</label>
                        <button class="refresh-pua-btn" onclick="renderPuaTags()">🔄 換一批</button>
                    </div>
                    
                    <div id="pua-tag-container" class="pua-tag-container">
                        <!-- JS 將自動填入標籤 -->
                    </div>

                    <button class="btn-primary" onclick="detectPUA()" style="background-color: var(--accent-purple);">啟動翻譯蒟蒻</button>
                    
                    <div class="pua-result-box" id="pua-result">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span class="pua-label">人話翻譯機</span>
                            <span id="pua-level" class="pua-level-badge"></span>
                        </div>
                        <p class="pua-content" id="pua-translation" style="font-weight: bold;">--</p>
                        <span class="pua-label">鹹魚反擊 (內心 OS)：</span>
                        <p class="pua-content" id="pua-defense">--</p>
                    </div>

                    <p style="font-size: 0.75rem; color: #D98E73; margin-top: 15px; margin-bottom: 25px; font-style: italic; line-height: 1.5;">
                        ⚠️ 警語：本翻譯由 AI 生成僅供娛樂，不代表每個人這樣說的意思都是這樣。請謹慎分辨，不要對號入座，也不要以此論斷別人。
                    </p>

                    <button class="btn-secondary" onclick="togglePuaTest()" style="margin-top:25px; border-radius:50px; background:#F8F8F8; padding:12px; border:none; width:100%; cursor:pointer; font-weight:500;">🧬 屬靈 PUA 病毒快篩</button>
                    
                    <div id="pua-test-area" class="pua-test-area" style="display:none; background:white; border:1px solid var(--border-color); border-radius:var(--radius-main); padding:20px; margin-top:20px; text-align:left;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:15px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                            <span style="font-weight:bold; color: var(--accent-purple);">環境 PUA 毒性檢測 (7題)</span>
                            <button onclick="initPuaTest()" style="border:none; background:none; cursor:pointer; color: var(--text-secondary); font-size: 0.8rem;">🔄 換一組試劑</button>
                        </div>
                        <div id="test-list"></div>
                        <button class="btn-primary" onclick="runPuaTest()" style="margin-top:15px; background-color: var(--accent-purple);">生成診斷報告</button>
                        <div id="test-result" class="test-result" style="display:none; margin-top:15px;"></div>
                    </div>

                    <!-- 新增：PUA 回饋區塊 -->
                    <div class="feedback-section">
                        <p class="feedback-text">還有聽過更扯的？歡迎回饋給主廚！</p>
                        <a href="https://line.me/R/ti/p/@469cjlho" target="_blank" rel="noopener noreferrer" class="btn-line">💬 加 LINE 投稿 PUA 金句</a>
                    </div>
                </div>
            </section>

            <!-- 修改：將游刃有魚 (Shield) 移到 綽綽有魚 (Flow) 之前 -->
            <section id="shield" class="section">
                <div class="card">
                    <h2>游刃有魚</h2>
                    <div class="text-muted" style="margin-bottom: 40px;">
                        <p>面對讓人翻白眼的提問，這裡有讓你優雅脫身的鹹魚智慧。</p>
                    </div>
                    
                    <div class="pua-tags-header">
                        <label class="label" style="margin-bottom: 0;">當對方問你這些尷尬問題時：</label>
                        <button class="refresh-shield-btn" onclick="renderShieldTags()">🔄 換一批</button>
                    </div>

                    <div id="shield-tag-container" class="shield-tag-container">
                          <!-- JS 自動填入標籤 -->
                    </div>

                    <button class="btn-primary" onclick="getExcuse()">生成神回覆</button>
                    <div class="result-box" id="shield-result"><p id="shield-text" style="font-family: 'Noto Serif TC';"></p></div>

                    <!-- 新增：Shield 回饋區塊 -->
                    <div class="feedback-section" style="margin-top: 30px;">
                        <p class="feedback-text">遇過更讓人翻白眼的問題？</p>
                        <a href="https://line.me/R/ti/p/@469cjlho" target="_blank" rel="noopener noreferrer" class="btn-line" style="color: var(--accent-warning); border-color: var(--accent-warning);">💬 加 LINE 投稿尷尬問題</a>
                    </div>
                </div>
            </section>

            <section id="flow" class="section">
                <div class="card">
                    <h2>綽綽有魚</h2>
                    <div class="text-muted" style="margin-bottom: 20px;">
                        <p>即使在躺平的時刻，恩典依然綽綽有餘。</p>
                    </div>
                    
                    <div class="tab-switcher">
                        <button class="tab-btn active" onclick="switchFlowTab('savings')">💰 365 存錢</button>
                        <button class="tab-btn" onclick="switchFlowTab('wishlist')">✨ 願望清單</button>
                    </div>

                    <!-- 365 存錢分頁 -->
                    <div id="tab-savings" class="sub-section active">
                        <div style="text-align: left; margin-bottom: 15px; font-size: 0.9rem; color: var(--text-secondary); display: flex; justify-content: space-between; align-items: center;" id="savings-total">
                            <!-- JS 生成 -->
                        </div>
                        
                        <button class="btn-primary" onclick="randomSave()" style="background: var(--savings-saved-bg); margin-bottom: 20px;">🎲 隨機存一筆 (交給命運)</button>

                        <div class="savings-grid" id="savings-grid" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px;">
                            <!-- JS 生成 -->
                        </div>
                    </div>

                    <!-- 願望清單分頁 -->
                    <div id="tab-wishlist" class="sub-section">
                        <div class="input-group">
                            <input type="text" id="new-wish-input" placeholder="你的願望..." style="flex: 2;">
                            <input type="number" id="new-wish-cost" placeholder="$ 金額" style="flex: 1;">
                            <button class="add-btn" onclick="addWish()">＋</button>
                        </div>
                        
                        <div id="wish-list" class="space-y-3"></div>

                        <!-- AI 鼓勵區 -->
                        <div class="ai-encourage-box mt-6">
                            <div class="flex items-center justify-center gap-2 mb-2 opacity-50">
                                <span class="text-lg">🤖</span>
                                <span class="text-xs tracking-widest font-bold">AI 財務顧問</span>
                            </div>
                            <p id="financial-encouragement" class="text-[#5E5A54] leading-relaxed">--</p>
                            <button onclick="refreshFinancialEncouragement()" style="background:none; border:none; color: var(--accent-blue); font-size: 0.8rem; margin-top: 10px; cursor: pointer;">↻ 換一句鼓勵</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 全域背景語錄區 -->
            <div class="global-footer-quote">
                <p>「你們是世上的鹽，鹽若失了味……」</p>
                <p>那就暫時做一條快樂的鹹魚。</p>
            </div>

            <footer>
                <!-- 聯絡我們 (整合所有社群連結) -->
                <div class="contact-section">
                    <span class="contact-label" style="margin-bottom: 12px; font-size: 0.85rem;">聯絡我們</span>
                    <div class="social-links" style="gap: 25px;">
                        <a href="https://www.facebook.com/profile.php?id=100068500932557" class="icon-link" aria-label="Facebook" target="_blank" rel="noopener noreferrer">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path></svg>
                        </a>
                        <a href="https://www.instagram.com/forever.believe.in.jesus/" class="icon-link" aria-label="Instagram" target="_blank" rel="noopener noreferrer">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line></svg>
                        </a>
                        <a href="https://www.threads.net/@forever.believe.in.jesus" class="icon-link" aria-label="Threads" target="_blank" rel="noopener noreferrer">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"></circle><path d="M16 8v5a3 3 0 0 0 6 0v-1a10 10 0 1 0-3.92 7.94"></path></svg>
                        </a>
                        <a href="https://line.me/R/ti/p/@469cjlho" class="icon-link" aria-label="Official Line" target="_blank" rel="noopener noreferrer">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                        </a>
                        <a href="mailto:newthingsinthelittlelight@gmail.com" class="icon-link" aria-label="Email">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                        </a>
                    </div>
                    
                    <!-- 使用手冊連結 -->
                    <a href="#" onclick="showHelpModal(); return false;" style="margin-top: 12px; font-size: 0.8rem; color: var(--accent-blue); text-decoration: none; border-bottom: 1px dotted var(--accent-blue);">📖 使用說明書</a>
                </div>

                <div style="margin-top: 25px;">
                    <p class="ai-note">💡 本站所有文案皆由 AI 與鹹魚協同醃漬而成，僅供娛樂。</p>
                    <p style="font-size: 0.65rem; color: #CCC;">Ver 7.0 (Weighted PUA Quiz)</p>
                    <p>&copy; 2026機智的鹹魚生活 | 耶穌加油站 x 微光新事</p>
                </div>
            </footer>
        </main>
    </div>

    <!-- 底部導覽列 -->
    <nav class="bottom-nav">
        <button class="nav-item active" onclick="showSection('home', this)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
            首頁
        </button>
        <button class="nav-item" id="nav-devotion" onclick="showSection('devotion', this)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
            醃漬鹹魚
        </button>
        <button class="nav-item" onclick="showSection('flip', this)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
            鹹魚翻身
        </button>
        <button class="nav-item" onclick="showSection('pua', this)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
            聰明鹹魚
        </button>
        <button class="nav-item" onclick="showSection('shield', this)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
            游刃有魚
        </button>
        <button class="nav-item" onclick="showSection('flow', this)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
            綽綽有魚
        </button>
    </nav>

    <!-- 確認視窗 -->
    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="font-size: 1.2rem; margin-bottom: 15px;">請確認</h3>
            <p id="confirm-msg" style="color: var(--text-primary); margin-bottom: 20px;">確定要執行嗎？</p>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="closeConfirmModal()" style="flex: 1; padding: 12px; border-radius: 12px; border: none; background: #f0f0f0;">取消</button>
                <button id="confirm-btn-action" style="flex: 1; padding: 12px; border-radius: 12px; border: none; background: var(--accent-warning); color: white;">確定</button>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="help-modal" class="modal-overlay">
        <div class="modal-content relative">
            <button onclick="closeHelpModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            
            <div class="prose prose-sm max-w-none text-[#5E5A54]">
                <h2>📖 機智的鹹魚生活 | 使用說明書</h2>

                <p>親愛的鹹魚夥伴，平安：</p>
                <p>歡迎來到這個專為「不想過度努力而內耗」的基督徒打造的屬靈避難所。在這裡，我們拒絕屬靈焦慮，主張在恩典中快樂躺平。為了讓您能安心地在這裡醃漬自己，請花一點時間閱讀這份說明書。</p>

                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 my-4 rounded-r">
                    <h4 class="text-yellow-800 font-bold m-0">💾 重要：關於資料保存與備份（必讀！）</h4>
                    <p class="text-sm text-yellow-700 mt-2">這是本站最重要的部分。為了保護您的隱私，本站採用 <strong>「本地儲存 (Local Storage)」</strong> 技術。</p>
                </div>

                <h3>1. 資料存在哪裡？</h3>
                <p>您寫下的每一個字（靈修筆記、存錢紀錄、願望清單），都直接儲存在您 <strong>目前使用的這台裝置（手機或電腦）的瀏覽器內部</strong>，我們不會（也無法）將資料上傳到任何雲端伺服器。</p>
                <ul class="list-disc pl-5 space-y-1">
                    <li>✅ <strong>優點</strong>：隱私性極高，只有天知、地知、你知，且離線也能使用。</li>
                    <li>⚠️ <strong>特性</strong>：資料是「跟著瀏覽器」走的。</li>
                </ul>

                <h3>2. 什麼情況下資料會不見？</h3>
                <p>由於資料存放在瀏覽器內，以下情況會導致您的紀錄消失：</p>
                <ul class="list-disc pl-5 space-y-1">
                    <li><strong>清除瀏覽器紀錄</strong>：若手動清除了「Cookie」或「快取資料」，資料會被刪除。</li>
                    <li><strong>使用無痕模式 (Incognito)</strong>：無痕視窗關閉後，所有資料會自動銷毀。</li>
                    <li><strong>更換裝置或瀏覽器</strong>：手機 Chrome 的資料，無法在電腦 Chrome 或手機 Safari 上看到。</li>
                    <li><strong>手機重置</strong>：恢復原廠設定後，資料會消失。</li>
                </ul>

                <h3>3. 如何永久保存？（強烈建議）</h3>
                <p>我們提供了兩種層級的保存方式，建議您養成好習慣：</p>

                <h4>A. 全站資料備份（換手機必用）</h4>
                <p>位於 <strong>「首頁」</strong> 最下方的 <strong>「🔒 資料保險箱」</strong>。</p>
                <ul class="list-disc pl-5 space-y-1">
                    <li><strong>📤 匯出備份</strong>：點擊後會下載一個 <code>.json</code> 檔案。這包含了您在網站上的 <strong>所有紀錄</strong>。請將此檔案妥善保存在雲端硬碟或 Email 中。</li>
                    <li><strong>📥 匯入備份</strong>：當您換新手機或不小心清空資料時，載入這個檔案即可還原。</li>
                </ul>

                <h4>B. 單日靈修分享（每日用）</h4>
                <p>位於 <strong>「醃漬鹹魚（靈修）」</strong> 頁面的筆記區。</p>
                <ul class="list-disc pl-5 space-y-1">
                    <li><strong>下載</strong>：將當天的經文、領受與禱告整理成文字檔下載。</li>
                    <li><strong>分享</strong>：手機版可直接喚起系統選單（存入 Keep、備忘錄）；電腦版則會自動複製全文，方便您貼到習慣的筆記軟體。</li>
                </ul>

                <hr class="my-6 border-dashed border-gray-300">

                <h3>🐟 功能介紹</h3>

                <h4>1. 首頁：鹹度監測與計畫</h4>
                <ul class="list-disc pl-5 space-y-1">
                    <li><strong>鹹魚鹽度監測</strong>：每天測測看你有多「鹹」，純屬娛樂。</li>
                    <li><strong>屬靈防腐劑</strong>：當你覺得快撐不下去時，領取一句急救金句。</li>
                    <li><strong>讀經進度條</strong>：直觀顯示您的一年讀經進度。</li>
                </ul>

                <h4>2. 醃漬鹹魚（靈修內室）</h4>
                <p>這是您的核心靈修區，採用 <strong>「一年讀經計畫」</strong> 混合制：</p>
                <ul class="list-disc pl-5 space-y-1">
                    <li><strong>每日進度</strong>：系統自動安排 <strong>舊約 + 新約 + 詩篇 + 箴言</strong>。</li>
                    <li><strong>自動經文載入</strong>：點擊進度卡片，系統會自動幫您抓取經文，直接閱讀。</li>
                    <li><strong>醃漬筆記</strong>：記錄您的靈修感動，現在整合在經文閱讀區旁邊，使用更方便。</li>
                </ul>

                <h4>3. 鹹魚翻身（抽卡）</h4>
                <ul class="list-disc pl-5 space-y-1">
                    <li>每天翻一張卡，獲得主廚特製的「鹹魚雞湯」或「恩典亮光」。</li>
                    <li><strong>📸 拍立得打包</strong>：將卡片變成一張精美的圖片下載。</li>
                </ul>
                
                <p class="mt-6 text-sm text-gray-500 italic text-center">把這裡當作是一個安靜的書桌，記得在結束靈修後，點擊一下「分享」或「匯出」，將這份感動好好收藏起來喔！</p>
                <p class="text-sm text-gray-500 italic text-center">願您的鹹魚生活，有滋有味，恩典夠用。</p>
            </div>
            
            <div class="mt-6 text-center">
                <button onclick="closeHelpModal()" class="bg-[#A68C76] text-white px-6 py-2 rounded-full hover:bg-[#8e7662] transition-colors">我知道了</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"><span>已成功複製到靈魂深處</span></div>

    <script>
        // --- 核心資料 ---
        const bibleBooks = [
            { name: "創世記", abbr: "創", code: "GEN", chapters: 50, type: 1 }, { name: "出埃及記", abbr: "出", code: "EXO", chapters: 40, type: 1 }, 
            { name: "利未記", abbr: "利", code: "LEV", chapters: 27, type: 1 }, { name: "民數記", abbr: "民", code: "NUM", chapters: 36, type: 1 },
            { name: "申命記", abbr: "申", code: "DEU", chapters: 34, type: 1 }, { name: "約書亞記", abbr: "書", code: "JOS", chapters: 24, type: 1 },
            { name: "士師記", abbr: "士", code: "JDG", chapters: 21, type: 1 }, { name: "路得記", abbr: "得", code: "RUT", chapters: 4, type: 1 },
            { name: "撒母耳記上", abbr: "撒上", code: "1SA", chapters: 31, type: 1 }, { name: "撒母耳記下", abbr: "撒下", code: "2SA", chapters: 24, type: 1 },
            { name: "列王紀上", abbr: "王上", code: "1KI", chapters: 22, type: 1 }, { name: "列王紀下", abbr: "王下", code: "2KI", chapters: 25, type: 1 },
            { name: "歷代志上", abbr: "代上", code: "1CH", chapters: 29, type: 1 }, { name: "歷代志下", abbr: "代下", code: "2CH", chapters: 36, type: 1 },
            { name: "以斯拉記", abbr: "拉", code: "EZR", chapters: 10, type: 1 }, { name: "尼希米記", abbr: "尼", code: "NEH", chapters: 13, type: 1 },
            { name: "以斯帖記", abbr: "斯", code: "EST", chapters: 10, type: 1 }, { name: "約伯記", abbr: "伯", code: "JOB", chapters: 42, type: 1 },
            { name: "詩篇", abbr: "詩", code: "PSA", chapters: 150, type: 3 }, { name: "箴言", abbr: "箴", code: "PRO", chapters: 31, type: 4 },
            { name: "傳道書", abbr: "傳", code: "ECC", chapters: 12, type: 1 }, { name: "雅歌", abbr: "歌", code: "SNG", chapters: 8, type: 1 },
            { name: "以賽亞書", abbr: "賽", code: "ISA", chapters: 66, type: 1 }, { name: "耶利米書", abbr: "耶", code: "JER", chapters: 52, type: 1 },
            { name: "耶利米哀歌", abbr: "哀", code: "LAM", chapters: 5, type: 1 }, { name: "以西結書", abbr: "結", code: "EZE", chapters: 48, type: 1 },
            { name: "但以理書", abbr: "但", code: "DAN", chapters: 12, type: 1 }, { name: "何西阿書", abbr: "何", code: "HOS", chapters: 14, type: 1 },
            { name: "約珥書", abbr: "珥", code: "JOL", chapters: 3, type: 1 }, { name: "阿摩司書", abbr: "摩", code: "AMO", chapters: 9, type: 1 },
            { name: "俄巴底亞書", abbr: "俄", code: "OBA", chapters: 1, type: 1 }, { name: "約拿書", abbr: "拿", code: "JON", chapters: 4, type: 1 },
            { name: "彌迦書", abbr: "彌", code: "MIC", chapters: 7, type: 1 }, { name: "那鴻書", abbr: "鴻", code: "NAM", chapters: 3, type: 1 },
            { name: "哈巴谷書", abbr: "哈", code: "HAB", chapters: 3, type: 1 }, { name: "西番雅書", abbr: "番", code: "ZEP", chapters: 3, type: 1 },
            { name: "哈該書", abbr: "該", code: "HAG", chapters: 2, type: 1 }, { name: "撒迦利亞書", abbr: "亞", code: "ZEC", chapters: 14, type: 1 },
            { name: "瑪拉基書", abbr: "瑪", code: "MAL", chapters: 4, type: 1 }, 
            { name: "馬太福音", abbr: "太", code: "MAT", chapters: 28, type: 2 }, { name: "馬可福音", abbr: "可", code: "MRK", chapters: 16, type: 2 }, 
            { name: "路加福音", abbr: "路", code: "LUK", chapters: 24, type: 2 }, { name: "約翰福音", abbr: "約", code: "JHN", chapters: 21, type: 2 }, 
            { name: "使徒行傳", abbr: "徒", code: "ACT", chapters: 28, type: 2 }, { name: "羅馬書", abbr: "羅", code: "ROM", chapters: 16, type: 2 }, 
            { name: "哥林多前書", abbr: "林前", code: "1CO", chapters: 16, type: 2 }, { name: "哥林多後書", abbr: "林後", code: "2CO", chapters: 13, type: 2 }, 
            { name: "加拉太書", abbr: "加", code: "GAL", chapters: 6, type: 2 }, { name: "以弗所書", abbr: "弗", code: "EPH", chapters: 6, type: 2 }, 
            { name: "腓立比書", abbr: "腓", code: "PHP", chapters: 4, type: 2 }, { name: "歌羅西書", abbr: "西", code: "COL", chapters: 4, type: 2 }, 
            { name: "帖撒羅尼迦前書", abbr: "帖前", code: "1TH", chapters: 5, type: 2 }, { name: "帖撒羅尼迦後書", abbr: "帖後", code: "2TH", chapters: 3, type: 2 }, 
            { name: "提摩太前書", abbr: "提前", code: "1TI", chapters: 6, type: 2 }, { name: "提摩太後書", abbr: "提後", code: "2TI", chapters: 4, type: 2 }, 
            { name: "提多書", abbr: "多", code: "TIT", chapters: 3, type: 2 }, { name: "腓利門書", abbr: "門", code: "PHM", chapters: 1, type: 2 }, 
            { name: "希伯來書", abbr: "來", code: "HEB", chapters: 13, type: 2 }, { name: "雅各書", abbr: "雅", code: "JAS", chapters: 5, type: 2 }, 
            { name: "彼得前書", abbr: "彼前", code: "1PE", chapters: 5, type: 2 }, { name: "彼得後書", abbr: "彼後", code: "2PE", chapters: 3, type: 2 }, 
            { name: "約翰一書", abbr: "約一", code: "1JN", chapters: 5, type: 2 }, { name: "約翰二書", abbr: "約二", code: "2JN", chapters: 1, type: 2 }, 
            { name: "約翰三書", abbr: "約三", code: "3JN", chapters: 1, type: 2 }, { name: "猶大書", abbr: "猶", code: "JUD", chapters: 1, type: 2 }, 
            { name: "啟示錄", abbr: "啟", code: "REV", chapters: 22, type: 2 }
        ];

        const encouragements = ["不要怕，只要信。", "你的禱告，神都聽見了。", "患難生忍耐，忍耐生老練。", "愛是永不止息。", "凡事互相效力，叫愛神的人得益處。", "靠著那加給我力量的，凡事都能做。", "喜樂的心乃是良藥。", "就在今天，恩典夠你用。", "堅持下去，神的時間最完美。"];
        const financialEncouragements = ["積少成多，上帝的供應也是如此。", "你的每一個銅板，都是對未來的信心。", "不要為明天憂慮，因為明天自有明天的憂慮。", "耶和華以勒，祂必有預備。", "理財也是一種管家職分，你做得很好！", "哪怕只是存下一塊錢，也是向夢想靠近的一步。", "富足不在於擁有多少，而在於知足。", "種什麼收什麼，現在的儲蓄是未來收成。", "你管理金錢的方式，反映了你對上帝的信靠。", "錢是僕人，不是主人。讓它為愛神愛人效力。"];
        const keywords = ["突破", "安息", "重建", "豐盛", "勇氣", "喜樂", "專注", "謙卑", "信心", "愛", "智慧", "耐心", "更新", "感恩", "忠心"];
        
        let onlineSaltStatusMap = [], onlinePreservativePool = [], onlineFlipQuotes = [], dailyQuotesPool = [], onlineShieldData = [];
        const saltStatusMap = [{ min: 0, max: 10, title: "含鹽量 5%：新鮮淡水魚", desc: "警告：你太新鮮了，完全沒有醃漬痕跡。建議立刻去聽首詩歌壓壓驚。" }, { min: 11, max: 30, title: "含鹽量 20%：微鹹小鮮肉", desc: "微鹹。大概就是薯條忘記加鹽的程度，屬靈味道淡如水。" }, { min: 31, max: 60, title: "含鹽量 50%：入味標準款", desc: "醃漬得恰到好處！有屬靈的氣質，也有屬世的快樂，生活在恩典的平衡點。" }, { min: 61, max: 90, title: "含鹽量 80%：資深老鹹魚", desc: "太聖潔了！你現在散發出的鹽味足以讓周圍的魔鬼感到乾渴難耐。" }, { min: 91, max: 100, title: "含鹽量 99%：屬靈核彈", desc: "你已經不是鹹魚了，你是鹽本身。請喝杯珍奶平衡一下太過神聖的體質。" }];
        let preservativePool = [{ tMin: 0, tMax: 30, content: "你是神眼中的瞳人，就算你現在只是條廢魚，也是最貴的那條。" }, { tMin: 0, tMax: 50, content: "深呼吸，天塌下來有耶穌頂著，你負責躺平領受恩典就好。" }, { tMin: 0, tMax: 100, content: "不論你今天幾度，神愛你的程度始終是 100%，這才是最猛的防腐劑。" }];
        const quotes = [{ text: "凡勞苦擔重擔的人可以到我這裡來，我就使你們得安息。", source: "馬太福音 11:28", comment: "(鹹魚主廚的祕方：快去睡，別再滑手機了)" }, { text: "你們要休息，要知道我是神。", source: "詩篇 46:10", comment: "(鹹魚主廚的祕方：聽話，現在就去躺平，剩下的交給老闆)" }, { text: "喜樂的心乃是良藥，憂傷的靈使骨枯乾。", source: "箴言 17:22", comment: "(鹹魚主廚的祕方：心情好最重要，即使你只是一條鹹魚)" }];
        const puaTestItems = [
            { text: "你不順服就是不蒙福", weight: 1 },
            { text: "這是在訓練你的信心/破碎老我", weight: 2 },
            { text: "不可觸摸/質疑受膏者", weight: 3 },
            { text: "這是魔鬼的攻擊", weight: 1 },
            { text: "離開這間教會你就沒遮蓋了", weight: 3 },
            { text: "聖靈感動我叫你做這件事", weight: 2 },
            { text: "你要把你的以撒(最愛的)獻上", weight: 3 }
        ];
        
        let puaData = {
            love: { sentence: "你不服事/不聚會 就是不愛主！", trans: "我需要免費勞動力來填補職缺，請不要讓我難做人。", defenses: ["神的愛是無條件的。我的休息也是一種敬拜。", "馬利亞選擇了上好的福分(躺平)，是不會被奪去的。"], level: "⭐⭐⭐" },
            submit: { sentence: "你要順服權柄，不要問為什麼。", trans: "閉嘴，聽我的就好。我不想解釋，也不想被挑戰。", defenses: ["順服神大於順服人。盲從絕對不是順服。", "我也在順服神給我的感動：現在先不要。"], level: "⭐⭐⭐⭐" },
            touch: { sentence: "不可觸摸耶和華的受膏者！", trans: "我是特權階級，我有神聖豁免權，你不能質疑我的錯誤。", defenses: ["真理越辯越明。如果怕被摸，是不是裡面有鬼？", "我們都是君尊的祭司，大家都是受膏者，請平等對話。"], level: "⭐⭐⭐⭐⭐" },
            vision: { sentence: "你要有國度觀！", trans: "別計較那麼多，反正資源都要給我用。", defenses: ["我的國度觀包含照顧好神給我的身體與家庭。", "上帝的國度也包含公義與合理的分工。"], level: "⭐⭐" },
            family: { sentence: "我們是愛的大家庭。", trans: "所以你不能有界線，要把自己燃燒殆盡。", defenses: ["家是有愛的地方，不是勒索的地方。", "健康的家庭會有健康的界線。"], level: "⭐⭐⭐" },
            offering: { sentence: "信心奉獻，上帝必加倍奉還。", trans: "我們的預算缺口很大，請你掏錢。", defenses: ["奉獻是甘心樂意，不是投資理財。", "我的信心建立在神的話語，不是金錢交換。"], level: "⭐⭐⭐⭐" }
        };

        const shields = { marriage: ["我在等候神所預備的亞當/夏娃，這事急不得。", "保羅說守素安常也是好的。"], salary: ["積財寶在天上，地地上地的數字如浮雲。", "耶和華以勒必有預備。"], serve: ["這陣子神帶領我進入曠野學習安靜的功課。", "我在調整屬靈的步伐。"] };

        let biblePlan = [];
        let prayers = [], goals = [], userSignals = [], savingsPlan = [], wishlist = [];
        let yearlyKeyword = '';
        let currentPuaSelection = null, currentShieldSelection = null, currentSaltPercent = 0;
        let currentFullText = ""; // 用於複製功能
        let selectedVerses = new Set(); // Store indices or IDs of selected verses
        let onlinePuaChecklist = []; // 線上題庫

        // --- Helper Functions ---
        function stripHtml(html) {
           return html.replace(/<[^>]*>?/gm, '');
        }

        async function fetchAndParseCSV(gid) {
            const sheetId = '2PACX-1vSdgi7Fr-SIVYoVShmmXsGD_ZSYC-nPNaWyp42Haii8fdGtKkLS6jDJ1bPXWyEnknDStJgEkI3WrrYy';
            const url = `https://docs.google.com/spreadsheets/d/e/${sheetId}/pub?gid=${gid}&single=true&output=csv`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network error');
                const csvText = await response.text();
                if (csvText.startsWith('<!doctype html')) throw new Error('HTML received');
                const rows = csvText.split(/\r?\n/);
                if (rows.length === 0) return [];
                const parseCSVLine = (line) => {
                    const cols = []; let inQuote = false; let currentVal = '';
                    for(let j=0; j<line.length; j++) {
                        const char = line[j];
                        if(char === '"') inQuote = !inQuote;
                        else if(char === ',' && !inQuote) { cols.push(currentVal); currentVal = ''; } else currentVal += char;
                    }
                    cols.push(currentVal);
                    return cols.map(c => c.trim().replace(/^"|"$/g, '').replace(/""/g, '"'));
                };
                const headers = parseCSVLine(rows[0]).map(h => h.trim().toLowerCase().replace(/^\ufeff/, ''));
                return { headers, rows: rows.slice(1), parser: parseCSVLine };
            } catch (error) { return null; }
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.querySelector('span').innerText = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function saveToStorage(key, value) {
            try { localStorage.setItem(key, value); } 
            catch (e) { showToast('⚠️ 儲存失敗：空間不足或設定問題'); }
        }

        function generateAppIcons() {
            const canvas = document.createElement('canvas'); canvas.width = 512; canvas.height = 512;
            const ctx = canvas.getContext('2d'); ctx.fillStyle = '#7CA1B3'; ctx.fillRect(0, 0, 512, 512);
            const svgString = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><path d="M100 80 C 150 80, 180 110, 180 130 C 180 150, 150 170, 100 170 C 50 170, 20 150, 20 130 C 20 110, 50 80, 100 80 Z" fill="#FFFFFF"/><path d="M180 130 L 200 110 L 200 150 Z" fill="#FFFFFF"/><ellipse cx="60" cy="135" rx="10" ry="6" fill='%23FFAB91' opacity='1'/><ellipse cx="140" cy="135" rx="10" ry="6" fill='%23FFAB91' opacity='1'/><g stroke='%237CA1B3' stroke-width='5' stroke-linecap='round'><line x1='75' y1='112' x2='75' y2='128'/><line x1='69' y1='118' x2='81' y2='118'/><line x1='125' y1='112' x2='125' y2='128'/><line x1='119' y1='118' x2='131' y2='118'/></g><line x1='95' y1='145' x2='105' y2='145' stroke='%237CA1B3' stroke-width='5' stroke-linecap='round'/><ellipse cx='100' cy='50' rx='60' ry='10' fill='none' stroke='%23D4B483' stroke-width='5'/></svg>`;
            const img = new Image(); img.src = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svgString);
            img.onload = function() { ctx.drawImage(img, 56, 56, 400, 400); const pngUrl = canvas.toDataURL('image/png'); const favLink = document.getElementById('favicon-link'); const appleLink = document.getElementById('apple-icon-link'); if(favLink) favLink.href = pngUrl; if(appleLink) appleLink.href = pngUrl; };
        }

        // --- 讀經計畫生成 ---
        function generateBiblePlan() {
            let plan = [];
            const otBooks = bibleBooks.filter(b => b.type === 1);
            const ntBooks = bibleBooks.filter(b => b.type === 2);
            const psBooks = bibleBooks.filter(b => b.type === 3); 
            
            let pointers = {
                ot: { bookIdx: 0, chap: 1, rate: 2.05, acc: 0 },
                nt: { bookIdx: 0, chap: 1, rate: 1, acc: 0, loop: true },
                ps: { bookIdx: 0, chap: 1, rate: 1, acc: 0, loop: true }
            };

            const getReadingForTrack = (trackName, books) => {
                let p = pointers[trackName];
                if (!p.loop && p.bookIdx >= books.length) return null; 
                p.acc += p.rate;
                let chaptersToRead = Math.floor(p.acc);
                if (p.loop && chaptersToRead < 1) chaptersToRead = 1;
                if (plan.length === 0 && chaptersToRead === 0 && trackName === 'ot') chaptersToRead = 1;
                if (chaptersToRead === 0) return null;
                p.acc -= chaptersToRead;
                
                let currentBook = null; 
                let readings = [];
                let startChap = p.chap;
                
                if (p.loop && p.bookIdx >= books.length) { p.bookIdx = 0; p.chap = 1; startChap = 1; }
                
                if (p.bookIdx < books.length) {
                    currentBook = books[p.bookIdx];
                }

                for (let i = 0; i < chaptersToRead; i++) {
                    if (p.bookIdx >= books.length) {
                        if (p.loop) { p.bookIdx = 0; p.chap = 1; startChap = 1; currentBook = books[0]; }
                        else break;
                    }
                    currentBook = books[p.bookIdx];
                    p.chap++;
                    if (p.chap > currentBook.chapters) {
                        readings.push({ book: currentBook, start: startChap, end: currentBook.chapters });
                        p.bookIdx++;
                        p.chap = 1;
                        if (p.bookIdx < books.length) { currentBook = books[p.bookIdx]; startChap = 1; }
                        else if (p.loop) { currentBook = books[0]; startChap = 1; }
                    }
                }
                if (p.chap > startChap && currentBook) readings.push({ book: currentBook, start: startChap, end: p.chap - 1 });
                
                return readings.map(r => ({
                    text: `${r.book.name} ${r.start}${r.end > r.start ? '-' + r.end : ''}`,
                    abbr: `${r.book.abbr}${r.start}${r.end > r.start ? '-' + r.end : ''}`,
                    bookCode: r.book.code,
                    chapter: r.start
                }));
            };

            const currentYear = new Date().getFullYear();
            for (let i = 0; i < 365; i++) {
                let date = new Date(currentYear, 0, 1);
                date.setDate(date.getDate() + i);
                let dateStr = `${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;

                let otRead = getReadingForTrack('ot', otBooks);
                let ntRead = getReadingForTrack('nt', ntBooks);
                let psRead = getReadingForTrack('ps', psBooks);
                let proChap = (i % 31) + 1;
                let proRead = [{ text: `箴言 ${proChap}`, abbr: `箴${proChap}`, bookCode: "PRO", chapter: proChap }];

                let fullReadings = [];
                if (otRead) otRead.forEach(r => fullReadings.push({...r, type: '舊'}));
                if (ntRead) ntRead.forEach(r => fullReadings.push({...r, type: '新'}));
                if (psRead) psRead.forEach(r => fullReadings.push({...r, type: '詩'}));
                if (proRead) proRead.forEach(r => fullReadings.push({...r, type: '箴'}));

                // Add note item
                fullReadings.push({ type: '筆記', abbr: '靈修筆記', isNote: true });

                let mainText = "";
                if (otRead) mainText += otRead[0].abbr + " "; 
                if (ntRead) mainText += ntRead[0].abbr;
                if (!otRead && !ntRead && psRead) mainText = psRead[0].abbr;

                let extraMark = "";
                if (psRead || proRead) extraMark = "+詩/箴";

                plan.push({ 
                    day: i + 1, 
                    dateStr: dateStr, 
                    details: fullReadings,
                    reading: mainText.trim() || "安息日 (補進度)",
                    extraMark: extraMark,
                    completed: false 
                });
            }
            return plan;
        }

        // --- Data Loaders ---
        async function loadOnlineQuotes() { 
            const d = await fetchAndParseCSV('1349046456'); 
            if(!d) return; 
            let idx = d.headers.findIndex(h=>['text','quote'].some(k=>h.includes(k)));
            if (idx === -1) idx = 0;
            dailyQuotesPool=[]; 
            d.rows.forEach(l=>{
                const c=d.parser(l);
                if(c[idx]) dailyQuotesPool.push(c[idx]);
            }); 
            refreshDailyWord(); 
        }

        async function loadSaltStatusMap() { 
            const d = await fetchAndParseCSV('138033526'); 
            if(d){ 
                onlineSaltStatusMap=[]; 
                let idxMin = d.headers.indexOf('min_percent');
                if (idxMin === -1) idxMin = 0;
                let idxMax = d.headers.indexOf('max_percent');
                if (idxMax === -1) idxMax = 1;
                let idxTitle = d.headers.indexOf('status_title');
                if (idxTitle === -1) idxTitle = 2;
                let idxDesc = d.headers.indexOf('status_desc');
                if (idxDesc === -1) idxDesc = 3;

                d.rows.forEach(l=>{
                    const c=d.parser(l);
                    onlineSaltStatusMap.push({
                        min:parseInt(c[idxMin]),
                        max:parseInt(c[idxMax]),
                        title:c[idxTitle],
                        desc:c[idxDesc]
                    });
                }); 
            } 
        }

        async function loadPreservativePool() { 
            const d=await fetchAndParseCSV('159897993'); 
            if(d){ 
                let idx={
                    min: d.headers.findIndex(h=>h.includes('min')),
                    max: d.headers.findIndex(h=>h.includes('max')),
                    c: d.headers.findIndex(h=>h.includes('content'))
                }; 
                if(idx.min === -1) idx.min = 0;
                if(idx.max === -1) idx.max = 1;
                if(idx.c === -1) idx.c = 2;

                onlinePreservativePool=[]; 
                d.rows.forEach(l=>{
                    const c=d.parser(l);
                    onlinePreservativePool.push({
                        tMin:parseInt(c[idx.min]),
                        tMax:parseInt(c[idx.max]),
                        content:c[idx.c]
                    });
                }); 
            } 
        }

        async function loadFlipQuotes() { 
            const d=await fetchAndParseCSV('1402400724'); 
            if(d){ 
                let idx={
                    c: d.headers.findIndex(h=>h.includes('content')),
                    s: d.headers.findIndex(h=>h.includes('source')),
                    cm: d.headers.findIndex(h=>h.includes('comment'))
                }; 
                if(idx.c === -1) idx.c = 0;
                if(idx.s === -1) idx.s = 1;
                if(idx.cm === -1) idx.cm = 2;

                onlineFlipQuotes=[]; 
                d.rows.forEach(l=>{
                    const c=d.parser(l);
                    if(c[idx.c]) onlineFlipQuotes.push({
                        text:c[idx.c],
                        source:c[idx.s]||"",
                        comment:c[idx.cm]||""
                    });
                }); 
            } 
        }
        
        async function loadShieldData() { 
            const d = await fetchAndParseCSV('1087555591'); 
            if (!d) { renderShieldTags(); return; } 
            
            // 修正：針對使用者提供的 'label' 與 'options' 進行精確匹配
            // 若找不到精確名稱，則嘗試模糊匹配，最後回退到索引 0 和 1
            let idxL = d.headers.indexOf('label');
            if (idxL === -1) idxL = d.headers.findIndex(h => h.includes('label') || h.includes('question'));
            if (idxL === -1) idxL = 0; 

            let idxO = d.headers.indexOf('options');
            if (idxO === -1) idxO = d.headers.findIndex(h => h.includes('option') || h.includes('answer'));
            if (idxO === -1) idxO = 1; 
            
            onlineShieldData = []; 
            d.rows.forEach(l => {
                const c = d.parser(l);
                // 確保兩個欄位都有值才加入
                if (c[idxL] && c[idxO]) {
                    onlineShieldData.push({
                        label: c[idxL].trim(),
                        // 支援換行符號(\n)或垂直線(|)作為分隔符，並過濾空白
                        options: c[idxO].split(/[\n|]/).map(opt => opt.trim()).filter(opt => opt.length > 0)
                    });
                }
            }); 
            
            // 如果成功抓取到資料，重新渲染標籤
            if (onlineShieldData.length > 0) {
                renderShieldTags(); 
            }
        }
        
        async function loadPuaChecklist() {
            const d = await fetchAndParseCSV('494946164');
            if (d) {
                let idx = {
                    t: d.headers.findIndex(h => h.includes('question') || h.includes('題目')),
                    w: d.headers.findIndex(h => h.includes('weight') || h.includes('權重'))
                };
                if (idx.t === -1) idx.t = 0;
                if (idx.w === -1) idx.w = 1;

                onlinePuaChecklist = [];
                d.rows.forEach(l => {
                    const c = d.parser(l);
                    if (c[idx.t]) {
                        onlinePuaChecklist.push({ text: c[idx.t], weight: parseInt(c[idx.w]) || 1 });
                    }
                });
            }
        }

        async function loadPuaData() {
            const d = await fetchAndParseCSV('0'); // gid 0 for PUA Dictionary
            if (!d) return;
            
            // Dynamic header mapping with fallback
            let idx = {
                s: d.headers.findIndex(h => h.includes('sentence') || h.includes('金句')),
                t: d.headers.findIndex(h => h.includes('trans') || h.includes('翻譯')),
                d: d.headers.findIndex(h => h.includes('defense') || h.includes('回擊') || h.includes('os')),
                l: d.headers.findIndex(h => h.includes('level') || h.includes('毒性'))
            };
            if (idx.s === -1) idx.s = 0;
            if (idx.t === -1) idx.t = 1;
            if (idx.d === -1) idx.d = 2;
            if (idx.l === -1) idx.l = 3;

            let newPuaData = {};
            d.rows.forEach((line, index) => {
                const c = d.parser(line);
                if (c[idx.s]) {
                    newPuaData[`online_${index}`] = {
                        sentence: c[idx.s],
                        trans: c[idx.t] || "翻譯載入中...",
                        defenses: c[idx.d] ? c[idx.d].split(/[|\n]/).filter(x => x.trim()) : ["(微笑不語)", "主都知道"],
                        level: c[idx.l] || "⭐⭐⭐"
                    };
                }
            });

            if (Object.keys(newPuaData).length > 0) {
                puaData = newPuaData;
                renderPuaTags(); 
            }
        }

        // --- Core UI & Logic ---
        function refreshDailyWord() { const el=document.getElementById('daily-word'); if(el) el.innerHTML=`<span>💬 小語：${dailyQuotesPool.length?dailyQuotesPool[Math.floor(Math.random()*dailyQuotesPool.length)]:preservativePool[0].content}</span> <span class="refresh-icon">↻</span>`; }
        function setRandomStatus() { 
            const t=document.getElementById('daily-status-title'), d=document.getElementById('daily-status-desc'); if(!t)return; 
            const completedCount = biblePlan.filter(d => d.completed).length;
            const totalDays = biblePlan.length || 365;
            currentSaltPercent = Math.floor((completedCount / totalDays) * 100);

            const s=(onlineSaltStatusMap.length?onlineSaltStatusMap:saltStatusMap).find(x=>currentSaltPercent>=x.min&&currentSaltPercent<=x.max)||saltStatusMap[0]; 
            t.style.opacity=0;d.style.opacity=0; 
            
            setTimeout(()=>{
                if (s.title.includes('%')) {
                     t.innerText = s.title.replace(/\d+%/, currentSaltPercent + "%");
                } else {
                     t.innerText = `含鹽量 ${currentSaltPercent}%：${s.title}`;
                }
                d.innerText=s.desc;
                t.style.opacity=1;d.style.opacity=1;
            },200); 
            
            updateHomeStatus();
        }
        function getPreservative() { const d=document.getElementById('preservative-display'); d.style.opacity=0; const pool=onlinePreservativePool.length?onlinePreservativePool:preservativePool; const msg=pool[Math.floor(Math.random()*pool.length)].content; setTimeout(()=>{d.innerText=`「${msg}」`;d.style.opacity=1;},200); }
        function flipCard() { document.querySelector('.flip-container').classList.toggle('flipped'); if(document.querySelector('.flip-container').classList.contains('flipped')){const q=(onlineFlipQuotes.length?onlineFlipQuotes:quotes)[Math.floor(Math.random()*onlineFlipQuotes.length||quotes.length)]; document.getElementById('quote-content').innerText=q.text; document.getElementById('quote-source').innerText=q.source; document.getElementById('quote-comment').innerHTML=`<strong>主廚祕方：</strong><br>${q.comment.replace(/[()]/g,'').replace('鹹魚主廚的祕方：','')}`; } }
        function saveCardImage(e) { e.stopPropagation(); showToast('📸 截圖中...'); const temp=document.createElement('div'); temp.style.position='fixed'; temp.style.top='0'; temp.style.zIndex='-9'; temp.style.width='350px'; temp.innerHTML=`<div style="background:#FDFBF7;border:2px solid #7CA1B3;border-radius:24px;padding:40px 30px;text-align:center;font-family:'Noto Sans TC';"><p style="font-family:'Noto Serif TC';font-size:1.4rem;color:#5A524C;margin-bottom:20px;">${document.getElementById('quote-content').innerText}</p><p style="color:#9E9791;margin-bottom:30px;">—— ${document.getElementById('quote-source').innerText}</p><div style="width: 40%; height: 1px; border-top: 1px dashed #D6D0C8; margin: 30px auto;"></div><div style="color:#7CA1B3;font-style:italic;padding-top:15px;">${document.getElementById('quote-comment').innerHTML}</div><div style="margin-top:30px;font-size:0.75rem;color:#D4B483;">機智的鹹魚生活</div></div>`; document.body.appendChild(temp); html2canvas(temp.firstChild,{scale:2,backgroundColor:null}).then(c=>{const a=document.createElement('a');a.download=`salted-fish-${Date.now()}.png`;a.href=c.toDataURL();a.click();document.body.removeChild(temp);showToast('✅ 下載完成');}); }
        function showSection(id, btn) { 
            if (id !== 'flip') {
                const flipper = document.querySelector('.flip-container');
                if (flipper) flipper.classList.remove('flipped');
            }

            // --- 重置 首頁 (Preservative) ---
            if (id !== 'home') {
                 const preservativeDisplay = document.getElementById('preservative-display');
                 if (preservativeDisplay) {
                     preservativeDisplay.style.opacity = 0;
                     setTimeout(() => { if(preservativeDisplay) preservativeDisplay.innerText = ''; }, 500);
                 }
            }

            // --- 重置 聰明鹹魚 (PUA) ---
            if (id !== 'pua') {
                currentPuaSelection = null;
                document.querySelectorAll('.pua-tag').forEach(t => t.classList.remove('selected'));
                const puaRes = document.getElementById('pua-result');
                if (puaRes) puaRes.style.opacity = 0;
                
                const testArea = document.getElementById('pua-test-area');
                if (testArea) testArea.style.display = 'none';
                const testRes = document.getElementById('test-result');
                if (testRes) testRes.style.display = 'none';
            }

            // --- 重置 游刃有魚 (Shield) ---
            if (id !== 'shield') {
                currentShieldSelection = null;
                document.querySelectorAll('.shield-tag').forEach(t => t.classList.remove('selected'));
                const shieldRes = document.getElementById('shield-result');
                if (shieldRes) shieldRes.style.opacity = 0;
            }

            document.querySelectorAll('.section').forEach(s=>s.classList.remove('active')); 
            
            const targetSection = document.getElementById(id);
            if(targetSection) targetSection.classList.add('active'); 
            
            if(btn){
                document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active')); 
                btn.classList.add('active');
            }
            
            const body = document.body;
            const main = document.getElementById('app-main');
            if (id === 'devotion') {
                body.classList.add('devotion-mode');
                main.classList.remove('container-limited');
                main.classList.add('container-full');
                initJournalDate();
            } else {
                body.classList.remove('devotion-mode');
                main.classList.add('container-limited');
                main.classList.remove('container-full');
                document.getElementById('scroll-wrapper').scrollTo(0,0);
            }
        }

        // --- NEW JOURNAL UI LOGIC ---
        const journalEls = {};

        function initJournalDate() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const picker = document.getElementById('journal-date-picker');
            if (picker) {
                if (!picker.value) picker.value = `${yyyy}-${mm}-${dd}`;
                handleJournalDateChange(`${mm}-${dd}`);
            }
        }

        function handleJournalDateChange(dateKey) {
            renderPlanButtons(dateKey);
            
            ['note-scripture', 'note-reflection', 'note-prayer'].forEach(id => {
                const saved = localStorage.getItem(`${dateKey}-${id}`);
                const el = document.getElementById(id);
                if(el) el.value = saved || "";
            });

            const savedMood = localStorage.getItem(`${dateKey}-note-mood`);
            const moodBtns = document.querySelectorAll('.mood-btn');
            moodBtns.forEach(b => b.classList.remove('active'));
            if(savedMood) {
                const targetBtn = Array.from(moodBtns).find(b => b.dataset.mood === savedMood);
                if(targetBtn) targetBtn.classList.add('active');
            }
        }

        function renderPlanButtons(dateKey) {
            const planList = document.getElementById('plan-list');
            const mobilePlanList = document.getElementById('mobile-plan-list');
            if (!planList || !mobilePlanList) return;

            planList.innerHTML = "";
            mobilePlanList.innerHTML = "";
            
            const todayPlan = biblePlan.find(p => p.dateStr === dateKey) || biblePlan[0];
            const details = todayPlan.details || [];

            const createBtn = (item) => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left px-8 py-12 rounded-xl border border-[#D6D0C8] bg-white hover:border-[#A68C76] hover:bg-[#FAF9F6] transition-all group flex flex-col gap-6 shadow-sm hover:shadow-md min-h-[140px]";
                btn.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="text-[10px] font-bold text-[#B0AAA3] uppercase group-hover:text-[#A68C76] transition-colors tracking-widest">${item.type}</span>
                        <div class="w-2 h-2 rounded-full bg-[#EBE6DE] group-hover:bg-[#A68C76] transition-colors"></div>
                    </div>
                    <span class="text-base font-serif text-[#5E5A54] group-hover:text-[#3E3A34] tracking-wide">${item.abbr}</span>
                `;
                
                if (item.isNote) {
                    btn.onclick = () => showNotes();
                } else {
                    btn.onclick = () => showReader(item);
                }
                
                return btn;
            };

            const createMobileBtn = (item) => {
                const btn = document.createElement('button');
                btn.className = "flex-shrink-0 px-3 py-4 border border-[#D6D0C8] rounded-xl bg-white text-xs hover:bg-[#F2EBE5] hover:border-[#A68C76] transition-colors flex flex-col items-center justify-center gap-1 min-w-[70px] shadow-sm";
                btn.innerHTML = `<span class="text-[10px] text-[#B0AAA3] tracking-widest scale-90 origin-bottom">${item.type}</span><span class="font-serif text-[#5E5A54] text-sm">${item.abbr}</span>`;
                
                if (item.isNote) {
                    btn.onclick = () => showNotes();
                } else {
                    btn.onclick = () => showReader(item);
                }
                
                return btn;
            };

            details.forEach(item => {
                 if(item.isNote) return; 
                 planList.appendChild(createBtn(item));
                 mobilePlanList.appendChild(createMobileBtn(item));
            });

            const noteItem = { type: '筆記', abbr: '醃漬筆記', isNote: true };
            planList.appendChild(createBtn(noteItem));
            mobilePlanList.appendChild(createMobileBtn(noteItem));
        }
        
        function showReader(item) {
            document.getElementById('view-reader').classList.remove('hidden');
            document.getElementById('view-note').classList.add('hidden');
            fetchBible(item);
        }
        
        function showNotes() {
            document.getElementById('view-reader').classList.add('hidden');
            document.getElementById('view-note').classList.remove('hidden');
        }

        async function fetchBible(item) {
            const content = document.getElementById('bible-content');
            const title = document.getElementById('bible-title');
            const tag = document.getElementById('bible-book-tag');
            const copyBtn = document.getElementById('copy-btn');
            
            content.innerHTML = '<div class="h-full flex flex-col items-center justify-center gap-4"><span class="loader"></span><span class="text-xs text-[#94908A] tracking-widest animate-pulse font-serif">讀取中...</span></div>';
            title.innerText = "讀取中...";
            copyBtn.classList.add('hidden');
            
            selectedVerses.clear();

            let startChap = item.chapter;
            let endChap = item.chapter;
            
            const parts = item.text.split(' '); 
            if (parts.length > 1) {
                const range = parts[parts.length - 1]; 
                if (range.includes('-')) {
                    endChap = parseInt(range.split('-')[1]);
                }
            }

            let allVerses = [];
            try {
                const promises = [];
                for (let c = startChap; c <= endChap; c++) {
                    promises.push(fetch(`https://bolls.life/get-text/CUNP/${item.bookCode}/${c}/`).then(r => r.json()));
                }
                
                const results = await Promise.all(promises);
                results.forEach((chapVerses, idx) => {
                    const currentChap = startChap + idx;
                    chapVerses.forEach(v => {
                        v.chapter = currentChap;
                        v.text = stripHtml(v.text);
                    });
                    allVerses = allVerses.concat(chapVerses);
                });

                renderScriptureBolls(allVerses, item.text);
            } catch (err) {
                renderDemoScripture(item.text, "讀取失敗", "無法取得經文內容");
            }
        }

        function renderScriptureBolls(records, title) {
            const content = document.getElementById('bible-content');
            const titleEl = document.getElementById('bible-title');
            const tag = document.getElementById('bible-book-tag');
            const copyBtn = document.getElementById('copy-btn');

            titleEl.innerText = title;
            tag.innerText = "SCRIPTURE";
            
            let html = "";
            let textBuffer = `【${title}】\n`;

            records.forEach((v) => {
                let text = v.text;
                let label = `${v.verse}`;
                const labelClass = "w-8 text-center";

                html += `
                    <div class="verse-row mb-2 hover:bg-[#F9F7F5] -mx-4 px-4 py-3 rounded-lg transition-colors cursor-pointer group flex gap-3 items-start" 
                         data-text="${text}" data-label="${label}"
                         onclick="toggleVerse(this)">
                        <span class="text-[10px] text-[#D6D0C8] font-mono pt-2 shrink-0 group-hover:text-[#A68C76] transition-colors ${labelClass}">${label}</span>
                        <span class="text-[#5E5A54] leading-loose group-hover:text-[#3E3A34] text-justify flex-1">${text}</span>
                    </div>
                `;
                textBuffer += `${label} ${text}\n`;
            });

            content.innerHTML = `<div class="max-w-3xl mx-auto">${html}</div>`;
            currentFullText = textBuffer; 
            copyBtn.classList.remove('hidden');
            
            // Fix: Reset scroll position to top
            content.scrollTop = 0;
            // Fix: Ensure content aligns to top, not center
            content.classList.remove('justify-center');
        }

        function toggleVerse(el) {
            el.classList.toggle('selected-verse');
            const text = el.getAttribute('data-text');
            const label = el.getAttribute('data-label');
            const verseData = `${label} ${text}`;
            
            if (selectedVerses.has(verseData)) {
                selectedVerses.delete(verseData);
            } else {
                selectedVerses.add(verseData);
            }
        }

        function renderDemoScripture(title, msg = "無法連線至資料庫", subMsg = "請檢查網路或稍後再試", extraHtml = "") {
            const content = document.getElementById('bible-content');
            const titleEl = document.getElementById('bible-title');
            const tag = document.getElementById('bible-book-tag');
            const copyBtn = document.getElementById('copy-btn');

            titleEl.innerText = title;
            tag.innerText = "MESSAGE"; 
            content.innerHTML = `<div class="h-full flex items-center justify-center text-[#94908A] font-serif flex-col gap-2 p-4 text-center">
                <span class="text-lg font-medium text-[#5E5A54]">${msg}</span>
                <span class="text-xs opacity-60">${subMsg}</span>
                ${extraHtml}
            </div>`;
            copyBtn.classList.add('hidden');
        }

        function saveNote(dateKey, id, content) {
            localStorage.setItem(`${dateKey}-${id}`, content);
            const status = document.getElementById('save-status');
            status.style.opacity = '1';
            setTimeout(() => { status.style.opacity = '0'; }, 2000);
        }

        // --- PUA & Shield Logic ---
        function renderPuaTags() { 
            const c = document.getElementById('pua-tag-container'); if(!c) return; c.innerHTML = ''; currentPuaSelection = null; document.getElementById('pua-result').style.opacity = 0;
            let src = Object.keys(puaData).map(k=>({key:k, ...puaData[k]}));
            src.sort(()=>0.5-Math.random()).slice(0,7).forEach(i => {
                const b = document.createElement('button');
                b.className='pua-tag';
                b.innerText=i.sentence;
                b.onclick=()=>{
                    document.querySelectorAll('.pua-tag').forEach(t=>t.classList.remove('selected'));
                    b.classList.add('selected');
                    currentPuaSelection = i;
                };
                c.appendChild(b);
            });
        }
        function detectPUA() {
            if(!currentPuaSelection) { showToast("請先選擇標籤"); return; }
            const box = document.getElementById('pua-result'), badge = document.getElementById('pua-level');
            box.style.opacity = 0;
            setTimeout(() => {
                document.getElementById('pua-translation').innerText = currentPuaSelection.trans;
                if (currentPuaSelection.defenses && currentPuaSelection.defenses.length > 0) {
                    document.getElementById('pua-defense').innerText = currentPuaSelection.defenses[Math.floor(Math.random()*currentPuaSelection.defenses.length)];
                } else {
                    document.getElementById('pua-defense').innerText = "(保持微笑)";
                }
                badge.style.display = currentPuaSelection.level ? 'inline-block' : 'none'; badge.innerText = `毒性: ${currentPuaSelection.level}`;
                box.style.opacity = 1;
            }, 200);
        }
        function togglePuaTest() { const a = document.getElementById('pua-test-area'); a.style.display = a.style.display === 'block' ? 'none' : 'block'; if(a.style.display==='block') initPuaTest(); }
        function initPuaTest() {
            const l = document.getElementById('test-list');
            l.innerHTML='';
            const source = onlinePuaChecklist.length > 0 ? onlinePuaChecklist : puaTestItems;
            [...source].sort(()=>0.5-Math.random()).slice(0,7).forEach((t)=>{
                const d=document.createElement('div');
                d.style.marginBottom='10px';
                d.style.cursor='pointer';
                d.innerHTML=`<input type="checkbox" data-weight="${t.weight}"> <span>${t.text}</span>`;
                d.onclick=(e)=>{if(e.target.tagName!=='INPUT') {const c=d.querySelector('input'); c.checked=!c.checked;}};
                l.appendChild(d);
            });
        }
        function runPuaTest() {
            const inputs = document.querySelectorAll('#test-list input:checked');
            let totalScore = 0;
            inputs.forEach(input => { totalScore += parseInt(input.getAttribute('data-weight')) || 0; });
            
            const r = document.getElementById('test-result');
            r.style.display='block';
            
            let diagnosis = "";
            let prescription = "";
            
            if (totalScore === 0) {
                diagnosis = "健康寶寶";
                prescription = "恭喜你！擁有屬靈抗體，請繼續保持這份清醒。";
            } else if (totalScore <= 3) {
                diagnosis = "輕微擦傷";
                prescription = "多看看鹹魚語錄，增強免疫力。";
            } else if (totalScore <= 7) {
                diagnosis = "中度感染";
                prescription = "建議暫停聚會一週，去海邊走走，聽聽海浪的聲音（那是上帝的白噪音）。";
            } else if (totalScore <= 11) {
                diagnosis = "重度中毒";
                prescription = "你需要特效藥：閱讀加拉太書，並大聲朗讀『為了自由，基督釋放了我們』。";
            } else {
                diagnosis = "危急存亡";
                prescription = "快逃！這不是教會，是精神時光屋。請尋求專業諮商或正常人類的協助。";
            }
            
            r.innerHTML = `<strong style="color:var(--accent-purple)">診斷：${diagnosis} (毒性分數: ${totalScore})</strong><br><br><span style="font-size:0.9rem; color:#666">💊 鹹魚藥方：<br>${prescription}</span>`;
        }
        function renderShieldTags() {
            const c = document.getElementById('shield-tag-container'); if(!c) return; c.innerHTML=''; currentShieldSelection=null; document.getElementById('shield-result').style.opacity=0; document.getElementById('shield-text').innerText='';
            let src = onlineShieldData.length ? [...onlineShieldData] : Object.keys(shields).map(k=>({label:k==='marriage'?'什麼時候結婚?':k==='salary'?'薪水多少?':'沒來服事?', options:shields[k]}));
            src.sort(()=>0.5-Math.random()).slice(0,7).forEach(i => { const b = document.createElement('button'); b.className='shield-tag'; b.innerText=i.label; b.onclick=()=>{ document.querySelectorAll('.shield-tag').forEach(t=>t.classList.remove('selected')); b.classList.add('selected'); currentShieldSelection=i; }; c.appendChild(b); });
        }
        function getExcuse() { if(!currentShieldSelection) { showToast("請選擇情境"); return; } const opts = currentShieldSelection.options; document.getElementById('shield-result').style.opacity=0; setTimeout(()=>{ document.getElementById('shield-text').innerText=`「${opts[Math.floor(Math.random()*opts.length)]}」`; document.getElementById('shield-result').style.opacity=1; },100); }
        
        function switchFlowTab(t) { 
            document.querySelectorAll('#flow .sub-section').forEach(e=>e.classList.remove('active')); 
            document.getElementById(`tab-${t}`).classList.add('active'); 
            document.querySelectorAll('#flow .tab-btn').forEach(b=>b.classList.remove('active')); 
            event.target.classList.add('active'); 
        }
        function renderSavingsGrid() { const grid = document.getElementById('savings-grid'); if(!grid) return; grid.innerHTML = ''; let total = 0; for (let i=1; i<=365; i++) { const s = savingsPlan[i]; if(s) total+=i; const d = document.createElement('div'); let classes = "aspect-square rounded-lg flex items-center justify-center text-sm cursor-pointer transition-all duration-200 border"; if (s) { classes += " bg-[#8DA399] border-[#8DA399] text-white font-bold shadow-md transform scale-105"; } else { classes += " bg-white border-[#EBE6DE] text-[#9E9791] hover:border-[#8DA399] hover:text-[#8DA399]"; } d.className = classes; d.innerText = i; d.onclick = () => confirmSave(i); grid.appendChild(d); } const summary = document.getElementById('savings-total'); if(summary) { summary.innerHTML = `<div class="flex flex-col items-start"><span class="text-xs text-[#9E9791] tracking-widest uppercase">Total Savings</span><span class="text-2xl font-serif text-[#5E5A54] font-bold">$${total.toLocaleString()}</span></div><div class="flex flex-col items-end"><span class="text-xs text-[#9E9791]">進度 ${Math.round(savingsPlan.filter(Boolean).length/365*100)}%</span><span class="text-xs text-[#9E9791]">目標 $66,795</span></div>`; } }
        function confirmSave(i) { const saved = savingsPlan[i]; showConfirm(saved?`取消存入 $${i}?`:`存入 $${i}?`, ()=>{ savingsPlan[i]=!saved; saveToStorage('savingsPlan', JSON.stringify(savingsPlan)); renderSavingsGrid(); if(!saved) showToast(`💰 存入 $${i}！`); }); }
        function randomSave() { let available = []; for (let i = 1; i <= 365; i++) { if (!savingsPlan[i]) available.push(i); } if (available.length === 0) { showToast('🎉 恭喜！你已經存滿了所有金額！'); return; } const randomIndex = Math.floor(Math.random() * available.length); const amountToSave = available[randomIndex]; savingsPlan[amountToSave] = true; saveToStorage('savingsPlan', JSON.stringify(savingsPlan)); renderSavingsGrid(); showToast(`🎲 命運幫你存了 $${amountToSave} ！`); }
        function renderWishlist() { const list = document.getElementById('wish-list'); if(!list) return; list.innerHTML = ''; if(wishlist.length===0) { list.innerHTML='<div class="flex flex-col items-center justify-center py-10 text-[#D6D0C8] gap-3"><span class="text-4xl opacity-50">✨</span><span class="text-sm font-serif italic">寫下你的願望，交託給神...</span></div>'; return; } wishlist.slice().reverse().forEach(w => { const d = document.createElement('div'); d.className = `p-4 rounded-xl border mb-3 transition-all flex items-center justify-between group ${w.fulfilled ? 'bg-[#F9F7F5] border-transparent opacity-60' : 'bg-white border-[#EBE6DE] hover:border-[#C8A8A4]'}`; d.innerHTML = `<div class="flex-1 min-w-0 pr-4"><div class="text-[#5E5A54] font-medium truncate ${w.fulfilled ? 'line-through text-[#9E9791]' : ''}">${w.content}</div><div class="text-xs text-[#A68C76] font-mono mt-1">$${w.cost ? parseInt(w.cost).toLocaleString() : '--'}</div></div><div class="flex gap-2 shrink-0 opacity-100 md:opacity-0 group-hover:opacity-100 transition-opacity"><button class="p-2 rounded-full hover:bg-[#F2EBE5] text-[#8DA399] transition-colors" onclick="toggleWishStatus(${w.id})">${w.fulfilled ? '↩️' : '🎁'}</button><button class="p-2 rounded-full hover:bg-[#F2EBE5] text-[#C8A8A4] hover:text-red-400 transition-colors" onclick="deleteWish(${w.id})">🗑️</button></div>`; list.appendChild(d); }); }
        function addWish() { const i1 = document.getElementById('new-wish-input'), i2 = document.getElementById('new-wish-cost'); if(!i1.value.trim()) return; wishlist.push({id:Date.now(), content:i1.value.trim(), cost:i2.value, fulfilled:false}); saveToStorage('wishlist', JSON.stringify(wishlist)); i1.value=''; i2.value=''; renderWishlist(); }
        function toggleWishStatus(id) { const w = wishlist.find(i=>i.id===id); if(w) { w.fulfilled=!w.fulfilled; saveToStorage('wishlist', JSON.stringify(wishlist)); renderWishlist(); } }
        function deleteWish(id) { showConfirm("刪除願望？", ()=>{ wishlist = wishlist.filter(i=>i.id!==id); saveToStorage('wishlist', JSON.stringify(wishlist)); renderWishlist(); }); }
        function refreshFinancialEncouragement() { const el = document.getElementById('financial-encouragement'); if(el) el.innerText = financialEncouragements[Math.floor(Math.random() * financialEncouragements.length)]; }
        async function shareNote() {
            const date = document.getElementById('journal-date-picker').value;
            const mood = document.getElementById('note-mood').value || "";
            const s = document.getElementById('note-scripture').value || "(無)";
            const r = document.getElementById('note-reflection').value || "(無)";
            const p = document.getElementById('note-prayer').value || "(無)";
            const title = `靈修日誌 ${date} ${mood}`;
            const text = `${title}\n\n📖 感動經文：\n${s}\n\n💡 領受：\n${r}\n\n🙏 禱告：\n${p}`;
            if (navigator.share) {
                try { await navigator.share({ title: title, text: text }); } catch (err) { console.log('分享取消'); }
            } else {
                copyText(text, "已複製日誌內容！");
            }
        }
        function downloadNote() {
            const date = document.getElementById('journal-date-picker').value;
            const mood = document.getElementById('note-mood').value || "";
            const s = document.getElementById('note-scripture').value;
            const r = document.getElementById('note-reflection').value;
            const p = document.getElementById('note-prayer').value;
            const content = `靈修日誌 ${date} ${mood}\n\n【感動經文】\n${s}\n\n【領受】\n${r}\n\n【禱告】\n${p}`;
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `devotion-${date}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }
        function exportData() {
            const data = { 
                biblePlan_2026: localStorage.getItem('biblePlan_2026'), 
                prayers: localStorage.getItem('prayers'), 
                goals: localStorage.getItem('goals'), 
                userSignals: localStorage.getItem('userSignals'), 
                yearlyKeyword: localStorage.getItem('yearlyKeyword'), 
                savingsPlan: localStorage.getItem('savingsPlan'), 
                wishlist: localStorage.getItem('wishlist') 
            };
            const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `salted-fish-backup-${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
        }
        function importData(input) {
            const file = input.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.biblePlan_2026) saveToStorage('biblePlan_2026', data.biblePlan_2026);
                    if (data.prayers) saveToStorage('prayers', data.prayers);
                    if (data.goals) saveToStorage('goals', data.goals);
                    if (data.userSignals) saveToStorage('userSignals', data.userSignals);
                    if (data.yearlyKeyword) saveToStorage('yearlyKeyword', data.yearlyKeyword);
                    if (data.savingsPlan) saveToStorage('savingsPlan', data.savingsPlan);
                    if (data.wishlist) saveToStorage('wishlist', data.wishlist);
                    showToast('匯入成功！頁面將重新整理。'); setTimeout(() => location.reload(), 1500);
                } catch (err) { showToast('匯入失敗，檔案格式可能錯誤。'); }
            };
            reader.readAsText(file);
        }
        let pendingConfirmAction = null;
        function showConfirm(msg, action) { document.getElementById('confirm-msg').innerText = msg; pendingConfirmAction = action; document.getElementById('confirm-modal').classList.add('show'); }
        function closeConfirmModal() { document.getElementById('confirm-modal').classList.remove('show'); pendingConfirmAction = null; }
        document.getElementById('confirm-btn-action').onclick = function() { if (pendingConfirmAction) pendingConfirmAction(); closeConfirmModal(); };

        function showHelpModal() { document.getElementById('help-modal').classList.add('show'); }
        function closeHelpModal() { document.getElementById('help-modal').classList.remove('show'); }

        function updateHomeStatus() {
            const now = new Date();
            const todayStr = `${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
            let todayPlan = biblePlan.find(d => d.dateStr === todayStr);
            if (!todayPlan && biblePlan.length > 0) todayPlan = biblePlan[0];
            const scopeText = document.getElementById('plan-scope-text');
            if(scopeText) {
                if (todayPlan) {
                    const extra = todayPlan.extraMark ? ` ${todayPlan.extraMark}` : '';
                    scopeText.innerText = (todayPlan.reading || "今日暫無進度") + extra;
                } else { scopeText.innerText = "今日休息"; }
            }
            const dateText = document.getElementById('current-date-text');
            if(dateText) dateText.innerText = `${now.getMonth() + 1}/${now.getDate()}`;
            let completedCount = biblePlan.filter(d => d.completed).length;
            const percent = ((completedCount / 365) * 100).toFixed(1);
            const progressBar = document.getElementById('bible-progress'); 
            if(progressBar) progressBar.style.width = `${percent}%`;
            const percentText = document.getElementById('percent-text');
            if(percentText) percentText.innerText = `${percent}% 入味`;
            const saltStars = document.getElementById('today-salt-stars');
            if (saltStars && todayPlan) {
                const count = todayPlan.details ? todayPlan.details.length : 0;
                saltStars.innerText = count >= 4 ? '⭐⭐⭐⭐⭐' : count >= 2 ? '⭐⭐⭐' : '⭐';
            }
        }

        function handleCheckIn(dateKey) {
            const planIndex = biblePlan.findIndex(p => p.dateStr === dateKey);
            if (planIndex !== -1) {
                const isCompleted = biblePlan[planIndex].completed;
                if (!isCompleted) {
                    biblePlan[planIndex].completed = true;
                    saveToStorage('biblePlan_2026', JSON.stringify(biblePlan));
                    showToast('🎉 今日讀經打卡成功！');
                    updateHomeStatus();
                } else { showToast('已經打過卡囉！'); }
            }
        }
        
        function fallbackCopyTextToClipboard(text, successMsg) {
            var textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            textArea.style.top = "0";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                var successful = document.execCommand('copy');
                if(successful) showToast(successMsg);
                else showToast("複製失敗，請手動複製");
            } catch (err) { showToast("複製失敗"); }
            document.body.removeChild(textArea);
        }

        function copyText(text, successMsg = "已複製") {
             if (navigator.clipboard && navigator.clipboard.writeText) {
                 navigator.clipboard.writeText(text)
                     .then(() => showToast(successMsg))
                     .catch(err => { fallbackCopyTextToClipboard(text, successMsg); });
             } else { fallbackCopyTextToClipboard(text, successMsg); }
        }

        function initData() {
            const DB_KEY = 'biblePlan_2026';
            const savedBible = localStorage.getItem(DB_KEY);
            let needRegen = !savedBible;
            if (needRegen) {
                const oldData = localStorage.getItem('biblePlan');
                if (oldData) {
                    try {
                        const oldParsed = JSON.parse(oldData);
                        biblePlan = generateBiblePlan();
                        if (oldParsed.length === biblePlan.length) {
                            oldParsed.forEach((d, i) => { if (d.completed) biblePlan[i].completed = true; });
                        }
                        saveToStorage(DB_KEY, JSON.stringify(biblePlan));
                        needRegen = false;
                    } catch(e) { needRegen = true; }
                }
            }
            if (!needRegen) {
                try {
                    biblePlan = JSON.parse(savedBible);
                    if (!biblePlan || biblePlan.length === 0 || !biblePlan[0].dateStr.includes('-')) { needRegen = true; }
                    if (biblePlan[0].reading && biblePlan[0].reading.includes('undefined')) { needRegen = true; }
                } catch(e) { needRegen = true; }
            }
            if (needRegen) { biblePlan = generateBiblePlan(); saveToStorage(DB_KEY, JSON.stringify(biblePlan)); }
            try { prayers = JSON.parse(localStorage.getItem('prayers')||'[]'); } catch(e){}
            try { goals = JSON.parse(localStorage.getItem('goals')||'[]'); } catch(e){}
            try { userSignals = JSON.parse(localStorage.getItem('userSignals')||'[]'); } catch(e){}
            try { savingsPlan = JSON.parse(localStorage.getItem('savingsPlan')||JSON.stringify(new Array(366).fill(false))); } catch(e){}
            try { wishlist = JSON.parse(localStorage.getItem('wishlist')||'[]'); } catch(e){}
            yearlyKeyword = localStorage.getItem('yearlyKeyword')||'';
            refreshDailyWord();
            refreshFinancialEncouragement();
        }

        window.onload = function() {
            generateAppIcons();
            initData();
            loadOnlineQuotes(); loadPreservativePool(); loadFlipQuotes(); loadShieldData(); loadPuaChecklist();
            loadPuaData(); 
            renderPuaTags(); 
            loadSaltStatusMap().then(()=>setRandomStatus());
            const picker = document.getElementById('journal-date-picker');
            if (picker) { picker.addEventListener('change', (e) => handleJournalDateChange(e.target.value.substring(5))); }
            const checkInBtn = document.getElementById('journal-checkin-btn');
            if (checkInBtn) { checkInBtn.addEventListener('click', () => { const dateKey = picker.value.substring(5); handleCheckIn(dateKey); }); }
            const copyBtn = document.getElementById('copy-btn');
            if(copyBtn) {
                copyBtn.addEventListener('click', () => {
                    let textToCopy = "";
                    if (selectedVerses.size > 0) {
                        const verses = document.querySelectorAll('.verse-row.selected-verse');
                        let buffer = "";
                        verses.forEach(v => {
                             const t = v.getAttribute('data-text');
                             const l = v.getAttribute('data-label');
                             buffer += `${l} ${t}\n`;
                        });
                        textToCopy = buffer;
                    } else { textToCopy = currentFullText; }
                    if(textToCopy) {
                        copyText(textToCopy, selectedVerses.size > 0 ? "已複製選取經文" : "已複製整章經文");
                        selectedVerses.clear();
                        document.querySelectorAll('.verse-row.selected-verse').forEach(el => el.classList.remove('selected-verse'));
                    } else { showToast("沒有內容可複製"); }
                });
            }
            ['note-scripture', 'note-reflection', 'note-prayer'].forEach(id => {
                const el = document.getElementById(id);
                if(el) { el.addEventListener('input', () => { const dateKey = picker.value.substring(5); saveNote(dateKey, id, el.value); }); }
            });
            document.querySelectorAll('.mood-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    const mood = btn.dataset.mood;
                    const dateKey = picker.value.substring(5);
                    saveNote(dateKey, 'note-mood', mood);
                });
            });
            updateHomeStatus();
            renderSavingsGrid();
            renderWishlist();
        };
    </script>
</body>
</html>
